---
title: "CYTOF_Wagner_analysis"
author: "Lasse Meyer"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Analysis of CyTOF breast cancer dataset (Wagner et al., 2019)

SCE already subsetted for epithelial cells 

```{r}
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/03_data/Wagner_sce.rds")

# Processing
rownames(sce) <- str_split(rowData(sce)$marker_name,"_", simplify = TRUE)[,2]
colnames(sce) <- sce$cell_id <- paste0(sce$BB_number,"_",seq_along(sce$BB_number))
```

## 1. CK5/7 Signature 

```{r}
## 5. CK5-7 signature
# 1. CK5
GMM_CK5 <- Mclust(assay(sce, "exprs")["K5",], G = 2)

GMM_df <- data.frame(class_epi = ifelse(GMM_CK5$classification == 2, 
                                        "CK5+",
                                        "CK5-"), 
                     KRT5_exprs = assay(sce, "exprs")["K5",],
                     uncertainty = GMM_CK5$uncertainty)

#Visualize GMM
ggplot(GMM_df, aes(x = KRT5_exprs, fill = class_epi))+
  geom_density()+
  theme_classic(base_size = 15)+
  theme(axis.title.x = element_blank())+
  scale_fill_brewer(palette = "Set1")
  
#Add GMM epi class to SCE
sce$GMM_tumor_CK5 <- GMM_df$class_epi

# 2. CK7
GMM_CK7 <- Mclust(assay(sce, "exprs")["K7",], G = 2)

GMM_df <- data.frame(class_epi = ifelse(GMM_CK7$classification == 2, 
                                        "CK7+",
                                        "CK7-"), 
                     KRT7_exprs = assay(sce, "exprs")["K7",],
                     uncertainty = GMM_CK7$uncertainty)

#Visualize GMM
ggplot(GMM_df, aes(x = KRT7_exprs, fill = class_epi))+
  geom_density()+
  theme_classic(base_size = 15)+
  theme(axis.title.x = element_blank())+
  scale_fill_brewer(palette = "Set1")
  
#Add GMM epi class to SCE
sce$GMM_tumor_CK7 <- GMM_df$class_epi

## Combine CK5/7 GMM scores 
sce$CK5_7_score <- ifelse(sce$GMM_tumor_CK5 == "CK5+" & sce$GMM_tumor_CK7 == "CK7+", "CK5/7+", 
       ifelse(sce$GMM_tumor_CK5 == "CK5+" & sce$GMM_tumor_CK7 == "CK7-", "CK5+",
              ifelse(sce$GMM_tumor_CK5 == "CK5-" & sce$GMM_tumor_CK7 == "CK7+", "CK7+","CK5/7-")))

## Visualize 
cur_dat <- t(assay(sce,"exprs")) %>% as.matrix %>% as.data.frame %>% dplyr::select("K5","K7")

cur_dat$CK5_7_score <- sce$CK5_7_score[match(rownames(cur_dat), sce$cell_id)]

ggplot(cur_dat, aes(x=K7, y=K5,color = CK5_7_score)) +
  geom_point(alpha = 0.5)+
  #stat_density_2d(aes(fill = ..level..), geom="polygon", contour_var = "density", bins = 15)+
  theme_classic()+
  xlab("CK7 exprs")+
  ylab("CK5 exprs")


colData(sce) %>% as.data.frame %>% group_by(CK5_7_score) %>% count() %>% ungroup() %>% mutate(fra = n/sum(n))

plot_score_BB_number <- colData(sce) %>% as.data.frame %>% group_by(BB_number,CK5_7_score) %>% count() %>% group_by(BB_number) %>% mutate(fra = n/sum(n))

ggplot(plot_score_BB_number, aes(x=BB_number, y=fra, fill = CK5_7_score))+
  geom_tile(position = "fill")

plot_heat_BB_number <- plot_score_BB_number %>% pivot_wider(id_cols = BB_number, values_from = fra, names_from = CK5_7_score) %>% column_to_rownames("BB_number")
plot_heat_BB_number[is.na(plot_heat_BB_number)] <- 0

h <- Heatmap(plot_heat_BB_number,
             name = "Proportion",
             col = viridis(100), 
             row_split = 4, 
             show_row_names = FALSE)

h <- draw(h)
```


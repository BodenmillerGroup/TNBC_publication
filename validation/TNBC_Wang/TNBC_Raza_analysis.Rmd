---
title: "TNBC_Raza_analysis"
author: "Lasse Meyer"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Software requirements

```{r lib, message=FALSE,warning=FALSE}
#Data containers
library(SpatialExperiment)
library(SingleCellExperiment)

#Data processing
library(scuttle)
library(scater)
library(scran)
library(imcRtools)

#Data visualization
library(cytomapper)
library(dittoSeq)
library(pheatmap)
library(cowplot)
library(ComplexHeatmap)
library(circlize)

#Utilities
library(tidyverse)
library(openxlsx)
library(stringr)
library(patchwork)
library(parallel)
library(BiocParallel)
library(BiocNeighbors)
library(BiocSingular)
library(tiff)
library(ggrepel)
library(EBImage)
library(viridis)
library(mclust)
library(Rphenograph)
library(igraph)
library(RColorBrewer)
library(foreach)
library(clValid)
library(bluster)
library(psych)
library(corrplot)
library(psych)

#Batch correction
library(batchelor)
```

# TNBC data analysis - Raza 

## Read in data and construct SingleCellExperiment object 

```{r}
cells <- read_csv("/mnt/central_nas/tnbc_volume/TNBC_validation/TNBC_Raza/NTPublic/data/derived/cells.csv")
clinical <- read_csv("/mnt/central_nas/tnbc_volume/TNBC_validation/TNBC_Raza/NTPublic/data/derived/clinical.csv") 
ID <- read_csv("/mnt/central_nas/tnbc_volume/TNBC_validation/TNBC_Raza/NTPublic/data/derived/IDs.csv") 
neighbors <- read_csv("/mnt/central_nas/tnbc_volume/TNBC_validation/TNBC_Raza/NTPublic/data/derived/neighbours.csv") 
```

```{r}
# Create assay and colData based on cells
assay <- cells[,15:ncol(cells)] # assay

meta <- cells[,1:14] #colData
meta$cell_id <- paste0(meta$ImageID,"_",meta$ObjectNumber)

## Format assay
rownames(assay) <- meta$cell_id
colnames(assay) <- c("H3", "CD163", "CD20", "PDL1_SP", "CD56", "Helios", "CD8", 
"OX40", "CD11c", "CD3", "GATA3", "SMA", "TOX", "Tbet", "PD1", 
"IDO", "AR", "FOXP3", "PDL1_73", "ICOS", "Ki67", "CD4", 
"CK5_14", "TCF1", "PDGFRB", "CD31", "GZMB", "PDPN", "HLA_ABC", 
"cPARP", "panCK", "CD79a", "DNA1", "CK8_18", "DNA2", "Carboplatin", 
"Vimentin", "Calponin", "Caveolin_1", "CD15", "MPO", "HLA_DR", 
"CD68", "pH2AX", "CD45", "CA9")
assay <- assay * 65535 #CellProfiler specific scaling factor


## Format colData 
rownames(meta) <- meta$cell_id
all.equal(rownames(meta), rownames(assay))

celltype_anno <- data.frame(celltype_raza = unique(meta$Label))
celltype_anno$category <- cells$isEpithelial[match(celltype_anno$celltype_raza, cells$Label)]
celltype_anno$celltype_fine <- c("Fibroblasts", "DCs", "CA9_pos", "PDPN_Stromal", "M2_Mac", "Myofibroblasts", 
"CD79a_Plasma", "CK8_18_med", "CD56_NK", "CD4_TCF1_T", 
"panCK_med", "Treg", "CD8_T", "CD8_TCF1_T", "CD8_PD1_Ex_T", 
"Endothelial", "CD4_PD1_T", "CD8_GZMB_T", "PDL1_APC", 
"CD15", "PD-L1_GZMB", "pH2AX_DSB", "Vimentin_EMT", 
"CKhi_GATA3", "CKlo_GATA3", "Helios", "Basal", 
"Apoptosis", "Neutrophils", "B_cell", "PDL1_IDO", "PDL1_IDO_APC", 
"AR_LAR", "TCF1_pos", "MHCI_II_high", "CD56_NE", "CA9_Hypoxia"
)
celltype_anno$celltype_med <- ifelse(celltype_anno$category == TRUE, "tumor", celltype_anno$celltype_fine)
celltype_anno$celltype_broad <- c("Fibroblasts", "DCs", "Stromal", "Stromal", "M2_Mac", 
"Myofibroblasts", "Plasma", "tumor", "NK", "CD4_T", 
"tumor", "Treg", "CD8_T", "CD8_T", "CD8_T", "Endothelial", 
"CD4_T", "CD8_T", "APC", "tumor", "tumor", "tumor", 
"tumor", "tumor", "tumor", "tumor", "tumor", "tumor", "Neutrophils", 
"B_cell", "tumor", "APC", "tumor", "tumor", "tumor", 
"tumor", "tumor")

meta$celltype_fine <- celltype_anno$celltype_fine[match(meta$Label, celltype_anno$celltype_raza)]
meta$celltype_med <- celltype_anno$celltype_med[match(meta$Label, celltype_anno$celltype_raza)]
meta$celltype_broad <- celltype_anno$celltype_broad[match(meta$Label, celltype_anno$celltype_raza)]

## Add clinical data 
meta$pCR <- clinical$pCR[match(meta$PatientID, clinical$PatientID)]
meta$Arm <- clinical$Arm[match(meta$PatientID, clinical$PatientID)]
```

```{r}
# Create SingleCellExperiment object 
sce <- SingleCellExperiment(assays = list(counts = t(assay)),
                            colData = meta)
sce
```


```{r}
# Add neighborhood graph (based on touching cell masks - see Methods)
cur_from <- paste0(neighbors$ImageID, "_", neighbors$from)
cur_to <- paste0(neighbors$ImageID, "_", neighbors$to)

edgelist <- SelfHits(from = match(cur_from, sce$cell_id),
                     to = match(cur_to, sce$cell_id),
                     nnode = ncol(sce))

colPair(sce, "neighborhood") <- edgelist
```

```{r}
sce$PID <- sce$PatientID
sce$PID_phase <- paste0(sce$PatientID, "_", sce$BiopsyPhase)

#Arcsinh-transformation of counts
assay(sce, "exprs") <- asinh(counts(sce)/1)
```

```{r}
# Save SCE object 
#saveRDS(sce, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/TNBC_Raza_sce.rds")
sce <- readRDS("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/TNBC_Raza_sce.rds")
```



# Create spatial CD8 phenotypes

```{r}
# Possible graphs are neighborhood or expansion_14 (less inflamed PID)
sce <- aggregateNeighbors(sce, colPairName = "neighborhood", aggregate_by = "metadata", count_by = "celltype_broad", proportions = FALSE, name = "count_neighbors")
```

## Spatial CD8 Phenotype
based on Ruben Casanova and Hammerl et al., 2022

```{r}
## Step 1: CD8 T cell type scoring 
cur_dat <- sce$count_neighbors %>% as.data.frame
rownames(cur_dat) <- sce$cell_id
cur_dat$PID_phase <- sce$PID_phase

cur_dat$celltype_broad <- sce$celltype_broad

# Define CD8+ T cells as infiltrating, bystanding, ignored
cur_dat <- cur_dat %>% filter(celltype_broad == "CD8_T") %>% 
  mutate(CD8Tcell_type = ifelse(tumor >= 3, "infiltrating", 
                                ifelse(tumor < 3 & tumor > 0, "bystanding", "ignored")))

sce$CD8Tcell_type <- cur_dat$CD8Tcell_type[match(sce$cell_id, rownames(cur_dat))]
```

Visualization 

```{r}
out_test <- colData(sce) %>% as.data.frame() %>% group_by(ImageID, CD8Tcell_type) %>% dplyr::count() %>% filter(!is.na(CD8Tcell_type)) %>% filter(CD8Tcell_type == "infiltrating")
 
## Fraction and count of CD8Tcell_type per PID
p1 <- dittoBarPlot(sce[,!is.na(sce$CD8Tcell_type)], var = "CD8Tcell_type", group.by = "PID_phase")+
  theme(axis.text.x = element_blank(), axis.title.x = element_blank())

p2 <- dittoBarPlot(sce[,!is.na(sce$CD8Tcell_type)], var = "CD8Tcell_type", group.by = "PID_phase", scale = "count")+
  theme(axis.text.x = element_blank())+
  ggtitle("")

p1 / p2
```

```{r}
plotSpatial(
  object = sce[, sce$ImageID == "NTImg1647" & sce$celltype_broad %in% c("tumor", "CD8_T")], 
  img_id = "ImageID", 
  node_color_by = "CD8Tcell_type", 
  node_shape_by = "celltype_broad", 
  colPairName = "neighborhood", 
  coords = c("Location_Center_X", "Location_Center_Y"),
  draw_edges = TRUE, 
  nodes_first = FALSE, 
  directed = FALSE)+
  scale_color_manual(values = c("navy", "steelblue1", "firebrick"))
```

### Parameter sweep 

```{r}
## Step 1: CD8 T cell type scoring 
cur_dat <- sce$count_neighbors %>% as.data.frame
rownames(cur_dat) <- sce$cell_id
cur_dat$PID_phase <- sce$PID_phase

cur_dat$celltype_broad <- sce$celltype_broad

# Define CD8+ T cells as infiltrating, bystanding, ignored
cur_dat <- cur_dat %>% filter(celltype_broad == "CD8_T") %>% 
  mutate(CD8Tcell_type = ifelse(tumor >= 3, "infiltrating", 
                                ifelse(tumor < 3 & tumor > 0, "bystanding", "ignored")))


## Parameter sweep for PID group assignment 
# Test 2 - 10 for ratio_inf_ex 
# infiltrating 10 - 30
list_out <- list()
out_df <- colData(sce) %>% as.data.frame %>% select(PID_phase, BiopsyPhase, Arm, pCR) %>% unique() 

for(ratio in seq(1, 14, 1)){
  for(inf in seq(8, 32, 2)){
    
out <- cur_dat %>% group_by(PID_phase, CD8Tcell_type) %>% dplyr::count() %>% 
  pivot_wider(id_cols = PID_phase, values_from = n, names_from = CD8Tcell_type) %>% 
  mutate(ratio_inf_ex = bystanding / infiltrating, number_inf_ex = bystanding + infiltrating) %>% 
  mutate(spatial_CD8_phenotype = ifelse(ratio_inf_ex >= ratio | infiltrating <= inf, "excluded", "inflamed")) %>% 
  mutate(spatial_CD8_phenotype = ifelse(number_inf_ex <= 10 | is.na(number_inf_ex), "cold", spatial_CD8_phenotype))


out_df$spatial_CD8_pheno <- out$spatial_CD8_phenotype[match(out_df$PID_phase, out$PID_phase)]
out_df$spatial_CD8_pheno[is.na(out_df$spatial_CD8_pheno)] <- "cold"
out_df$spatial_CD8_pheno_merg <- ifelse(out_df$spatial_CD8_pheno == "inflamed", "inflamed", "cold_excluded")

out_C <- out_df %>% filter(BiopsyPhase == "Baseline") %>% group_by(spatial_CD8_pheno, Arm, BiopsyPhase, pCR) %>% dplyr::count() %>% group_by(spatial_CD8_pheno, BiopsyPhase, Arm) %>% mutate(fra = n/sum(n))
out_C$pCR <- factor(out_C$pCR, levels = c("RD","pCR"))

fisher_out <- chisq.test(xtabs(n ~ spatial_CD8_pheno + pCR, data = out_C %>% filter(Arm == "C&I")))
fisher_out_2 <- chisq.test(xtabs(n ~ spatial_CD8_pheno + pCR, data = out_C %>% filter(Arm == "C")))

out_C_merg <- out_df %>% filter(BiopsyPhase == "Baseline") %>% group_by(spatial_CD8_pheno_merg, Arm, BiopsyPhase, pCR) %>% dplyr::count() %>% group_by(spatial_CD8_pheno_merg, BiopsyPhase, Arm) %>% mutate(fra = n/sum(n))
out_C_merg$pCR <- factor(out_C_merg$pCR, levels = c("RD","pCR"))

fisher_out_merg <- chisq.test(xtabs(n ~ spatial_CD8_pheno_merg + pCR, data = out_C_merg %>% filter(Arm == "C&I")))
fisher_out_merg_2 <- chisq.test(xtabs(n ~ spatial_CD8_pheno_merg + pCR, data = out_C_merg %>% filter(Arm == "C")))

entry <- paste0(ratio, "_", inf)

list_out[[entry]] <- data.frame(ratio_inf_ex = ratio, 
           infiltrating = inf, 
           p_CI = fisher_out$p.value, 
           p_C = fisher_out_2$p.value,
           p_CI_merg = fisher_out_merg$p.value, 
           p_C_merg = fisher_out_merg_2$p.value)
}}

list_out_df <- do.call("rbind", list_out)

heatmap_out <- list_out_df %>% pivot_wider(id_cols = infiltrating, names_from = ratio_inf_ex, values_from = p_CI) %>% column_to_rownames("infiltrating")

cell_fun = function(j, i, x, y, width, height, fill) {
  if(as.matrix(heatmap_out)[i,j] < 0.02){
      grid.points(x, y, pch = 8, size = unit(4, "mm"))}
}

Heatmap(heatmap_out, cell_fun = cell_fun, col = rev(viridis(100)), cluster_columns = FALSE, cluster_rows = FALSE, border = TRUE)


heatmap_out_merg <- list_out_df %>% pivot_wider(id_cols = infiltrating, names_from = ratio_inf_ex, values_from = p_CI_merg) %>% column_to_rownames("infiltrating")

cell_fun_merg = function(j, i, x, y, width, height, fill) {
  if(as.matrix(heatmap_out_merg)[i,j] < 0.03){
      grid.points(x, y, pch = 8, size = unit(4, "mm"))}
}

Heatmap(heatmap_out_merg, cell_fun = cell_fun_merg, col = rev(viridis(100)), cluster_columns = FALSE, cluster_rows = FALSE, border = TRUE)
```

### Final choice 

Use the same cut-offs as for discovery cohort (despite different graph?)

```{r}
## Step 2: Classify Patients based on spatial CD8 T cell scores

out <- cur_dat %>% group_by(PID_phase, CD8Tcell_type) %>% dplyr::count() %>% 
  pivot_wider(id_cols = PID_phase, values_from = n, names_from = CD8Tcell_type) %>% 
  mutate(ratio_inf_ex = bystanding / infiltrating, number_inf_ex = bystanding + infiltrating) %>% 
  mutate(spatial_CD8_phenotype = ifelse(ratio_inf_ex >= 10 | infiltrating <= 20, "excluded", "inflamed")) %>% 
  mutate(spatial_CD8_phenotype = ifelse(number_inf_ex <= 10 | is.na(number_inf_ex), "cold", spatial_CD8_phenotype))

# Inflamed: ratio_inf_ex < 8 or > 20 inf CD8
# Excluded: ratio_inf_ex >= 8 
# Cold: number_inf_ex <= 10? 

# Add to sce
sce$spatial_CD8_pheno <- out$spatial_CD8_phenotype[match(sce$PID_phase, out$PID_phase)]

sce[,is.na(sce$spatial_CD8_pheno)]$spatial_CD8_pheno <- "cold"

spatial_CD8_pheno_col <- setNames(c("navy", "steelblue1","firebrick"), unique(sce$spatial_CD8_pheno)) 
metadata(sce)$colors$spatial_CD8_pheno <- spatial_CD8_pheno_col

sce$spatial_CD8_pheno_merg <- ifelse(sce$spatial_CD8_pheno == "inflamed", "inflamed", "cold_excluded")
  
spatial_CD8_pheno_merg_col <- setNames(c("steelblue1", "firebrick"), unique(sce$spatial_CD8_pheno_merg)) 
metadata(sce)$colors$spatial_CD8_pheno_merg <- spatial_CD8_pheno_merg_col
```

### Response comparison 

```{r}
out_check <- colData(sce) %>% as.data.frame %>% dplyr::select(PID_phase, BiopsyPhase, spatial_CD8_pheno_merg, spatial_CD8_pheno, Arm, pCR) %>% unique() 

out_C <- out_check %>% filter(BiopsyPhase == "Baseline") %>% group_by(spatial_CD8_pheno, Arm, BiopsyPhase, pCR) %>% dplyr::count() %>% group_by(spatial_CD8_pheno, BiopsyPhase, Arm) %>% mutate(fra = n/sum(n))

out_C$pCR <- factor(out_C$pCR, levels = c("RD","pCR"))

ggplot(out_C, aes(x = spatial_CD8_pheno, y = fra, fill = pCR))+
  facet_wrap(~Arm + BiopsyPhase)+
  geom_bar(stat = "identity", color = "black")+
  geom_hline(yintercept = 0.5, linetype = "dashed")+
  theme_classic()+
  scale_fill_manual(values = c("#ECD2FC", "#8019C0"))+
  coord_flip()

fisher_out <- chisq.test(xtabs(n ~ spatial_CD8_pheno + pCR, data = out_C %>% filter(Arm == "C&I")))
fisher_out

fisher_out_2 <- chisq.test(xtabs(n ~ spatial_CD8_pheno + pCR, data = out_C %>% filter(Arm == "C")))
fisher_out_2
```

```{r}
library(epitools)

out_C <- out_check %>% filter(BiopsyPhase == "Baseline") %>% group_by(spatial_CD8_pheno, Arm, BiopsyPhase, pCR) %>% dplyr::count() %>% group_by(spatial_CD8_pheno, BiopsyPhase, Arm) %>% mutate(fra = n/sum(n))
out_C$pCR <- factor(out_C$pCR, levels = c("RD","pCR"))

## Using epitab package
epitab(xtabs(n ~ spatial_CD8_pheno + pCR, data = out_C %>% filter(Arm == "C&I")), method = "oddsratio", pvalue = "chi2")

res_CI <- as.data.frame(epitab(xtabs(n ~ spatial_CD8_pheno + pCR, data = out_C %>% filter(Arm == "C&I")), method = "oddsratio", pvalue = "chi2")$tab)
res_CI <- res_CI %>% rownames_to_column("spatial_CD8_pheno")
res_CI$category <- "CI"

res_C <- as.data.frame(epitab(xtabs(n ~ spatial_CD8_pheno + pCR, data = out_C %>% filter(Arm == "C")), method = "oddsratio", pvalue = "chi2")$tab)
res_C <- res_C %>% rownames_to_column("spatial_CD8_pheno")
res_C$category <- "C"

res_comb <- rbind(res_CI, res_C)
res_comb
res_comb$sig <- ifelse(res_comb$p.value < 0.05, TRUE, FALSE)

write.csv(res_comb, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/supp_tables/Odds_ImmunoRes_SpatialGroup.csv")

ggplot(res_comb, aes(x = spatial_CD8_pheno, y = oddsratio, color = sig))+
facet_wrap(~category)+
geom_errorbar(aes(ymax = upper, ymin = lower))+
  geom_point(size = 4)+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("Spatial groups")+
ylab("Odds ratio (pCR/RD)")+
theme_classic()+
scale_y_continuous(trans = "log10")+
theme(axis.text.x = element_text(angle = 90))+
coord_flip()
```

#### Number of T cells comparison 

```{r}
# Compare number of CD8+ T cells between spatial CD8 T cell groups
out <- colData(sce) %>% as.data.frame %>% select(PID, spatial_CD8_pheno, celltype_broad) %>% filter(celltype_broad == "CD8_T") %>% group_by(PID, spatial_CD8_pheno) %>% dplyr::count() 

out$CD8_category <- ifelse(out$n < quantile(out$n, probs = seq(0,1,1/3))[2], "low", 
                           ifelse(out$n > quantile(out$n, probs = seq(0,1,1/3))[3], "high", "medium"))

out_viz <- out %>% group_by(CD8_category, spatial_CD8_pheno) %>% dplyr::count() %>% ungroup() %>% group_by(CD8_category) %>% mutate(fra = n/sum(n))

out_viz$CD8_category <- factor(out_viz$CD8_category, levels = c("high","medium","low"))

ggplot(out_viz, aes(x = CD8_category, y = fra, fill = spatial_CD8_pheno))+
  geom_bar(stat = "identity", color = "black")+
  theme_classic()+
  scale_fill_manual(values = metadata(sce)$colors$spatial_CD8_pheno)

sce$CD8_number_category <- out$CD8_category[match(sce$PID, out$PID)]
sce$CD8_number_category_merg <- ifelse(sce$CD8_number_category == "high", "high","medium/low")
```

```{r}
out_check <- colData(sce) %>% as.data.frame %>% dplyr::select(PID_phase, BiopsyPhase, CD8_number_category_merg, CD8_number_category, Arm, pCR) %>% unique() 

out_C <- out_check %>% filter(BiopsyPhase == "Baseline") %>% group_by(CD8_number_category, Arm, BiopsyPhase, pCR) %>% dplyr::count() %>% group_by(CD8_number_category, BiopsyPhase, Arm) %>% mutate(fra = n/sum(n))

out_C$CD8_number_category <- factor(out_C$CD8_number_category, levels = c("low","medium","high"))

out_C$pCR <- factor(out_C$pCR, levels = c("RD","pCR"))

ggplot(out_C, aes(x = CD8_number_category, y = fra, fill = pCR))+
  facet_wrap(~Arm + BiopsyPhase)+
  geom_bar(stat = "identity", color = "black")+
  geom_hline(yintercept = 0.5, linetype = "dashed")+
  theme_classic()+
  scale_fill_manual(values = c("#ECD2FC", "#8019C0"))+
  coord_flip()

fisher_out <- chisq.test(xtabs(n ~ CD8_number_category + pCR, data = out_C %>% filter(Arm == "C&I")))
fisher_out

fisher_out_2 <- chisq.test(xtabs(n ~ CD8_number_category + pCR, data = out_C %>% filter(Arm == "C")))
fisher_out_2
```

```{r}
library(epitools)

out_C <- out_check %>% filter(BiopsyPhase == "Baseline") %>% group_by(CD8_number_category, Arm, BiopsyPhase, pCR) %>% dplyr::count() %>% group_by(CD8_number_category, BiopsyPhase, Arm) %>% mutate(fra = n/sum(n))
out_C$pCR <- factor(out_C$pCR, levels = c("RD","pCR"))
out_C$CD8_number_category <- factor(out_C$CD8_number_category, levels = c("low","medium","high"))

## Using epitab package
epitab(xtabs(n ~ CD8_number_category + pCR, data = out_C %>% filter(Arm == "C&I")), method = "oddsratio", pvalue = "chi2")

res_CI <- as.data.frame(epitab(xtabs(n ~ CD8_number_category + pCR, data = out_C %>% filter(Arm == "C&I")), method = "oddsratio", pvalue = "chi2")$tab)
res_CI <- res_CI %>% rownames_to_column("CD8_number_category")
res_CI$category <- "CI"

res_C <- as.data.frame(epitab(xtabs(n ~ CD8_number_category + pCR, data = out_C %>% filter(Arm == "C")), method = "oddsratio", pvalue = "chi2")$tab)
res_C <- res_C %>% rownames_to_column("CD8_number_category")
res_C$category <- "C"

res_comb <- rbind(res_CI, res_C)
res_comb
res_comb$sig <- ifelse(res_comb$p.value < 0.05, TRUE, FALSE)
res_comb$CD8_number_category <- factor(res_comb$CD8_number_category, levels = c("low","medium","high"))
write.csv(res_comb, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/supp_tables/Odds_ImmunoRes_NumberGroup.csv")


ggplot(res_comb, aes(x = CD8_number_category, y = oddsratio, color = sig))+
facet_wrap(~category)+
geom_errorbar(aes(ymax = upper, ymin = lower))+
  geom_point(size = 4)+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("Spatial groups")+
ylab("Odds ratio (pCR/RD)")+
theme_classic()+
scale_y_continuous(trans = "log10")+
theme(axis.text.x = element_text(angle = 90))+
coord_flip()
```

```{r}
colData(sce) %>% as.data.frame %>% filter(BiopsyPhase == "Baseline") %>% group_by(CD8Tcell_type) %>% count()
colData(sce) %>% as.data.frame %>% filter(BiopsyPhase == "Baseline") %>% select(PID,spatial_CD8_pheno) %>% unique() %>% group_by(spatial_CD8_pheno) %>% count()
colData(sce) %>% as.data.frame %>% filter(BiopsyPhase == "Baseline") %>% select(PID,CD8_number_category) %>% unique() %>% group_by(CD8_number_category) %>% count()
```


### T cell phenotype 

```{r}
colors <- colData(sce) %>% as.data.frame %>% select(celltype_fine, Colour) %>% unique()
colors_celltype_fine <- setNames(colors$Colour, colors$celltype_fine)

out_T_cell_type <- colData(sce) %>% as.data.frame %>% filter(BiopsyPhase == "Baseline" & !is.na(CD8Tcell_type)) %>% as.data.frame %>% select(CD8Tcell_type, celltype_fine) %>% group_by(CD8Tcell_type, celltype_fine) %>% dplyr::count() %>% group_by(CD8Tcell_type) %>% mutate(fra = n/sum(n))

out_T_cell_type$CD8Tcell_type <- factor(out_T_cell_type$CD8Tcell_type, levels = c("ignored", "bystanding", "infiltrating"))

ggplot(out_T_cell_type, aes(x = CD8Tcell_type, y = fra, fill = celltype_fine))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = colors_celltype_fine)+
  theme_classic()+
  coord_flip()
```

### Differential abundance testing 

#### Celltype fine

```{r}
### Differential abundance analysis based on edgeR
library(edgeR)

sce_sub <- sce[,sce$BiopsyPhase == "Baseline"]

abundances <- table(sce_sub$celltype_fine, sce_sub$PID)
abundances <- unclass(abundances) 
head(abundances)

#relevant patient metadata (Relevel so that pT 1/2 is baseline)
meta <- colData(sce_sub)[match(colnames(abundances), sce_sub$PID),]
meta$spatial_CD8_pheno_merg <- relevel(x=factor(meta$spatial_CD8_pheno_merg), ref = "cold_excluded")

#filter
meta <- meta[!is.na(meta$spatial_CD8_pheno_merg),]
abundances <- abundances[,colnames(abundances) %in% meta$PID]

#create DGEList - based on edgeR package
y.ab <- DGEList(abundances, samples=meta, group = meta$spatial_CD8_pheno_merg)

#Design matrix
design <- model.matrix(~spatial_CD8_pheno_merg, data = y.ab$samples)

#Visualize
# logCPM of abundances per cluster
cur_mat <- cpm(abundances,prior.count = 1,log = TRUE)

Heatmap(cur_mat, 
        col = viridis(100),
        column_split = unfactor(meta$spatial_CD8_pheno_merg))%v%
  columnAnnotation(spatial_CD8_pheno_merg_merg = anno_simple(unfactor(meta$spatial_CD8_pheno_merg)))


# Estimate NB and QL dispersion 
y.ab <- estimateDisp(y.ab, design, trend="none")
summary(y.ab$common.dispersion)
plotBCV(y.ab, cex=1)

fit.ab <- glmQLFit(y.ab, design, robust=TRUE, abundance.trend=FALSE)
summary(fit.ab$var.prior)
plotQLDisp(fit.ab, cex=1)

# Test for differential abundance of clusters between tumor stages
res <- glmQLFTest(fit.ab, coef=ncol(design))

res$coefficients
summary(decideTests(res))

DA <- res$table

DA <- topTags(res, n = nrow(DA), adjust.method = "BH")$table

DA <- DA %>% mutate(cluster = rownames(DA), sign = DA$FDR<0.05, result = ifelse(DA$logFC > 0 & DA$FDR < 0.05, "UP",ifelse(DA$logFC < 0 & DA$FDR < 0.05, "DOWN", "NOTSIG"))) %>% arrange(desc(logFC)) 

DA$category <- sce$isEpithelial[match(DA$cluster, sce$celltype_fine)]

DA$cluster <- factor(DA$cluster, levels = DA$cluster)

sig <- DA %>% filter(FDR<0.05) %>% pull(cluster) %>% unfactor



## Visualize
#Barplot
ggplot(DA, aes(cluster, y = logFC))+
  geom_col(aes(fill=result), col = "black")+
  scale_fill_manual(values = c("#377EB8","lightgrey","#E41A1C"))+
  ylab("logFC")+
  xlab("Cluster")+
  labs(fill = "FDR<0.1")+
  ggtitle("Spatial CD8 phenotype (cold vs inflamed)")+
  theme_classic()

#Volcano plot  
ggplot(DA, aes(x = logFC, y = -log10(FDR)))+
  geom_point(aes(col=cluster, size = -log10(FDR)))+
  geom_label_repel(data = DA %>% filter(FDR<0.05 & result == "UP"), aes(label = cluster))+
  scale_color_manual(values = colors_celltype_fine)+
  xlab("logFC (cold vs inflamed)")+
  ylab("-log10(FDR)")+
  theme_classic()+
  geom_hline(yintercept = -log10(0.05), linetype = "dashed")+
  geom_vline(xintercept = 0, linetype = "dashed")+
  labs(color = "cluster")

#Abundance vs log fold change (best?)
ggplot(DA, aes(x = logFC, y = logCPM))+
  geom_point(aes(col= cluster, 
                 size = -log10(FDR), shape = category))+
  geom_label_repel(data = DA %>% filter(FDR<0.05), aes(label = cluster))+
  scale_color_manual(values = colors_celltype_fine)+
  xlab("logFC (cold/excluded vs inflamed)")+
  ylab("Abundance (logCPM)")+
  theme_classic()+
  geom_vline(xintercept = 0, linetype = "dashed")+
  labs(color = "cluster")

library(ggnewscale)

ggplot(DA, aes(x = cluster, y = category, col = logFC, size = -log10(FDR))) +
  geom_point() +
  theme_classic() +
  scale_color_gradient2(high = "#E41A1C", mid = "white", low = "#377EB8") +
  scale_size(range = c(2, 10)) +
  new_scale_colour() +
  geom_point(data = DA, shape = 1, aes(size = -log10(FDR), col = result), stroke = 1.5) +
  scale_color_manual(values = c("UP" = "#E41A1C", "NOTSIG" = "snow2", "DOWN" = "#377EB8"), name = "Direction") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


#### Celltype broad

```{r}
### Differential abundance analysis based on edgeR
library(edgeR)

sce_sub <- sce[,sce$BiopsyPhase == "Baseline"]
#sce_sub$PID <- sce_sub$PatientID

abundances <- table(sce_sub$celltype_broad, sce_sub$PID)
abundances <- unclass(abundances) 
head(abundances)

#relevant patient metadata (Relevel so that pT 1/2 is baseline)
meta <- colData(sce_sub)[match(colnames(abundances), sce_sub$PID),]
meta$spatial_CD8_pheno_merg <- relevel(x=factor(meta$spatial_CD8_pheno_merg), ref = "cold_excluded")

#filter
meta <- meta[!is.na(meta$spatial_CD8_pheno_merg),]
abundances <- abundances[,colnames(abundances) %in% meta$PID]

#create DGEList - based on edgeR package
y.ab <- DGEList(abundances, samples=meta, group = meta$spatial_CD8_pheno_merg)

#Design matrix
design <- model.matrix(~spatial_CD8_pheno_merg, data = y.ab$samples)

#Visualize
# logCPM of abundances per cluster
cur_mat <- cpm(abundances,prior.count = 1,log = TRUE)

Heatmap(cur_mat, 
        col = viridis(100),
        column_split = unfactor(meta$spatial_CD8_pheno_merg))%v%
  columnAnnotation(spatial_CD8_pheno_merg_merg = anno_simple(unfactor(meta$spatial_CD8_pheno_merg)))


# Estimate NB and QL dispersion 
y.ab <- estimateDisp(y.ab, design, trend="none")
summary(y.ab$common.dispersion)
plotBCV(y.ab, cex=1)

fit.ab <- glmQLFit(y.ab, design, robust=TRUE, abundance.trend=FALSE)
summary(fit.ab$var.prior)
plotQLDisp(fit.ab, cex=1)

# Test for differential abundance of clusters between tumor stages
res <- glmQLFTest(fit.ab, coef=ncol(design))

res$coefficients
summary(decideTests(res))

DA <- res$table

DA <- topTags(res, n = nrow(DA), adjust.method = "BH")$table

DA <- DA %>% mutate(cluster = rownames(DA), sign = DA$FDR<0.05, result = ifelse(DA$logFC > 0 & DA$FDR < 0.05, "UP",ifelse(DA$logFC < 0 & DA$FDR < 0.05, "DOWN", "NOTSIG"))) %>% arrange(desc(logFC)) 

DA$category <- "celltype_broad"

DA$cluster <- factor(DA$cluster, levels = DA$cluster)

sig <- DA %>% filter(FDR<0.05) %>% pull(cluster) %>% unfactor

## Visualize
#Barplot
ggplot(DA, aes(cluster, y = logFC))+
  geom_col(aes(fill=result), col = "black")+
  scale_fill_manual(values = c("#377EB8","lightgrey","#E41A1C"))+
  ylab("logFC")+
  xlab("Cluster")+
  labs(fill = "FDR<0.1")+
  ggtitle("Spatial CD8 phenotype (cold vs inflamed)")+
  theme_classic()

#Volcano plot  
ggplot(DA, aes(x = logFC, y = -log10(FDR)))+
  geom_point(aes(col=cluster, size = -log10(FDR)))+
  geom_label_repel(data = DA %>% filter(FDR<0.05 & result == "UP"), aes(label = cluster))+
  #scale_color_manual(values = colors_celltype_fine)+
  xlab("logFC (cold vs inflamed)")+
  ylab("-log10(FDR)")+
  theme_classic()+
  geom_hline(yintercept = -log10(0.05), linetype = "dashed")+
  geom_vline(xintercept = 0, linetype = "dashed")+
  labs(color = "cluster")

#Abundance vs log fold change (best?)
ggplot(DA, aes(x = logFC, y = logCPM))+
  geom_point(aes(col= cluster, 
                 size = -log10(FDR), shape = category))+
  geom_label_repel(data = DA %>% filter(FDR<0.05 & result == "UP"), aes(label = cluster))+
  #scale_color_manual(values = colors_celltype_fine)+
  xlab("logFC (cold/excluded vs inflamed)")+
  ylab("Abundance (logCPM)")+
  theme_classic()+
  geom_vline(xintercept = 0, linetype = "dashed")+
  labs(color = "cluster")
```

## Expression analysis 

```{r}
rowData(sce)$clean_target <- rownames(sce)

rowData(sce)$tumor_markers <- rownames(sce) %in% c("PDL1_SP", "CD56", "Helios", "GATA3", "IDO", 
"AR", "PDL1_73", "Ki67", "CK5_14", "TCF1", "GZMB", "HLA_ABC", "cPARP", "CK8_18", "Vimentin", "CD15", "HLA_DR", "pH2AX", "CA9")

rowData(sce)$tumor_markers_1 <- rownames(sce) %in% c("PDL1_SP", "CD56", "Helios", "GATA3", "IDO", 
"AR", "PDL1_73", "Ki67", "CK5_14", "HLA_ABC", "cPARP", "CK8_18", "CD15", "HLA_DR", "pH2AX", "CA9")

rowData(sce)$CD8_T_cell_markers <- rownames(sce) %in% c("TOX", "TCF1", "PD1", "ICOS", "GZMB")
```


### Tumor 

```{r}
## Analyse tumor compartment expression 

# Subset to tumor cells
sce_tumor <- sce[,sce$isEpithelial == "TRUE" & sce$BiopsyPhase == "Baseline"]

# Aggregate expression per PID 
spatialpheno_mean_PID <- aggregateAcrossCells(sce_tumor, ids = sce_tumor$PID,
                                 statistics = "mean",
                                 use.assay.type = "exprs",
                                 subset.row = rowData(sce_tumor)$tumor_markers_1)

# Test for differential expression per category 
test <- t(assay(spatialpheno_mean_PID, "exprs")[rowData(spatialpheno_mean_PID)$tumor_markers_1,]) %>% as.data.frame %>% mutate(spatial_CD8_pheno = spatialpheno_mean_PID$spatial_CD8_pheno) 

#test$spatial_CD8_pheno <- unfactor(test$spatial_CD8_pheno)

test_result <- compare_means(c(PDL1_SP, CD56, Helios, GATA3, IDO, AR, PDL1_73, Ki67, CK5_14, HLA_ABC, cPARP, CK8_18, CD15, HLA_DR, pH2AX, CA9)~spatial_CD8_pheno, method = "kruskal.test",data = test) #Vimentin, TCF1, GZMB

test_result$p.adj <- p.adjust(test_result$p, method = "BH") 

test_result$psignif.adj <- as.matrix(symnum(test_result$p.adj,
       cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1), 
       symbols = c("****", "***", "**", "*", "ns")))[,1]

rownames(test_result) <- test_result$.y.

sig.proteins <- unfactor(test_result$.y.[test_result$p.adj < 0.05])


# Aggregate expression per spatial phenotype
spatialpheno_mean_sce <- aggregateAcrossCells(sce_tumor, ids = sce_tumor$spatial_CD8_pheno,
                                 statistics = "mean",
                                 use.assay.type = "exprs",
                                 subset.row = rowData(sce_tumor)$tumor_markers_1)

mat_scaled<- t(scale(t(assay(spatialpheno_mean_sce, "exprs"))))


highest_cat <- mat_scaled %>% as.data.frame() %>% rownames_to_column("gene") %>% pivot_longer(cols = 2:4, names_to = "spatial_CD8", values_to = "exprs") %>% group_by(gene) %>% mutate(max = max(exprs)) %>% filter(exprs == max) %>% select(gene, spatial_CD8) %>% as.data.frame() %>% column_to_rownames("gene")

## Visualize 

# Heatmap 
h <- Heatmap(assay(spatialpheno_mean_sce, "exprs"), col = viridis(100), name = "exprs", cluster_columns = FALSE, row_names_side = "left", show_row_dend = FALSE)+
  #Heatmap(mat_scaled, name = "scaled exprs", cluster_columns = FALSE)+
  rowAnnotation(cat = anno_simple(highest_cat, col = metadata(sce)$colors$spatial_CD8_pheno, width = unit(10, "mm")))+
  rowAnnotation(test = anno_text(test_result$psignif.adj))

lgd_cat <- Legend(title = "Highest_exprs", at = names(metadata(sce)$colors$spatial_CD8_pheno), 
              legend_gp = gpar(fill = metadata(sce)$colors$spatial_CD8_pheno))


draw(h,annotation_legend_list = list(lgd_cat))

# Just show scaled PDL1
Heatmap(t(scale(t(assay(spatialpheno_mean_sce, "exprs")[rownames(assay(spatialpheno_mean_sce, "exprs")) %in% c("PDL1_SP", "PDL1_73"),]))), name = "scaled exprs", cluster_columns = FALSE, row_names_side = "left", show_row_dend = FALSE)

# Violin plot
plotExpression(spatialpheno_mean_PID, 
               features = sig.proteins,
               x = "spatial_CD8_pheno", exprs_values = "exprs", 
               colour_by = "spatial_CD8_pheno", scales = "free_y") +
    theme(axis.text.x =  element_text(angle = 90))+
    scale_color_manual(values = metadata(sce)$colors$spatial_CD8_pheno)
```

### CD8 T cells

```{r}
## Analyse tumor compartment expression 

# Subset to tumor cells
sce_CD8 <- sce[,sce$celltype_broad == "CD8_T" & sce$BiopsyPhase == "Baseline"]

# Aggregate expression per PID 
spatialpheno_mean_PID <- aggregateAcrossCells(sce_CD8, ids = sce_CD8$PID,
                                 statistics = "mean",
                                 use.assay.type = "exprs",
                                 subset.row = rowData(sce_CD8)$CD8_T_cell_markers)

# Test for differential expression per category 
test <- t(assay(spatialpheno_mean_PID, "exprs")[rowData(spatialpheno_mean_PID)$CD8_T_cell_markers,]) %>% as.data.frame %>% mutate(spatial_CD8_pheno = spatialpheno_mean_PID$spatial_CD8_pheno) 

#test$spatial_CD8_pheno <- unfactor(test$spatial_CD8_pheno)

test_result <- compare_means(c(TOX, TCF1, PD1, ICOS, GZMB)~spatial_CD8_pheno, method = "kruskal.test",data = test) #Vimentin, TCF1, GZMB

test_result$p.adj <- p.adjust(test_result$p, method = "BH") 

test_result$psignif.adj <- as.matrix(symnum(test_result$p.adj,
       cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1), 
       symbols = c("****", "***", "**", "*", "ns")))[,1]

rownames(test_result) <- test_result$.y.

sig.proteins <- unfactor(test_result$.y.[test_result$p.adj < 0.05])


# Aggregate expression per spatial phenotype
spatialpheno_mean_sce <- aggregateAcrossCells(sce_CD8, ids = sce_CD8$spatial_CD8_pheno,
                                 statistics = "mean",
                                 use.assay.type = "exprs",
                                 subset.row = rowData(sce_CD8)$CD8_T_cell_markers)

mat_scaled<- t(scale(t(assay(spatialpheno_mean_sce, "exprs"))))


highest_cat <- mat_scaled %>% as.data.frame() %>% rownames_to_column("gene") %>% pivot_longer(cols = 2:4, names_to = "spatial_CD8", values_to = "exprs") %>% group_by(gene) %>% mutate(max = max(exprs)) %>% filter(exprs == max) %>% select(gene, spatial_CD8) %>% as.data.frame() %>% column_to_rownames("gene")

## Visualize 

# Heatmap 
h <- Heatmap(assay(spatialpheno_mean_sce, "exprs"), col = viridis(100), name = "exprs", cluster_columns = FALSE, row_names_side = "left", show_row_dend = FALSE)+
  #Heatmap(mat_scaled, name = "scaled exprs", cluster_columns = FALSE)+
  rowAnnotation(cat = anno_simple(highest_cat, col = metadata(sce)$colors$spatial_CD8_pheno, width = unit(10, "mm")))+
  rowAnnotation(test = anno_text(test_result$psignif.adj))

lgd_cat <- Legend(title = "Highest_exprs", at = names(metadata(sce)$colors$spatial_CD8_pheno), 
              legend_gp = gpar(fill = metadata(sce)$colors$spatial_CD8_pheno))


draw(h,annotation_legend_list = list(lgd_cat))

# Violin plot
plotExpression(spatialpheno_mean_PID, 
               features = sig.proteins,
               x = "spatial_CD8_pheno", exprs_values = "exprs", 
               colour_by = "spatial_CD8_pheno", scales = "free_y") +
    theme(axis.text.x =  element_text(angle = 90))+
    scale_color_manual(values = metadata(sce)$colors$spatial_CD8_pheno)
```

### B patch analysis 

```{r}
## Patch detection
sce <- patchDetection(sce,
               patch_cells = sce$celltype_broad == "B_cell",
               colPairName = "knn_interaction_graph",
               coords = c("Location_Center_X", "Location_Center_Y"),
               min_patch_size = 10,
               name = "patch_B_cell",
               expand_by = 0, 
               img_id = "ImageID", 
               BPPARAM = MulticoreParam(workers = 5))
```

```{r}
sce_sub <- sce[,sce$BiopsyPhase == "Baseline"]

## 1. Number of patches per PID 
n_Bpatch_PID <- colData(sce_sub) %>% as.data.frame %>% select(PID, spatial_CD8_pheno_merg, patch_B_cell) %>% 
  filter(!is.na(patch_B_cell)) %>% 
  unique() %>% 
  group_by(spatial_CD8_pheno_merg, PID) %>% 
  dplyr::count()

plot_df <- colData(sce_sub) %>% as.data.frame %>% select(PID, spatial_CD8_pheno_merg) %>% 
  unique() 
rownames(plot_df) <- NULL
plot_df$n_Bpatch <- n_Bpatch_PID$n[match(plot_df$PID, n_Bpatch_PID$PID)]
plot_df$n_Bpatch[is.na(plot_df$n_Bpatch)] <- 0

plot_df$spatial_CD8_pheno <- sce_sub$spatial_CD8_pheno[match(plot_df$PID, sce_sub$PID)]

library(ggpubr)
ggplot(plot_df, aes(x = spatial_CD8_pheno, y = n_Bpatch))+
  geom_boxplot(outlier.colour = NA)+
  geom_jitter(aes(color = spatial_CD8_pheno), size = 3, position=position_jitter(w=0.1,h=0.1))+
  guides(color = "none")+
  scale_color_manual(values = metadata(sce_sub)$colors$spatial_CD8_pheno)+
  theme_classic(base_size = 12)+
  #coord_cartesian(ylim = c(0,15))+
  theme(axis.title.x = element_blank())+
  ylab("Number of B cell patches per PID")+
  stat_compare_means(method = "kruskal.test")
  

## 2. Size of B cell patches 
size_Bpatch_PID <- colData(sce_sub) %>% as.data.frame %>% select(PID, spatial_CD8_pheno_merg, patch_B_cell) %>% 
  filter(!is.na(patch_B_cell)) %>% 
  group_by(patch_B_cell, PID) %>% 
  dplyr::count()

size_Bpatch_PID$spatial_CD8_pheno_merg <- plot_df$spatial_CD8_pheno_merg[match(size_Bpatch_PID$PID, plot_df$PID)]
size_Bpatch_PID$spatial_CD8_pheno <- sce_sub$spatial_CD8_pheno[match(size_Bpatch_PID$PID, sce_sub$PID)]

ggplot(size_Bpatch_PID, aes(x = spatial_CD8_pheno, y = n))+
  geom_boxplot(outlier.colour = NA)+
  geom_jitter(aes(color = spatial_CD8_pheno), size = 3, position=position_jitter(w=0.1,h=0.1))+
  guides(color = "none")+
  scale_color_manual(values = metadata(sce_sub)$colors$spatial_CD8_pheno)+
  theme_classic(base_size = 12)+
  #coord_cartesian(ylim = c(0,15))+
  theme(axis.title.x = element_blank())+
  #scale_y_log10()+
  ylab("Number of B cells per patch")+
  stat_compare_means(method = "kruskal.test")

# Define cut-off for small and large B cell follicles - use 21 B cells per patch (same cutoff as discovery)
summary(size_Bpatch_PID$n)

size_Bpatch_PID <- size_Bpatch_PID %>% mutate(patch_score = ifelse(n > 21, "large", "small"))

PID_large_patches <- size_Bpatch_PID %>% filter(patch_score == "large") %>% pull(PID) %>% unique()

size_Bpatch_PID <- size_Bpatch_PID %>% mutate(large_Bpatch = ifelse(PID %in% PID_large_patches, TRUE, FALSE))

## 3. Create B cell score per PID 
# No B cells = 1 
# No B cell patches = 2
# Small B cell patches = 3
# Large B cell patches = 4 

B_cells_PID <- colData(sce_sub) %>% as.data.frame %>% select(PID, celltype_broad) %>% filter(celltype_broad == "B_cell") %>% group_by(PID, celltype_broad) %>% dplyr::count()

plot_df$n_Bcells <- B_cells_PID$n[match(plot_df$PID, B_cells_PID$PID)]

plot_df$n_Bcells[is.na(plot_df$n_Bcells)] <- 0

plot_df$large_Bpatch <- size_Bpatch_PID$large_Bpatch[match(plot_df$PID, size_Bpatch_PID$PID)]


plot_df <- plot_df %>% mutate(B_cell_score = ifelse(n_Bcells == 0, "No_B_cell", 
                                         ifelse(n_Bpatch == 0, "No_B_patch", 
                                                ifelse(large_Bpatch == FALSE, "Small_B_patch", "Large_B_patch"))))

plot_df$B_cell_score <- factor(plot_df$B_cell_score, levels = c("No_B_cell","No_B_patch", "Small_B_patch", "Large_B_patch"))


plot <- plot_df %>%
  group_by(B_cell_score, spatial_CD8_pheno) %>%
  dplyr::summarise(n=n()) %>%
  group_by(spatial_CD8_pheno) %>%
  mutate(fraction = n / sum(n)) %>%
  ungroup()


plot_test <- plot %>% pivot_wider(names_from = spatial_CD8_pheno, id_cols = B_cell_score, values_from = n) %>% column_to_rownames("B_cell_score")

plot_test[is.na(plot_test)] <- 0
plot_test_out <- fisher.test(plot_test, simulate.p.value = TRUE)

chisq.test(plot_test) 

ggplot(plot) + 
  geom_col(aes(y=spatial_CD8_pheno, x=fraction, fill=B_cell_score), color = "black") +
  theme_classic() + 
  xlab("Fraction of PID") +
  ylab("")+
  scale_fill_brewer(palette = "Paired")+
  coord_flip()+
  ggtitle(paste0("p (Fisher) = ", plot_test_out$p.value))


## 4. Add to sce_sub
sce_sub$B_cell_score <- plot_df$B_cell_score[match(sce_sub$PID, plot_df$PID)]
```

## TO DO

```{r}
#sce <- readRDS("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/TNBC_Raza_sce.rds")

## Patch detection
sce <- patchDetection(sce,
               patch_cells = sce$celltype_broad == "B_cell",
               colPairName = "knn_interaction_graph",
               coords = c("Location_Center_X", "Location_Center_Y"),
               min_patch_size = 10,
               name = "patch_B_cell",
               expand_by = 0, 
               img_id = "ImageID", 
               BPPARAM = MulticoreParam(workers = 5))

#Run over night 
sce <- buildSpatialGraph(sce, img_id = "ImageID", type = "expansion", threshold = 12, name = "expansion_12", 
                         coords = c("Location_Center_X", "Location_Center_Y"),
                         BPPARAM = MulticoreParam(workers = 5))


saveRDS(sce, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/TNBC_Raza_sce.rds")

sce <- buildSpatialGraph(sce, img_id = "ImageID", type = "expansion", threshold = 14, name = "expansion_14", 
                         coords = c("Location_Center_X", "Location_Center_Y"),
                         BPPARAM = MulticoreParam(workers = 5))


saveRDS(sce, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/TNBC_Raza_sce.rds")
```


## Save SCE 

```{r}
saveRDS(sce, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/TNBC_Raza_sce.rds")
```

## Save plots as pdf

```{r save_plots}
##IMPORTANT: change to chunk output in console for this last part 

##save plots as pdf (vector graphics)
pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/TNBC_Raza/TBNC_Raza_Response_Baseline_Bar.pdf",width = 9,height = 5)
ggplot(out_C, aes(x = spatial_CD8_pheno, y = fra, fill = pCR))+
  facet_wrap(~Arm + BiopsyPhase)+
  geom_bar(stat = "identity", color = "black")+
  geom_hline(yintercept = 0.5, linetype = "dashed")+
  theme_classic()+
  scale_fill_manual(values = c("#ECD2FC", "#8019C0"))+
  coord_flip()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/TNBC_Raza/TBNC_Raza_CD8spatial_T_pheno_bar.pdf", width = 7, height = 5)
ggplot(out_T_cell_type, aes(x = CD8Tcell_type, y = fra, fill = celltype_fine))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = colors_celltype_fine)+
  theme_classic()+
  coord_flip()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/TNBC_Raza/TBNC_Raza_SpatialGroups_DiffAbun_celltype_fine.pdf",width = 10,height = 5)
ggplot(DA, aes(x = logFC, y = logCPM))+
  geom_point(aes(col= cluster, 
                 size = -log10(FDR), shape = category))+
  geom_label_repel(data = DA %>% filter(FDR<0.05), aes(label = cluster))+
  scale_color_manual(values = colors_celltype_fine)+
  xlab("logFC (cold/excluded vs inflamed)")+
  ylab("Abundance (logCPM)")+
  theme_classic()+
  geom_vline(xintercept = 0, linetype = "dashed")+
  labs(color = "cluster")
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/TNBC_Raza/TBNC_Raza_SpatialGroups_DiffAbun_celltype_fine_bubble.pdf",width = 8,height = 4)
ggplot(DA, aes(x = cluster, y = category, col = logFC, size = -log10(FDR))) +
  geom_point() +
  theme_classic() +
  scale_color_gradient2(high = "#E41A1C", mid = "white", low = "#377EB8") +
  scale_size(range = c(1, 8)) +
  new_scale_colour() +
  geom_point(data = DA, shape = 1, aes(size = -log10(FDR), col = result), stroke = 1.5) +
  scale_color_manual(values = c("UP" = "#E41A1C", "NOTSIG" = "snow2", "DOWN" = "#377EB8"), name = "Direction") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
dev.off()


pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/TNBC_Raza/TBNC_Raza_SpatialGroups_TumorExpression_Heatmap.pdf",width = 5,height = 5)
draw(h,annotation_legend_list = list(lgd_cat))
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/TNBC_Raza/TBNC_Raza_SpatialGroups_TumorExpression_Sig_Violin.pdf",width = 7,height = 5)
plotExpression(spatialpheno_mean_PID, 
               features = sig.proteins,
               x = "spatial_CD8_pheno", exprs_values = "exprs", 
               colour_by = "spatial_CD8_pheno", scales = "free_y") +
    theme(axis.text.x =  element_text(angle = 90))+
    scale_color_manual(values = metadata(sce)$colors$spatial_CD8_pheno)
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/TNBC_Raza/TBNC_Raza_SpatialGroups_TumorExpression_Heatmap_PDL1only.pdf",width = 5,height = 3)
Heatmap(t(scale(t(assay(spatialpheno_mean_sce, "exprs")[rownames(assay(spatialpheno_mean_sce, "exprs")) %in% c("PDL1_SP", "PDL1_73"),]))), name = "scaled exprs", cluster_columns = FALSE, row_names_side = "left", show_row_dend = FALSE)
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/TNBC_Raza/TBNC_Raza_CD8spatial_Bcell_size_bar.pdf", width = 4, height = 5)
ggplot(plot) + 
  geom_col(aes(y=spatial_CD8_pheno, x=fraction, fill=B_cell_score), color = "black") +
  theme_classic() + 
  xlab("Fraction of PID") +
  ylab("")+
  scale_fill_brewer(palette = "Paired")+
  coord_flip()+
  ggtitle(paste0("p (Fisher) = ", round(plot_test_out$p.value, 4)))
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/TNBC_Raza/TBNC_Raza_CD8spatial_Response_Odds.pdf", width = 6,height = 4)
ggplot(res_comb, aes(x = spatial_CD8_pheno, y = oddsratio, color = sig))+
facet_wrap(~category)+
geom_errorbar(aes(ymax = upper, ymin = lower))+
  geom_point(size = 4)+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("Spatial groups")+
ylab("Odds ratio (pCR/RD)")+
theme_classic()+
scale_y_continuous(trans = "log10")+
theme(axis.text.x = element_text(angle = 90))+
coord_flip()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/TNBC_Raza/TBNC_Raza_CD8Number_Responses.pdf", width = 6,height = 4)
ggplot(out_C, aes(x = CD8_number_category, y = fra, fill = pCR))+
  facet_wrap(~Arm + BiopsyPhase)+
  geom_bar(stat = "identity", color = "black")+
  geom_hline(yintercept = 0.5, linetype = "dashed")+
  theme_classic()+
  scale_fill_manual(values = c("#ECD2FC", "#8019C0"))+
  coord_flip()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/TNBC_Raza/TBNC_Raza_CD8Number_Response_Odds.pdf", width = 6,height = 4)
ggplot(res_comb, aes(x = CD8_number_category, y = oddsratio, color = sig))+
facet_wrap(~category)+
geom_errorbar(aes(ymax = upper, ymin = lower))+
  geom_point(size = 4)+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("Spatial groups")+
ylab("Odds ratio (pCR/RD)")+
theme_classic()+
scale_y_continuous(trans = "log10")+
theme(axis.text.x = element_text(angle = 90))+
coord_flip()
dev.off()
```

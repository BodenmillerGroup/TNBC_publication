---
title: "GEO_Microarray_analysis"
author: "Lasse Meyer"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Software requirements

```{r lib, message=FALSE,warning=FALSE}
#Data containers
library(SpatialExperiment)
library(SingleCellExperiment)

#Data processing
library(scuttle)
library(scater)
library(scran)
library(imcRtools)

#Data visualization
library(cytomapper)
library(dittoSeq)
library(pheatmap)
library(cowplot)
library(ComplexHeatmap)
library(circlize)

#Utilities
library(tidyverse)
library(openxlsx)
library(stringr)
library(patchwork)
library(parallel)
library(BiocParallel)
library(BiocNeighbors)
library(BiocSingular)
library(tiff)
library(ggrepel)
library(EBImage)
library(viridis)
library(mclust)
library(Rphenograph)
library(igraph)
library(RColorBrewer)
library(foreach)
library(clValid)
library(bluster)
library(psych)
library(corrplot)
library(psych)

#Batch correction
library(batchelor)
```

# GSE25066 - Microarray data analysis for chemotherapy response in breast cancer cohort

Following this workflow: https://bioconductor.org/packages/release/workflows/vignettes/maEndToEnd/inst/doc/MA-Workflow.html

## Download data

```{r}
library(GEOquery)

gse <- getGEO("GSE25066",GSEMatrix=TRUE)
show(gse)
```

```{r}
# Data is stored as an Expression Set object (similar to SummarizedExperiment)
expset <- gse$GSE25066_series_matrix.txt.gz

# Feature data
features <- fData(expset) %>% as.data.frame #like rowData
features %>% filter(`Gene Symbol` %in% c("KRT5", "KRT7", "HLA-DRA"))

# Phenotype data
phenos <- pData(expset) %>% as.data.frame #like colData
expset$PID <- rownames(phenos)
```

### Add metadata 

```{r}
# Assign TNBC cases based on status scores 
expset$TNBC <- ifelse(expset$`er_status_ihc_esr1_for indeterminate:ch1` == "N" & expset$`pr_status_ihc:ch1` == "N" & expset$`her2_status:ch1` == "N", "TNBC", "Non_TNBC")

# Read in data from Lehmann et al. (2016, Plos ONE)
lehmann_GSE <- read_excel("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/03_data/lehmann_subtypes_GSE.xlsx", sheet = 1)
lehmann_GSE$PID <- lehmann_GSE$GEO_ID

# Add data to expset 
# TNBCtype (2011 study), TNBCtype_4 (2016 study)
expset$TNBCtype <- lehmann_GSE$TNBCtype[match(expset$PID, lehmann_GSE$PID)]
expset$TNBCtype_4 <- lehmann_GSE$TNBC_4TYPE[match(expset$PID, lehmann_GSE$PID)]
expset$TNBC_assign_lehmann <- lehmann_GSE$TNBC_FILTER[match(expset$PID, lehmann_GSE$PID)] #Optional to use this as TNBC assignment
#new_expset$TNBC_path <- lehmann_GSE$TNBC_PATH[match(new_expset$PID, lehmann_GSE$PID)] #Optional to use this as TNBC assignment

#expset$TNBC <- expset$TNBC_assign_lehmann 

# Turn subtypes into NA (if patient was not assigned TNBC in my dataset)
expset$TNBCtype <- ifelse(expset$TNBCtype %in% c("BL1", "BL2", "M", "MSL", "LAR", "IM") & expset$TNBC == "TNBC", expset$TNBCtype, NA)
expset$TNBCtype_4 <- ifelse(expset$TNBCtype_4 %in% c("BL1", "BL2", "M", "LAR") & expset$TNBC == "TNBC", expset$TNBCtype_4, NA)
```

## Probe summarization

```{r}
# Extract expression data and feature data
expr_data <- exprs(expset)
feature_data <- fData(expset)
```

```{r}
# Combine expression data with feature data
combined_data <- as.data.frame(expr_data)

combined_data$ENTREZ_GENE_ID <- feature_data$`Gene Symbol`
combined_data$seq_type <- feature_data$`Sequence Type`

# Remove rows without Entrez Gene IDs and select exemplar sequences only
combined_data <- combined_data[!is.na(combined_data$ENTREZ_GENE_ID),]
combined_data <- combined_data[combined_data$ENTREZ_GENE_ID != "",]
combined_data <- combined_data[combined_data$seq_type == "Exemplar sequence",] %>% select(-seq_type)

# Summarize by Entrez Gene ID
summarized_data <- combined_data %>%
  group_by(ENTREZ_GENE_ID) %>%
  summarise(across(where(is.numeric), mean))

# Remove the Entrez Gene ID column from summarized data to create expression matrix
exprs_summarized <- as.matrix(summarized_data %>% select(-ENTREZ_GENE_ID))

# Set the rownames of the summarized expression matrix to the Entrez Gene IDs
rownames(exprs_summarized) <- summarized_data$ENTREZ_GENE_ID
```


```{r}
# Create a new feature dataframe with unique Entrez Gene IDs
new_feature_data <- feature_data[!duplicated(feature_data$`Gene Symbol`),]
rownames(new_feature_data) <- new_feature_data$`Gene Symbol`
new_feature_data <- new_feature_data[rownames(exprs_summarized),]

# Ensure phenotype data is carried over
pheno_data <- pData(expset)

# Create a new ExpressionSet object
new_expset <- ExpressionSet(
  assayData = exprs_summarized,
  phenoData = AnnotatedDataFrame(pheno_data),
  featureData = AnnotatedDataFrame(new_feature_data)
)

# Verify the new ExpressionSet
print(new_expset)
```

## Filter T0 patients 

```{r}
new_expset <- new_expset[,new_expset$`clinical_t_stage:ch1` != "T0"]
exprs_summarized <- exprs_summarized[,colnames(exprs_summarized) %in% new_expset$PID]
```

## Save objects 

```{r}
#saveRDS(exprs_summarized, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/MDACC_RNA_analysis_expressionset_summarized.rds")
#saveRDS(new_expset, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/MDACC_RNA_analysis_expressionset.rds")

new_expset <- readRDS("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/MDACC_RNA_analysis_expressionset.rds")
exprs_summarized <- readRDS("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/MDACC_RNA_analysis_expressionset_summarized.rds")
```

## CK57 signature 

```{r}
# 1. CK5
GMM_CK5 <- Mclust(exprs_summarized["KRT5",], G = 2)

GMM_df <- data.frame(#class_epi = ifelse(GMM_CK5$classification == 2, "KRT5+", "KRT5-"),
                     class_epi = ifelse(exprs_summarized["KRT5",] > 10.4, "KRT5+", "KRT5-"),#quantile(exprs_summarized["KRT5",])[4], 
                     KRT5_exprs = exprs_summarized["KRT5",],
                     uncertainty = GMM_CK5$uncertainty)

#Visualize GMM
ggplot(GMM_df, aes(x = KRT5_exprs, fill = class_epi))+
  geom_density()+
  geom_rug(aes(color = class_epi))+
  theme_classic(base_size = 15)+
  theme(axis.title.x = element_blank())+
  scale_fill_brewer(palette = "Set1")+
  scale_color_brewer(palette = "Set1")

#Add GMM epi class to object
new_expset$GMM_KRT5 <- GMM_df$class_epi

# 2. CK7
GMM_CK7 <- Mclust(exprs_summarized["KRT7",], G = 2)

GMM_df <- data.frame(#class_epi = ifelse(GMM_CK7$classification == 2, "KRT7+", "KRT7-"),
                     class_epi = ifelse(exprs_summarized["KRT7",] > 11.8, "KRT7+", "KRT7-"),#quantile(exprs_summarized["KRT7",])[4], 11.8
                     KRT7_exprs = exprs_summarized["KRT7",],
                     uncertainty = GMM_CK7$uncertainty)


#Visualize GMM
ggplot(GMM_df, aes(x = KRT7_exprs, fill = class_epi))+
  geom_density()+
  geom_rug(aes(color = class_epi))+
  theme_classic(base_size = 17)+
  theme(axis.title.x = element_blank())+
  scale_fill_brewer(palette = "Set1")+
  scale_color_brewer(palette = "Set1")

#Add GMM epi class to object
new_expset$GMM_KRT7 <- GMM_df$class_epi

## Combine KRT5/7 GMM scores 
new_expset$KRT5_7_score <- ifelse(new_expset$GMM_KRT5 == "KRT5+" & new_expset$GMM_KRT7 == "KRT7+", "KRT5/7+", 
       ifelse(new_expset$GMM_KRT5 == "KRT5+" & new_expset$GMM_KRT7 == "KRT7-", "KRT5+",
              ifelse(new_expset$GMM_KRT5 == "KRT5-" & new_expset$GMM_KRT7 == "KRT7+", "KRT7+","KRT5/7-")))


## Add colors 
col_score <- setNames(c("grey",wes_palette("Moonrise3")[1:3]), c("KRT5/7-", "KRT5/7+","KRT5+", "KRT7+"))
```

### Visualization 

```{r}
### 1. Normalized counts
plot <- as.data.frame(t(exprs_summarized[rownames(exprs_summarized) %in% c("KRT5", "KRT7", "KRT18","KRT14","HLA-DRA"),]))
plot$KRT5_7_score <- new_expset$KRT5_7_score[match(rownames(plot),colnames(new_expset))]
plot$GMM_KRT5 <- new_expset$GMM_KRT5[match(rownames(plot),colnames(new_expset))]
plot$GMM_KRT7 <- new_expset$GMM_KRT7[match(rownames(plot),colnames(new_expset))]
plot$PAM50 <- new_expset$`pam50_class:ch1`[match(rownames(plot),colnames(new_expset))]
plot$response <- new_expset$`pathologic_response_pcr_rd:ch1`[match(rownames(plot),colnames(new_expset))]
plot$response_fine <- new_expset$`pathologic_response_rcb_class:ch1`[match(rownames(plot),colnames(new_expset))]
plot$TNBC <- new_expset$TNBC_assign_lehmann[match(rownames(plot),colnames(new_expset))]


ggplot(plot, aes(x=KRT7, y=KRT5, color = KRT5_7_score)) +
  geom_point(size = 2, alpha = 0.5)+
  theme_classic()+
  xlab("CK7 normalized counts")+
  ylab("CK5 normalized counts")

ggplot(plot, aes(x=KRT7, y=KRT5, color = TNBC)) +
  geom_point(size = 2, alpha = 0.5)+
  theme_classic()+
  xlab("CK7 normalized counts")+
  ylab("CK5 normalized counts")

ggplot(plot, aes(x=KRT7, y=KRT5, color = PAM50)) +
  geom_point(size = 2, alpha = 0.5)+
  theme_classic()+
  xlab("CK7 normalized counts")+
  ylab("CK5 normalized counts")

ggplot(plot, aes(x=KRT7, y=KRT5, color = response)) +
  geom_point(size = 2, alpha = 0.5)+
  theme_classic()+
  xlab("CK7 normalized counts")+
  ylab("CK5 normalized counts")

ggplot(plot, aes(x=KRT7, y=KRT5, color = response_fine)) +
  geom_point(size = 2, alpha = 0.5)+
  theme_classic()+
  xlab("CK7 normalized counts")+
  ylab("CK5 normalized counts")

main <- ggplot(plot, aes(x=KRT7, y=KRT5, color = KRT5_7_score)) +
  geom_point(size = 2, alpha = 0.5)+
  theme_classic()+
  xlab("CK7 log counts")+
  ylab("CK5 log counts")+
  #coord_cartesian(xlim = c(0,120000), ylim = c(0,300000))+
  scale_color_manual(values = col_score)+
  guides(color = "none")

y_side <- ggplot(plot, aes(x = KRT5, fill=GMM_KRT5)) +
  geom_density(alpha=0.8) +
  scale_fill_manual(values = c('#999999','#F4B5BD')) +
  theme_classic()+
  theme(legend.position = "none", axis.title.y = element_blank())+
  coord_flip()

x_side <- ggplot(plot, aes(x = KRT7, fill=GMM_KRT7)) +
  geom_density(alpha=0.8) +
  scale_fill_manual(values = c('#999999','#9C964A')) +
  #coord_cartesian(xlim = c(0,120000))+
  theme_classic()+
  theme(legend.position = "none", axis.title.x = element_blank())

blankPlot <- ggplot()+geom_blank(aes(1,1)) +
  cowplot::theme_nothing()

library(gridExtra)
grid.arrange(x_side, blankPlot, main, y_side,
        ncol=2, nrow=2, widths=c(4, 1.4), heights=c(1.4, 4))

plot %>% as.data.frame() %>% rownames_to_column("PID") %>% group_by(KRT5_7_score) %>% dplyr::count() %>% ungroup %>% mutate(fra = n/sum(n))
```

#### Barplots 

```{r}
## PAM50 subtype 
bar_out <- plot %>% as.data.frame() %>% group_by(KRT5_7_score, PAM50) %>% dplyr::count() %>% ungroup %>% group_by(PAM50) %>% mutate(fra = n/sum(n)) %>% arrange(PAM50)

ggplot(bar_out, aes(x = PAM50, y = fra, fill = KRT5_7_score))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = col_score)+
  theme_classic()

plot %>% as.data.frame() %>% rownames_to_column("PID") %>% group_by(PAM50) %>% dplyr::count() %>% ungroup %>% mutate(fra = n/sum(n))

## TNBC 
bar_out <- plot %>% as.data.frame() %>% group_by(KRT5_7_score, TNBC) %>% dplyr::count() %>% ungroup %>% group_by(TNBC) %>% mutate(fra = n/sum(n)) %>% arrange(TNBC)

ggplot(bar_out, aes(x = TNBC, y = fra, fill = KRT5_7_score))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = col_score)+
  theme_classic()

bar_test <- bar_out %>% filter(TNBC != "NA") %>% pivot_wider(names_from = TNBC, id_cols = KRT5_7_score, values_from = n) %>% column_to_rownames("KRT5_7_score")
bar_test_out <- chisq.test(bar_test)
print(bar_test_out$p.value)

plot %>% as.data.frame() %>% rownames_to_column("PID") %>% group_by(TNBC) %>% dplyr::count() %>% ungroup %>% mutate(fra = n/sum(n))

## Chemotherapy response 
bar_out <- plot %>% as.data.frame() %>% group_by(KRT5_7_score, response) %>% dplyr::count() %>% filter(response != "NA") %>% ungroup %>% group_by(response) %>% mutate(fra = n/sum(n))

ggplot(bar_out, aes(x = response, y = fra, fill = KRT5_7_score))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = col_score)+
  theme_classic()

bar_out <- plot %>% as.data.frame() %>% group_by(KRT5_7_score, response) %>% dplyr::count() %>% filter(response != "NA") %>% ungroup %>% group_by(KRT5_7_score) %>% mutate(fra = n/sum(n))

ggplot(bar_out, aes(x = KRT5_7_score, y = fra, fill = response))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = c("#ECD2FC", "#8019C0"))+
  theme_classic()

## Chemotherapy response - fine 
bar_out <- plot %>% as.data.frame() %>% group_by(KRT5_7_score, response_fine) %>% dplyr::count() %>% filter(response_fine != "NA") %>% ungroup %>% group_by(response_fine) %>% mutate(fra = n/sum(n))

ggplot(bar_out, aes(x = response_fine, y = fra, fill = KRT5_7_score))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = col_score)+
  theme_classic()

bar_out <- plot %>% as.data.frame() %>% group_by(KRT5_7_score, response_fine) %>% dplyr::count() %>% filter(response_fine != "NA") %>% ungroup %>% group_by(KRT5_7_score) %>% mutate(fra = n/sum(n))

ggplot(bar_out, aes(x = KRT5_7_score, y = fra, fill = response_fine))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = c("white","#ECD2FC", "#8019C0"))+
  theme_classic()
```

### Keratin markers 

```{r}
# Define keratins of interest
keratins <- c("KRT5","KRT7","KRT15","KRT8","KRT18","KRT19", "KRT14","KRT17","ITGA6","EPCAM")

keratins_rel <- keratins[keratins %in% rownames(exprs_summarized)]


# Define heatmap based on normalized counts 
## Option 1: size-factor normalized counts 
#df <- t(counts(dds, normalized = TRUE)[keratins,]) %>% as.data.frame %>% rownames_to_column("PID")
## Option 2: vst counts
df <- t(exprs_summarized[keratins_rel,]) %>% as.data.frame 
df <- df %>% rownames_to_column("PID")

## Create heatmap body 
df$KRT5_7_score <- new_expset$KRT5_7_score[match(df$PID, colnames(new_expset))]
mat <- df %>% pivot_longer(cols = 2:(ncol(df)-1), names_to = "gene", values_to = "exprs") %>% group_by(KRT5_7_score, gene) %>% dplyr::summarize(mean = mean(exprs))
ht <- mat %>% pivot_wider(names_from = "gene", values_from = "mean") %>% column_to_rownames("KRT5_7_score")

## Create row annotation 
anno <- df %>% select(KRT5_7_score) %>% group_by(KRT5_7_score) %>% dplyr::count()
anno <- anno[match(anno$KRT5_7_score, rownames(ht)),]

## Print heatmap 
Heatmap(ht, name = "Mean Z-scores")

Heatmap(scale(ht), name = "Scaled mean Z-scores")+
  rowAnnotation(n = anno_barplot(anno$n, gp = gpar(fill = "#440154FF")))+
  rowAnnotation(anno = anno_text(anno$KRT5_7_score))
```

### Stem markers 

```{r}
# Define stem markers of interest
stem <- c("SOX9","KIT","PROM1","HDAC2","NOTCH1","CD44","ALDH1A3","BRCA1","MUC1","EZH2", "YAP1","ANXA8", "TGFB2", "CD24", "TNFAIP3", "ERBB3", "TNFRSF11A")
#stem <- c("SOX9","KIT","PROM1","YAP1","HDAC2","NOTCH1","CD44","ALDH1A3","BRCA1","BRCA2", "TGFB2", "ANXA8","MUC1", "NT5E","TNF","NFKB1","EZH2", "ALDH3A1", "ALDH1A1", "TNFAIP3", "CD24", "WNT4")
stem_rel <- stem[stem %in% rownames(exprs_summarized)]

# Define heatmap based on normalized counts 
## Option 1: size-factor normalized counts 
#df <- t(counts(dds, normalized = TRUE)[stem,]) %>% as.data.frame %>% rownames_to_column("PID")
## Option 2: vst counts
df <- t(exprs_summarized[stem_rel,]) %>% as.data.frame 
#df <- as.data.frame(scale(df))
df <- df %>% rownames_to_column("PID")

## Create heatmap body 
df$KRT5_7_score <- new_expset$KRT5_7_score[match(df$PID, colnames(new_expset))]
mat <- df %>% pivot_longer(cols = 2:(ncol(df)-1), names_to = "gene", values_to = "exprs") %>% group_by(KRT5_7_score, gene) %>% dplyr::summarize(mean = mean(exprs))

ht <- mat %>% pivot_wider(names_from = "gene", values_from = "mean") %>% column_to_rownames("KRT5_7_score")

## Create row annotation 
anno <- df %>% select(KRT5_7_score) %>% group_by(KRT5_7_score) %>% dplyr::count()
anno <- anno[match(anno$KRT5_7_score, rownames(ht)),]

## Print heatmap 
Heatmap(ht, name = "Mean Z-scores")

Heatmap(scale(ht), name = "Scaled mean Z-scores")+
  rowAnnotation(n = anno_barplot(anno$n, gp = gpar(fill = "#440154FF")))+
  rowAnnotation(anno = anno_text(anno$KRT5_7_score))
```

### Gene signatures 

```{r}
library(readxl)
lum_progenitor_sig <- read_excel("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/03_data/LuminalProgenitor_Signature_Limetal_NatureMedicine_2009.xls")
mature_lum_sig <- read_excel("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/03_data/MatureLuminalSignature_Limetal_NatureMedicine_2009.xls")
basal_sig <- read_excel("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/03_data/Basal_Signature_Limetal_NatureMedicine_2009.xls")

# Extract unique genes that were up- or down-regulated in each signature 
lum_progenitor_sig_up <- lum_progenitor_sig %>% filter(`Average log fold-change` > 1) %>% pull(Symbol) %>% unique()
lum_progenitor_sig_up <- lum_progenitor_sig_up[!is.na(lum_progenitor_sig_up)]
lum_progenitor_sig_down <- lum_progenitor_sig %>% filter(`Average log fold-change` < -1) %>% pull(Symbol) %>% unique()
lum_progenitor_sig_down <- lum_progenitor_sig_down[!is.na(lum_progenitor_sig_down)]

mature_lum_sig_up <- mature_lum_sig %>% filter(`Average log fold-change` > 1) %>% pull(Symbol) %>% unique()
mature_lum_sig_up <- mature_lum_sig_up[!is.na(mature_lum_sig_up)]
mature_lum_sig_down <- mature_lum_sig %>% filter(`Average log fold-change` < -1) %>% pull(Symbol) %>% unique()
mature_lum_sig_down <- mature_lum_sig_down[!is.na(mature_lum_sig_down)]

basal_sig_up <- basal_sig %>% filter(`Average log fold-change` > 1) %>% pull(Symbol) %>% unique()
basal_sig_up <- basal_sig_up[!is.na(basal_sig_up)]
basal_sig_down <- basal_sig %>% filter(`Average log fold-change` < -1) %>% pull(Symbol) %>% unique()
basal_sig_down <- basal_sig_down[!is.na(basal_sig_down)]
```

Upregulated genes per signature 

```{r}
## 1. Luminal progenitor signature per PID group 
lum_progenitor_sig_up_rel <- lum_progenitor_sig_up[lum_progenitor_sig_up %in% rownames(exprs_summarized)]
# Filter for available genes
df <- t(exprs_summarized[lum_progenitor_sig_up_rel ,]) %>% as.data.frame
# Z-score gene expression 
df <- as.data.frame(scale(df))

df$signature_sum <- rowSums(df,na.rm = TRUE)
df$KRT5_7_score <- new_expset$KRT5_7_score[match(rownames(df), colnames(new_expset))]
df$KRT5_7_score <- factor(df$KRT5_7_score, levels = c("KRT5/7-", "KRT7+", "KRT5+", "KRT5/7+"))

compare_means(signature_sum ~ KRT5_7_score,df) #pairwise comparisons
compare_means(signature_sum ~ KRT5_7_score,df, method = "kruskal.test") #global comparison

ggplot(df, aes(x = KRT5_7_score, y = signature_sum))+
  geom_boxplot(outlier.color = NA)+
  geom_jitter(aes(color = KRT5_7_score), size = 3, position=position_jitter(w=0.1,h=0.1))+
  scale_color_manual(values = col_score)+
  theme_classic()+
  ylab("Luminal progenitor signature")+
  stat_compare_means()

mat <- df %>% pivot_longer(cols = 1:(ncol(df)-2), names_to = "gene", values_to = "exprs") %>% group_by(KRT5_7_score, gene) %>% dplyr::summarize(mean = mean(exprs))
mat <- mat %>% filter(!is.na(mean))
ht <- mat %>% pivot_wider(names_from = "gene", values_from = "mean") %>% column_to_rownames("KRT5_7_score")

Heatmap(ht, name = "Mean signature Z-scores")
```

```{r}
library(readxl)
AV_sig <- read_excel("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/03_data/Lietal_AV_BL_Signatures_reduced.xlsx",sheet = 1)

colnames(AV_sig) <- c("pan_AV", "BL_enriched","AP_enriched")

# Extract unique genes that were up- or down-regulated in each signature 
panAV_sig_up <- AV_sig$pan_AV
panAV_sig_up <- panAV_sig_up[!is.na(panAV_sig_up)]

BL_sig_up <- AV_sig$BL_enriched
BL_sig_up <- BL_sig_up[!is.na(BL_sig_up)]

AP_sig_up <- AV_sig$AP_enriched
AP_sig_up <- AP_sig_up[!is.na(AP_sig_up)]
```

```{r}
## 1. pan AV signature per PID group 
panAV_sig_up_rel <- panAV_sig_up[panAV_sig_up %in% rownames(exprs_summarized)]
# Filter for available genes
# Filter for available genes
#TNBC_PID <- colnames(new_expset[,new_expset$TNBC_assign_lehmann == "TNBC"])
#exprs_summarized_TNBC <- exprs_summarized[, colnames(exprs_summarized) %in% TNBC_PID]
#df <- t(exprs_summarized_TNBC[panAV_sig_up_rel ,]) %>% as.data.frame

df <- t(exprs_summarized[panAV_sig_up_rel ,]) %>% as.data.frame
# Z-score gene expression 
df <- as.data.frame(scale(df))

df$signature_sum <- rowSums(df,na.rm = TRUE)
df$KRT5_7_score <- new_expset$KRT5_7_score[match(rownames(df), colnames(new_expset))]
df$KRT5_7_score <- factor(df$KRT5_7_score, levels = c("KRT5/7-", "KRT7+", "KRT5+", "KRT5/7+"))

compare_means(signature_sum ~ KRT5_7_score,df) #pairwise comparisons
compare_means(signature_sum ~ KRT5_7_score,df, method = "kruskal.test") #global comparison

ggplot(df, aes(x = KRT5_7_score, y = signature_sum))+
  geom_boxplot(outlier.color = NA)+
  geom_jitter(aes(color = KRT5_7_score), size = 3, position=position_jitter(w=0.1,h=0.1))+
  scale_color_manual(values = col_score)+
  theme_classic()+
  ylab("Pan-Alveolar signature (Li et al.)")+
  stat_compare_means()
```


```{r}
## 2. BL signature per PID group 
BL_sig_up_rel <- BL_sig_up[BL_sig_up %in% rownames(exprs_summarized)]
# Filter for available genes
df <- t(exprs_summarized[BL_sig_up_rel ,]) %>% as.data.frame
# Z-score gene expression 
df <- as.data.frame(scale(df))

df$signature_sum <- rowSums(df,na.rm = TRUE)
df$KRT5_7_score <- new_expset$KRT5_7_score[match(rownames(df), colnames(new_expset))]
df$KRT5_7_score <- factor(df$KRT5_7_score, levels = c("KRT5/7-", "KRT7+", "KRT5+", "KRT5/7+"))

compare_means(signature_sum ~ KRT5_7_score,df) #pairwise comparisons
compare_means(signature_sum ~ KRT5_7_score,df, method = "kruskal.test") #global comparison

ggplot(df, aes(x = KRT5_7_score, y = signature_sum))+
  geom_boxplot(outlier.color = NA)+
  geom_jitter(aes(color = KRT5_7_score), size = 3, position=position_jitter(w=0.1,h=0.1))+
  scale_color_manual(values = col_score)+
  theme_classic()+
  ylab("Basal-luminal signature (Li et al.)")+
  stat_compare_means()

mat <- df %>% pivot_longer(cols = 1:(ncol(df)-2), names_to = "gene", values_to = "exprs") %>% group_by(KRT5_7_score, gene) %>% dplyr::summarize(mean = mean(exprs))
mat <- mat %>% filter(!is.na(mean))
ht <- mat %>% pivot_wider(names_from = "gene", values_from = "mean") %>% column_to_rownames("KRT5_7_score")

Heatmap(ht, name = "Mean signature Z-scores")
```


```{r}
## 2. BL signature per PID group (ONLY TNBC cases)
BL_sig_up_rel <- BL_sig_up[BL_sig_up %in% rownames(exprs_summarized)]

# Filter for available genes
TNBC_PID <- colnames(new_expset[,new_expset$TNBC_assign_lehmann == "TNBC"])
exprs_summarized_TNBC <- exprs_summarized[, colnames(exprs_summarized) %in% TNBC_PID]

df <- t(exprs_summarized_TNBC[BL_sig_up_rel ,]) %>% as.data.frame
# Z-score gene expression 
df <- as.data.frame(scale(df))

df$signature_sum <- rowSums(df,na.rm = TRUE)
df$KRT5_7_score <- new_expset$KRT5_7_score[match(rownames(df), colnames(new_expset))]
df$KRT5_7_score <- factor(df$KRT5_7_score, levels = c("KRT5/7-", "KRT7+", "KRT5+", "KRT5/7+"))

compare_means(signature_sum ~ KRT5_7_score,df) #pairwise comparisons
compare_means(signature_sum ~ KRT5_7_score,df, method = "kruskal.test") #global comparison

ggplot(df, aes(x = reorder(KRT5_7_score,signature_sum), y = signature_sum))+
  geom_boxplot(outlier.color = NA)+
  geom_jitter(aes(color = KRT5_7_score), size = 3, position=position_jitter(w=0.1,h=0.1))+
  scale_color_manual(values = col_score)+
  theme_classic()+
  ylab("Basal-luminal signature (Li et al.)")+
  stat_compare_means()+
  geom_signif(
    comparisons = list(c("KRT5/7+", "KRT5+"), c("KRT5/7+", "KRT5/7-"),c("KRT5/7+", "KRT7+")),
    map_signif_level = FALSE, step_increase = 0.1, test = "t.test"
  )

mat <- df %>% pivot_longer(cols = 1:(ncol(df)-2), names_to = "gene", values_to = "exprs") %>% group_by(KRT5_7_score, gene) %>% dplyr::summarize(mean = mean(exprs))
mat <- mat %>% filter(!is.na(mean))
ht <- mat %>% pivot_wider(names_from = "gene", values_from = "mean") %>% column_to_rownames("KRT5_7_score")

Heatmap(ht, name = "Mean signature Z-scores")
```




## HLADR signature 

```{r}
# 1. CK5
GMM_HLA <- Mclust(exprs_summarized["HLA-DRA",], G = 2)

GMM_df <- data.frame(#class_epi = ifelse(GMM_HLA$classification == 2, "HLA-DRA+", "HLA-DRA-"),
                     class_epi = ifelse(exprs_summarized["HLA-DRA",] > 13, "HLA-DRA+", "HLA-DRA-"),
                     HLADRA_exprs = exprs_summarized["HLA-DRA",],
                     uncertainty = GMM_HLA$uncertainty)

#Visualize GMM
ggplot(GMM_df, aes(x = HLADRA_exprs, fill = class_epi))+
  geom_density()+
  geom_rug(aes(color = class_epi))+
  theme_classic(base_size = 15)+
  theme(axis.title.x = element_blank())+
  scale_fill_brewer(palette = "Set1")+
  scale_color_brewer(palette = "Set1")

#Add GMM epi class to object
new_expset$GMM_HLADRA <- GMM_df$class_epi
```

## Patient groups 

```{r}
new_expset$PID_groups <- ifelse(new_expset$GMM_HLADRA == "HLA-DRA+", "inflamed", new_expset$KRT5_7_score)

new_expset$PID_group_risk <- ifelse(new_expset$PID_groups == "inflamed", "low", ifelse(new_expset$PID_groups %in% c("KRT5/7+"), "high", "medium"))
new_expset$PID_group_risk <- factor(new_expset$PID_group_risk, levels = c("high", "medium", "low"))

# Define color 
group_color <- setNames(c("#3B9AB2", "gold", "pink", "orange","#F21A00"), 
                        c("inflamed","KRT5/7-","KRT5+","KRT7+","KRT5/7+"))
new_expset$PID_groups <- factor(new_expset$PID_groups, levels = c("inflamed","KRT5/7-","KRT5+","KRT7+","KRT5/7+"))
```

## Survival analysis 

### Kaplan Meier curves 

```{r}
#Assess survival impact 
library(survival)
library(survminer)

cur_surv <- pData(new_expset) %>% as.data.frame() %>% dplyr::select(PID, KRT5_7_score, PID_groups, PID_group_risk, TNBC, `pam50_class:ch1`,TNBC_assign_lehmann, TNBCtype,TNBCtype_4, `drfs_1_event_0_censored:ch1`, `drfs_even_time_years:ch1`, `clinical_t_stage:ch1`) #%>% filter(TNBC_assign_lehmann == "TNBC") 

cur_surv$DRFS_time <- as.numeric(cur_surv$`drfs_even_time_years:ch1`)
cur_surv$DRFS <- as.numeric(cur_surv$`drfs_1_event_0_censored:ch1`)

#filter(KRT5_7_score %in% c("KRT5/7+", "KRT5+")) 
#TNBC == "TNBC") #KRT5_7_score %in% c("KRT5/7+, "KRT5+")

#Plot survival curves
fit <- survfit(Surv(DRFS_time, DRFS) ~ KRT5_7_score, data = cur_surv)

print(fit)

ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #log.rank.weights = "n",
          palette = c("grey","#85D4E3","#F4B5BD","#9C964A"))
          #xlim = c(0, 4000))

#Plot survival curves
fit_1 <- survfit(Surv(DRFS_time, DRFS) ~ PID_groups, data = cur_surv)

print(fit_1)

ggsurvplot(fit_1,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #log.rank.weights = "S1",
          palette = c("#3B9AB2", "gold", "pink", "orange","#F21A00"))
          #log.rank.weights = "n")
          #xlim = c(0, 4000))

#Plot survival curves
fit <- survfit(Surv(DRFS_time, DRFS) ~ PID_group_risk, data = cur_surv)

print(fit)

ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #log.rank.weights = "S1",
          palette = c(wes_palette("Zissou1")[5],"gold",wes_palette("Zissou1")[1]), 
          conf.int = FALSE)
          #log.rank.weights = "n")
          #xlim = c(0, 4000))


## TNBC subtypes 
#Plot survival curves
fit <- survfit(Surv(DRFS_time, DRFS) ~ TNBCtype, data = cur_surv)

print(fit)

ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #log.rank.weights = "n",
          palette = "Set1", 
          conf.int = FALSE)
          #log.rank.weights = "n")
          #xlim = c(0, 4000))

#Plot survival curves
fit <- survfit(Surv(DRFS_time, DRFS) ~ TNBCtype_4, data = cur_surv)

print(fit)

ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #log.rank.weights = "n",
          palette = "Set1", 
          conf.int = FALSE)
          #log.rank.weights = "n")
          #xlim = c(0, 4000))



```

#### Nested model testing 

```{r}
library(survival)
library(survminer)

cur_surv <- pData(new_expset) %>% as.data.frame() %>% dplyr::select(PID, KRT5_7_score, PID_groups, PID_group_risk, TNBC) #%>% filter(TNBC == "TNBC") 

cur_surv$age <- as.numeric(new_expset$`age_years:ch1`[match(cur_surv$PID,new_expset$PID)])
#cur_surv$grade <- as.factor(new_expset$`grade:ch1`[match(cur_surv$PID,new_expset$PID)])
#cur_surv$grade[cur_surv$grade == "NA"] <- NA 
#cur_surv$grade <- factor(cur_surv$grade)
cur_surv$pT_simple <- as.factor(new_expset$`clinical_t_stage:ch1`[match(cur_surv$PID,new_expset$PID)])
cur_surv$pN_simple <- as.factor(new_expset$`clinical_nodal_status:ch1`[match(cur_surv$PID,new_expset$PID)])

cur_surv$DFI.time <- as.numeric(new_expset$`drfs_even_time_years:ch1`)[match(cur_surv$PID,new_expset$PID)]
cur_surv$DFI <- as.numeric(new_expset$`drfs_1_event_0_censored:ch1`)[match(cur_surv$PID,new_expset$PID)]

cur_surv <- na.omit(cur_surv) 

covariates_null <- cur_surv %>% select(-PID, -DFI.time, -DFI, -KRT5_7_score, -PID_groups, -PID_group_risk, -TNBC) %>% colnames
multi_formula_null <- as.formula(paste("Surv(DFI.time, DFI) ~", paste(covariates_null, collapse = " + ")))
multi_model_null <- coxph(multi_formula_null, data = cur_surv)

covariates_full <- cur_surv %>% select(-PID, -DFI.time, -DFI, -PID_group_risk, -KRT5_7_score, -TNBC) %>% colnames
multi_formula_full <- as.formula(paste("Surv(DFI.time, DFI) ~", paste(covariates_full, collapse = " + ")))
multi_model_full <- coxph(multi_formula_full, data = cur_surv)

# Log-likelihood ratio test
anova(multi_model_null, multi_model_full)
```

### Cox models 

#### CK57 signature

Univariate 

```{r}
## 1. Disease-free interval 
PID_metagroups <- pData(new_expset) %>% as.data.frame() %>% 
  #filter(TNBC_assign_lehmann == "TNBC") %>% 
  dplyr::select(KRT5_7_score,PID) %>% group_by(PID) %>% table() %>% as.data.frame

PID_metagroups <- PID_metagroups %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

PID_metagroups <- PID_metagroups %>% pivot_wider(id_cols = "PID",names_from = "KRT5_7_score",values_from = "fra") %>% column_to_rownames("PID")

colnames(PID_metagroups) <- c("KRT57negative","KRT57positive", "KRT5positive","KRT7positive")

Cox_df <- PID_metagroups

#add covariates for correction

Cox_df$DFI.time <- as.numeric(new_expset$`drfs_even_time_years:ch1`)[match(rownames(Cox_df),new_expset$PID)]
Cox_df$DFI <- as.numeric(new_expset$`drfs_1_event_0_censored:ch1`)[match(rownames(Cox_df),new_expset$PID)]

#Based on proportions
covariates <- Cox_df %>% select(-DFI,-DFI.time, - "KRT57negative") %>% colnames

multi_formula <- as.formula(paste("Surv(DFI.time, DFI) ~", paste(covariates, collapse = " + "), "+ KRT57negative"))

multi_model <- coxph(multi_formula, data = Cox_df)

multi_res <- summary(multi_model)

plot_df_prop <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))

write.csv(plot_df_prop, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/supp_tables/MDACC_Cox_Uni_CK57_score.csv")

#Plot hazard ratios
hr_prop <- ggplot(plot_df_prop, aes(x = reorder(group,dplyr::desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
#coord_cartesian(ylim=c(0,12))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("Covariates")+
ylab("HR for PID groups")+
theme_classic()+
scale_y_continuous(trans = "log10")+
theme(axis.text.x = element_text(angle = 90))

hr_prop
```

Multivariate 

```{r}
## 1. Disease-free interval 
PID_metagroups <- pData(new_expset) %>% 
  as.data.frame() %>% 
  #filter(TNBC_assign_lehmann == "TNBC") %>% 
  dplyr::select(KRT5_7_score,PID) %>% group_by(PID) %>% table() %>% as.data.frame

PID_metagroups <- PID_metagroups %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

PID_metagroups <- PID_metagroups %>% pivot_wider(id_cols = "PID",names_from = "KRT5_7_score",values_from = "fra") %>% column_to_rownames("PID")

colnames(PID_metagroups) <- c("KRT57negative","KRT57positive", "KRT5positive","KRT7positive")

Cox_df <- PID_metagroups

#add time / events
Cox_df$DFI.time <- as.numeric(new_expset$`drfs_even_time_years:ch1`)[match(rownames(Cox_df),new_expset$PID)]
Cox_df$DFI <- as.numeric(new_expset$`drfs_1_event_0_censored:ch1`)[match(rownames(Cox_df),new_expset$PID)]

#add covariates for correction
Cox_df$age <- as.numeric(new_expset$`age_years:ch1`[match(rownames(Cox_df),new_expset$PID)])
Cox_df$grade <- as.factor(new_expset$`grade:ch1`[match(rownames(Cox_df),new_expset$PID)])
Cox_df$grade[Cox_df$grade == "NA"] <- NA 
Cox_df$grade <- factor(Cox_df$grade)
Cox_df$pT_simple <- as.factor(new_expset$`clinical_t_stage:ch1`[match(rownames(Cox_df),new_expset$PID)])
Cox_df$pN_simple <- as.factor(new_expset$`clinical_nodal_status:ch1`[match(rownames(Cox_df),new_expset$PID)])

#Based on proportions
covariates <- Cox_df %>% select(-DFI,-DFI.time, -age, -pT_simple, -pN_simple, -grade, - KRT57negative) %>% colnames

multi_formula <- as.formula(paste("Surv(DFI.time, DFI) ~ age + pT_simple + pN_simple + grade +", paste(covariates, collapse = " + "), "+ KRT57negative"))

multi_model <- coxph(multi_formula, data = Cox_df)

multi_res <- summary(multi_model)

plot_df_prop <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))

write.csv(plot_df_prop, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/supp_tables/MDACC_Cox_Multi_CK57_score.csv")

#Plot hazard ratios
hr_prop <- ggplot(plot_df_prop, aes(x = reorder(group,dplyr::desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
#coord_cartesian(ylim=c(0,12))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("Covariates")+
ylab("HR for PID groups")+
theme_classic()+
scale_y_continuous(trans = "log10")+
theme(axis.text.x = element_text(angle = 90))

hr_prop
```

#### PID groups

Univariate 

```{r}
## 1. Disease-free interval 
PID_metagroups <- pData(new_expset) %>% as.data.frame() %>%
  #filter(TNBC_assign_lehmann == "TNBC") %>% 
  dplyr::select(PID_groups,PID) %>% group_by(PID) %>% table() %>% as.data.frame

PID_metagroups <- PID_metagroups %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

PID_metagroups <- PID_metagroups %>% pivot_wider(id_cols = "PID",names_from = "PID_groups",values_from = "fra") %>% column_to_rownames("PID")

colnames(PID_metagroups) <- c("inflamed","KRT57negative","KRT5positive","KRT7positive","KRT57positive")

Cox_df <- PID_metagroups

#add covariates for correction

Cox_df$DFI.time <- as.numeric(new_expset$`drfs_even_time_years:ch1`)[match(rownames(Cox_df),new_expset$PID)]
Cox_df$DFI <- as.numeric(new_expset$`drfs_1_event_0_censored:ch1`)[match(rownames(Cox_df),new_expset$PID)]

#Based on proportions
covariates <- Cox_df %>% select(-DFI,-DFI.time, - inflamed) %>% colnames

multi_formula <- as.formula(paste("Surv(DFI.time, DFI) ~", paste(covariates, collapse = " + "), "+ inflamed"))

multi_model <- coxph(multi_formula, data = Cox_df)

multi_res <- summary(multi_model)

plot_df_prop <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],3),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],3),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],3),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],3),
                      wald_test = signif(multi_res$waldtest["pvalue"],3))

write.csv(plot_df_prop, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/supp_tables/MDACC_Cox_Uni_Groups.csv")
#write.csv(plot_df_prop, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/supp_tables/MDACC_TNBC_Cox_Uni_Groups.csv")


#Plot hazard ratios
hr_prop <- ggplot(plot_df_prop, aes(x = reorder(group,dplyr::desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
#coord_cartesian(ylim=c(0,12))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("Covariates")+
ylab("HR for PID groups")+
theme_classic()+
scale_y_continuous(trans = "log10")+
theme(axis.text.x = element_text(angle = 90))

hr_prop
```

Multivariate 

```{r}
## 1. Disease-free interval 
PID_metagroups <- pData(new_expset) %>% 
  as.data.frame() %>% 
  #filter(TNBC_assign_lehmann == "TNBC") %>% 
  dplyr::select(PID_groups,PID) %>% 
  group_by(PID) %>% table() %>% as.data.frame

PID_metagroups <- PID_metagroups %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

PID_metagroups <- PID_metagroups %>% pivot_wider(id_cols = "PID",names_from = "PID_groups",values_from = "fra") %>% column_to_rownames("PID")

colnames(PID_metagroups) <- c("inflamed","KRT57negative","KRT5positive","KRT7positive","KRT57positive")

Cox_df <- PID_metagroups

# Add time / events
Cox_df$DFI.time <- as.numeric(new_expset$`drfs_even_time_years:ch1`)[match(rownames(Cox_df),new_expset$PID)]
Cox_df$DFI <- as.numeric(new_expset$`drfs_1_event_0_censored:ch1`)[match(rownames(Cox_df),new_expset$PID)]

#add covariates for correction
Cox_df$age <- as.numeric(new_expset$`age_years:ch1`[match(rownames(Cox_df),new_expset$PID)])
Cox_df$grade <- as.factor(new_expset$`grade:ch1`[match(rownames(Cox_df),new_expset$PID)])
Cox_df$grade[Cox_df$grade == "NA"] <- NA 
Cox_df$grade <- factor(Cox_df$grade)
Cox_df$pT_simple <- as.factor(new_expset$`clinical_t_stage:ch1`[match(rownames(Cox_df),new_expset$PID)])
Cox_df$pN_simple <- as.factor(new_expset$`clinical_nodal_status:ch1`[match(rownames(Cox_df),new_expset$PID)])


#Based on proportions
covariates <- Cox_df %>% select(-DFI,-DFI.time, -age, -pT_simple, -pN_simple, -grade, - inflamed) %>% colnames

multi_formula <- as.formula(paste("Surv(DFI.time, DFI) ~ age + pT_simple + pN_simple + grade +", paste(covariates, collapse = " + "), "+ inflamed"))

multi_model <- coxph(multi_formula, data = Cox_df)

multi_res <- summary(multi_model)

plot_df_prop <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))

#write.csv(plot_df_prop, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/supp_tables/MDACC_TNBC_Cox_Multi_Groups.csv")
write.csv(plot_df_prop, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/supp_tables/MDACC_Cox_Multi_Groups.csv")

#Plot hazard ratios
hr_prop <- ggplot(plot_df_prop, aes(x = reorder(group,dplyr::desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
#coord_cartesian(ylim=c(0,12))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("Covariates")+
ylab("HR for PID groups")+
theme_classic()+
scale_y_continuous(trans = "log10")+
theme(axis.text.x = element_text(angle = 90))

hr_prop
```



#### PID risk 

Univariate 

```{r}
## 1. Disease-free interval 
PID_metagroups <- pData(new_expset) %>% 
  as.data.frame() %>% 
  #filter(TNBC_assign_lehmann == "TNBC") %>% 
  dplyr::select(PID_group_risk,PID) %>% group_by(PID) %>% table() %>% as.data.frame

PID_metagroups <- PID_metagroups %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

PID_metagroups <- PID_metagroups %>% pivot_wider(id_cols = "PID",names_from = "PID_group_risk",values_from = "fra") %>% column_to_rownames("PID")

#colnames(PID_metagroups) <- c("inflamed","KRT57negative","KRT5positive","KRT7positive","KRT57positive")

Cox_df <- PID_metagroups

#add covariates for correction

Cox_df$DFI.time <- as.numeric(new_expset$`drfs_even_time_years:ch1`)[match(rownames(Cox_df),new_expset$PID)]
Cox_df$DFI <- as.numeric(new_expset$`drfs_1_event_0_censored:ch1`)[match(rownames(Cox_df),new_expset$PID)]

#Based on proportions
covariates <- Cox_df %>% select(-DFI,-DFI.time, - low) %>% colnames

multi_formula <- as.formula(paste("Surv(DFI.time, DFI) ~", paste(covariates, collapse = " + "), "+ low"))

multi_model <- coxph(multi_formula, data = Cox_df)

multi_res <- summary(multi_model)

plot_df_prop <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],3),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],3),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],3),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],3),
                      wald_test = signif(multi_res$waldtest["pvalue"],3))

#write.csv(plot_df_prop, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/supp_tables/MDACC_TNBC_Cox_Uni_Risk.csv")
write.csv(plot_df_prop, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/supp_tables/MDACC_Cox_Uni_Risk.csv")

#Plot hazard ratios
hr_prop <- ggplot(plot_df_prop, aes(x = reorder(group,dplyr::desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
#coord_cartesian(ylim=c(0,12))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
#scale_color_manual(values = "#377EB8")+
scale_color_brewer(palette = "Set1")+
xlab("Covariates")+
ylab("HR for PID groups")+
theme_classic()+
scale_y_continuous(trans = "log10")+
theme(axis.text.x = element_text(angle = 90))

hr_prop
```

Multivariate 

```{r}
## 1. Disease-free interval 
PID_metagroups <- pData(new_expset) %>% 
  as.data.frame() %>% 
  filter(TNBC_assign_lehmann == "TNBC") %>% 
  dplyr::select(PID_group_risk,PID) %>% group_by(PID) %>% table() %>% as.data.frame

PID_metagroups <- PID_metagroups %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

PID_metagroups <- PID_metagroups %>% pivot_wider(id_cols = "PID",names_from = "PID_group_risk",values_from = "fra") %>% column_to_rownames("PID")

#colnames(PID_metagroups) <- c("inflamed","KRT57negative","KRT5positive","KRT7positive","KRT57positive")

Cox_df <- PID_metagroups

# Add time / events
Cox_df$DFI.time <- as.numeric(new_expset$`drfs_even_time_years:ch1`)[match(rownames(Cox_df),new_expset$PID)]
Cox_df$DFI <- as.numeric(new_expset$`drfs_1_event_0_censored:ch1`)[match(rownames(Cox_df),new_expset$PID)]

#add covariates for correction
Cox_df$age <- as.numeric(new_expset$`age_years:ch1`[match(rownames(Cox_df),new_expset$PID)])
Cox_df$grade <- as.factor(new_expset$`grade:ch1`[match(rownames(Cox_df),new_expset$PID)])
Cox_df$grade[Cox_df$grade == "NA"] <- NA 
Cox_df$grade <- factor(Cox_df$grade)
Cox_df$pT_simple <- as.factor(new_expset$`clinical_t_stage:ch1`[match(rownames(Cox_df),new_expset$PID)])
Cox_df$pN_simple <- as.factor(new_expset$`clinical_nodal_status:ch1`[match(rownames(Cox_df),new_expset$PID)])


#Based on proportions
covariates <- Cox_df %>% select(-DFI,-DFI.time, -age, -pT_simple, -pN_simple, -grade, - low) %>% colnames

multi_formula <- as.formula(paste("Surv(DFI.time, DFI) ~ age + pT_simple + pN_simple + grade +", paste(covariates, collapse = " + "), "+ low"))

multi_model <- coxph(multi_formula, data = Cox_df)

multi_res <- summary(multi_model)

plot_df_prop <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))

#write.csv(plot_df_prop, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/supp_tables/MDACC_TNBC_Cox_Multi_Risk.csv")
write.csv(plot_df_prop, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/supp_tables/MDACC_Cox_Multi_Risk.csv")

#Plot hazard ratios
hr_prop <- ggplot(plot_df_prop, aes(x = reorder(group,dplyr::desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
#coord_cartesian(ylim=c(0,12))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("Covariates")+
ylab("HR for PID groups")+
theme_classic()+
scale_y_continuous(trans = "log10")+
theme(axis.text.x = element_text(angle = 90))

hr_prop
```

#### TNBC type 4/TNBC type 

```{r}
## 1. Disease-free interval 
PID_metagroups <- pData(new_expset) %>% 
  as.data.frame() %>% 
  filter(TNBC_assign_lehmann == "TNBC") %>% 
  dplyr::select(TNBCtype,PID) %>% filter(!is.na(TNBCtype)) %>% group_by(PID) %>% table() %>% as.data.frame

PID_metagroups <- PID_metagroups %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

PID_metagroups <- PID_metagroups %>% pivot_wider(id_cols = "PID",names_from = "TNBCtype",values_from = "fra") %>% column_to_rownames("PID")

#colnames(PID_metagroups) <- c("inflamed","KRT57negative","KRT5positive","KRT7positive","KRT57positive")

Cox_df <- PID_metagroups

#add covariates for correction

Cox_df$DFI.time <- as.numeric(new_expset$`drfs_even_time_years:ch1`)[match(rownames(Cox_df),new_expset$PID)]
Cox_df$DFI <- as.numeric(new_expset$`drfs_1_event_0_censored:ch1`)[match(rownames(Cox_df),new_expset$PID)]

#Based on proportions
covariates <- Cox_df %>% select(-DFI,-DFI.time, - BL1) %>% colnames

multi_formula <- as.formula(paste("Surv(DFI.time, DFI) ~", paste(covariates, collapse = " + "), "+ BL1"))

multi_model <- coxph(multi_formula, data = Cox_df)

multi_res <- summary(multi_model)

plot_df_prop <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],3),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],3),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],3),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],3),
                      wald_test = signif(multi_res$waldtest["pvalue"],3))

write.csv(plot_df_prop, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/supp_tables/MDACC_TNBC_Cox_Uni_TNBCtype.csv")

#Plot hazard ratios
hr_prop <- ggplot(plot_df_prop, aes(x = reorder(group,dplyr::desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
#coord_cartesian(ylim=c(0,12))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("Covariates")+
ylab("HR for PID groups")+
theme_classic()+
scale_y_continuous(trans = "log10")+
theme(axis.text.x = element_text(angle = 90))

hr_prop
```

```{r}
## 1. Disease-free interval 
PID_metagroups <- pData(new_expset) %>% 
  as.data.frame() %>% 
  filter(TNBC_assign_lehmann == "TNBC") %>% 
  dplyr::select(TNBCtype_4,PID) %>% filter(!is.na(TNBCtype_4)) %>% group_by(PID) %>% table() %>% as.data.frame

PID_metagroups <- PID_metagroups %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

PID_metagroups <- PID_metagroups %>% pivot_wider(id_cols = "PID",names_from = "TNBCtype_4",values_from = "fra") %>% column_to_rownames("PID")

#colnames(PID_metagroups) <- c("inflamed","KRT57negative","KRT5positive","KRT7positive","KRT57positive")

Cox_df <- PID_metagroups

#add covariates for correction

Cox_df$DFI.time <- as.numeric(new_expset$`drfs_even_time_years:ch1`)[match(rownames(Cox_df),new_expset$PID)]
Cox_df$DFI <- as.numeric(new_expset$`drfs_1_event_0_censored:ch1`)[match(rownames(Cox_df),new_expset$PID)]

#Based on proportions
covariates <- Cox_df %>% select(-DFI,-DFI.time, - BL1) %>% colnames

multi_formula <- as.formula(paste("Surv(DFI.time, DFI) ~", paste(covariates, collapse = " + "), "+ BL1"))

multi_model <- coxph(multi_formula, data = Cox_df)

multi_res <- summary(multi_model)

plot_df_prop <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],3),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],3),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],3),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],3),
                      wald_test = signif(multi_res$waldtest["pvalue"],3))

write.csv(plot_df_prop, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/supp_tables/MDACC_TNBC_Cox_Uni_TNBCtype4.csv")

#Plot hazard ratios
hr_prop <- ggplot(plot_df_prop, aes(x = reorder(group,dplyr::desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
#coord_cartesian(ylim=c(0,12))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("Covariates")+
ylab("HR for PID groups")+
theme_classic()+
scale_y_continuous(trans = "log10")+
theme(axis.text.x = element_text(angle = 90))

hr_prop
```


## Barplot visualization 

```{r}
plot <- as.data.frame(t(exprs_summarized[rownames(exprs_summarized) %in% c("KRT5", "KRT7", "KRT18","KRT14","HLA-DRA"),]))
plot$KRT5_7_score <- new_expset$KRT5_7_score[match(rownames(plot),colnames(new_expset))]
plot$PAM50 <- new_expset$`pam50_class:ch1`[match(rownames(plot),colnames(new_expset))]
plot$response <- new_expset$`pathologic_response_pcr_rd:ch1`[match(rownames(plot),colnames(new_expset))]
plot$response_fine <- new_expset$`pathologic_response_rcb_class:ch1`[match(rownames(plot),colnames(new_expset))]
plot$TNBC <- new_expset$TNBC_assign_lehmann[match(rownames(plot),colnames(new_expset))]
plot$PID_groups <- new_expset$PID_groups[match(rownames(plot),colnames(new_expset))]
plot$PID_group_risk <- new_expset$PID_group_risk[match(rownames(plot),colnames(new_expset))]

#plot <- plot %>% filter(TNBC == "TNBC")

# PID groups 

## PAM50 subtype 
bar_out <- plot %>% as.data.frame() %>% group_by(PID_groups, PAM50) %>% dplyr::count() %>% filter(PAM50 != "NA") %>% ungroup %>% group_by(PAM50) %>% mutate(fra = n/sum(n)) %>% arrange(PAM50)

ggplot(bar_out, aes(x = PAM50, y = fra, fill = PID_groups))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = group_color)+
  theme_classic()

plot %>% as.data.frame() %>% rownames_to_column("PID") %>% group_by(PAM50) %>% dplyr::count() %>% ungroup %>% mutate(fra = n/sum(n))

## TNBC 
bar_out <- plot %>% as.data.frame() %>% group_by(PID_groups, TNBC) %>% dplyr::count() %>% ungroup %>% group_by(TNBC) %>% mutate(fra = n/sum(n)) %>% arrange(TNBC)

ggplot(bar_out, aes(x = TNBC, y = fra, fill = PID_groups))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = group_color)+
  theme_classic()

bar_test <- bar_out %>% filter(TNBC != "NA") %>% pivot_wider(names_from = TNBC, id_cols = PID_groups, values_from = n) %>% column_to_rownames("PID_groups")
bar_test_out <- chisq.test(bar_test)
print(bar_test_out$p.value)

plot %>% as.data.frame() %>% rownames_to_column("PID") %>% group_by(TNBC) %>% dplyr::count() %>% ungroup %>% mutate(fra = n/sum(n))


## Chemotherapy response 
bar_out <- plot %>% as.data.frame() %>% group_by(PID_groups, response) %>% dplyr::count() %>% filter(response != "NA") %>% ungroup %>% group_by(response) %>% mutate(fra = n/sum(n))

ggplot(bar_out, aes(x = response, y = fra, fill = PID_groups))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = group_color)+
  theme_classic()

bar_out <- plot %>% as.data.frame() %>% group_by(PID_groups, response) %>% dplyr::count() %>% filter(response != "NA") %>% ungroup %>% group_by(PID_groups) %>% mutate(fra = n/sum(n))

library(epitools)
test <- chisq.test(xtabs(n ~ response + PID_groups, data = bar_out))
test$p.value

ggplot(bar_out, aes(x = PID_groups, y = fra, fill = response))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = c("#ECD2FC", "#8019C0"))+
  theme_classic()+
  ggtitle(paste0("p = ", round(test$p.value, digits = 4)))

## Chemotherapy response - fine 
bar_out <- plot %>% as.data.frame() %>% group_by(PID_groups, response_fine) %>% dplyr::count() %>% filter(response_fine != "NA") %>% ungroup %>% group_by(response_fine) %>% mutate(fra = n/sum(n))

ggplot(bar_out, aes(x = response_fine, y = fra, fill = PID_groups))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = group_color)+
  theme_classic()

bar_out <- plot %>% as.data.frame() %>% group_by(PID_groups, response_fine) %>% dplyr::count() %>% filter(response_fine != "NA") %>% ungroup %>% group_by(PID_groups) %>% mutate(fra = n/sum(n))

ggplot(bar_out, aes(x = PID_groups, y = fra, fill = response_fine))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_brewer(palette = "Reds")+
  theme_classic()
```

```{r}
plot <- as.data.frame(t(exprs_summarized[rownames(exprs_summarized) %in% c("KRT5", "KRT7", "KRT18","KRT14","HLA-DRA"),]))
plot$KRT5_7_score <- new_expset$KRT5_7_score[match(rownames(plot),colnames(new_expset))]
plot$TNBC <- new_expset$TNBC[match(rownames(plot),colnames(new_expset))]
plot$PID_groups <- new_expset$PID_groups[match(rownames(plot),colnames(new_expset))]
plot$PID_group_risk <- new_expset$PID_group_risk[match(rownames(plot),colnames(new_expset))]
plot$TNBCtype <- new_expset$TNBCtype[match(rownames(plot),colnames(new_expset))]
plot$TNBCtype_4 <- new_expset$TNBCtype_4[match(rownames(plot),colnames(new_expset))]

plot <- plot %>% filter(TNBC == "TNBC")

## TNBC subtype 
bar_out <- plot %>% as.data.frame() %>% group_by(PID_groups, TNBCtype) %>% dplyr::count() %>% filter(TNBCtype != "NA") %>% ungroup %>% group_by(TNBCtype) %>% mutate(fra = n/sum(n)) %>% arrange(TNBCtype)

ggplot(bar_out, aes(x = TNBCtype, y = fra, fill = PID_groups))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = group_color)+
  theme_classic()

bar_out <- plot %>% as.data.frame() %>% group_by(PID_groups, TNBCtype) %>% dplyr::count() %>% filter(TNBCtype != "NA") %>% ungroup %>% group_by(PID_groups) %>% mutate(fra = n/sum(n)) %>% arrange(PID_groups)

ggplot(bar_out, aes(x = PID_groups, y = fra, fill = TNBCtype))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_brewer(palette = "Set1")+
  theme_classic()

## TNBC subtype 4 
bar_out <- plot %>% as.data.frame() %>% group_by(PID_groups, TNBCtype_4) %>% dplyr::count() %>% filter(TNBCtype_4 != "NA") %>% ungroup %>% group_by(TNBCtype_4) %>% mutate(fra = n/sum(n)) %>% arrange(TNBCtype_4)

ggplot(bar_out, aes(x = TNBCtype_4, y = fra, fill = PID_groups))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = group_color)+
  theme_classic()

bar_out <- plot %>% as.data.frame() %>% group_by(PID_groups, TNBCtype_4) %>% dplyr::count() %>% filter(TNBCtype_4 != "NA") %>% ungroup %>% group_by(PID_groups) %>% mutate(fra = n/sum(n)) %>% arrange(PID_groups)

ggplot(bar_out, aes(x = PID_groups, y = fra, fill = TNBCtype_4))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_brewer(palette = "Set1")+
  theme_classic()
```



## Alluvial 

```{r}
library(tidyverse)
library(easyalluvial)
library(ggalluvial)

df_alluvial <- pData(new_expset) %>% as.data.frame %>% dplyr::select(KRT5_7_score,GMM_HLADRA,PID_groups, PID_group_risk) #PID_groups_risk

alluvial_wide(df_alluvial, 
              colorful_fill_variable_stratum = FALSE,
              col_vector_flow = col_score, 
              order_levels = c("KRT5/7+","KRT5/7-","KRT7+","KRT5+", "high", "medium", "low"))+
  theme_classic()
```

## Key marker heatmap 

```{r}
# Define key markers of interest
key_marker <- c("KRT5","KRT7","HLA-DRA")

# Define heatmap based on normalized counts 
## Option 1: size-factor normalized counts 
#df <- t(counts(dds, normalized = TRUE)[keratins,]) %>% as.data.frame %>% rownames_to_column("PID")
## Option 2: vst counts
df <- t(exprs_summarized[key_marker,]) %>% as.data.frame 
df <- df %>% rownames_to_column("PID")

## Create heatmap body 
df$PID_groups <- new_expset$PID_groups[match(df$PID, colnames(new_expset))]

mat <- df %>% pivot_longer(cols = 2:(ncol(df)-1), names_to = "gene", values_to = "exprs") %>% group_by(PID_groups, gene) %>% dplyr::summarize(mean = mean(exprs))
ht <- mat %>% pivot_wider(names_from = "gene", values_from = "mean") %>% column_to_rownames("PID_groups")

## Create row annotation 
anno <- df %>% select(PID_groups) %>% group_by(PID_groups) %>% dplyr::count()
anno <- anno[match(anno$PID_groups, rownames(ht)),]

## Print heatmap 
Heatmap(ht, name = "Mean Z-scores")

Heatmap(scale(ht), name = "Scaled mean Z-scores")+
  #rowAnnotation(n = anno_barplot(anno$n, gp = gpar(fill = "#440154FF")))+
  rowAnnotation(anno = anno_text(anno$PID_groups))
```


```{r}
# Define key immune markers of interest
key_marker <- c("CD8A","CD274","PDCD1","GZMB","PDCD1LG2","IDO1")
key_marker <- key_marker[key_marker %in% rownames(exprs_summarized)]

# Define heatmap based on normalized counts 
## Option 1: size-factor normalized counts 
#df <- t(counts(dds, normalized = TRUE)[keratins,]) %>% as.data.frame %>% rownames_to_column("PID")
## Option 2: vst counts
df <- t(exprs_summarized[key_marker,]) %>% as.data.frame 
df <- df %>% rownames_to_column("PID")

## Create heatmap body 
df$PID_groups <- new_expset$PID_groups[match(df$PID, colnames(new_expset))]

mat <- df %>% pivot_longer(cols = 2:(ncol(df)-1), names_to = "gene", values_to = "exprs") %>% group_by(PID_groups, gene) %>% dplyr::summarize(mean = mean(exprs))
ht <- mat %>% pivot_wider(names_from = "gene", values_from = "mean") %>% column_to_rownames("PID_groups")

## Create row annotation 
anno <- df %>% select(PID_groups) %>% group_by(PID_groups) %>% dplyr::count()
anno <- anno[match(anno$PID_groups, rownames(ht)),]

## Print heatmap 
Heatmap(ht, name = "Mean Z-scores")

Heatmap(scale(ht), name = "Scaled mean Z-scores")+
  #rowAnnotation(n = anno_barplot(anno$n, gp = gpar(fill = "#440154FF")))+
  rowAnnotation(anno = anno_text(anno$PID_groups))
```



## Save object 

```{r}
saveRDS(new_expset, "/mnt/central_nas/tnbc_volume/TNBC/data_analysis/MDACC_RNA_analysis_expressionset.rds")
#new_expset <- readRDS("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/MDACC_RNA_analysis_expressionset.rds")
```

## Save plots 

```{r}
pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_KRT57score_scatter.pdf",width = 6,height = 5)
grid.arrange(x_side, blankPlot, main, y_side,
        ncol=2, nrow=2, widths=c(4, 1.4), heights=c(1.4, 4))
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_KRT57score_keratin_heatmap.pdf",width = 7,height = 4)
Heatmap(scale(ht), name = "Scaled mean Z-scores")+
  rowAnnotation(n = anno_barplot(anno$n, gp = gpar(fill = "#440154FF")))+
  rowAnnotation(anno = anno_text(anno$KRT5_7_score))
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_KRT57score_stem_heatmap.pdf",width = 9,height = 5)
Heatmap(scale(ht), name = "Scaled mean Z-scores")+
  rowAnnotation(n = anno_barplot(anno$n, gp = gpar(fill = "#440154FF")))+
  rowAnnotation(anno = anno_text(anno$KRT5_7_score))
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_KRT57score_genesignature_lumpro.pdf",width = 5,height = 5)
ggplot(df, aes(x = KRT5_7_score, y = signature_sum))+
  geom_boxplot(outlier.color = NA)+
  geom_jitter(aes(color = KRT5_7_score), size = 3, position=position_jitter(w=0.1,h=0.1))+
  scale_color_manual(values = col_score)+
  theme_classic()+
  ylab("Luminal progenitor signature")+
  stat_compare_means()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_KRT57score_genesignature_panAvo.pdf",width = 5,height = 5)
ggplot(df, aes(x = KRT5_7_score, y = signature_sum))+
  geom_boxplot(outlier.color = NA)+
  geom_jitter(aes(color = KRT5_7_score), size = 3, position=position_jitter(w=0.1,h=0.1))+
  scale_color_manual(values = col_score)+
  theme_classic()+
  ylab("Pan-Alveolar signature (Li et al.)")+
  stat_compare_means()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_KRT57score_genesignature_panAvo_TNBC.pdf",width = 5,height = 5)
ggplot(df, aes(x = KRT5_7_score, y = signature_sum))+
  geom_boxplot(outlier.color = NA)+
  geom_jitter(aes(color = KRT5_7_score), size = 3, position=position_jitter(w=0.1,h=0.1))+
  scale_color_manual(values = col_score)+
  theme_classic()+
  ylab("Pan-Alveolar signature (Li et al.)")+
  stat_compare_means()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_KRT57score_genesignature_BaLu.pdf",width = 5,height = 5)
ggplot(df, aes(x = KRT5_7_score, y = signature_sum))+
  geom_boxplot(outlier.color = NA)+
  geom_jitter(aes(color = KRT5_7_score), size = 3, position=position_jitter(w=0.1,h=0.1))+
  scale_color_manual(values = col_score)+
  theme_classic()+
  ylab("Basal-luminal signature (Li et al.)")+
  stat_compare_means()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_KRT57score_genesignature_BaLu_TNBC.pdf",width = 5,height = 5)
ggplot(df, aes(x = reorder(KRT5_7_score,signature_sum), y = signature_sum))+
  geom_boxplot(outlier.color = NA)+
  geom_jitter(aes(color = KRT5_7_score), size = 3, position=position_jitter(w=0.1,h=0.1))+
  scale_color_manual(values = col_score)+
  theme_classic()+
  ylab("Basal-luminal signature (Li et al.)")+
  stat_compare_means()+
  geom_signif(
    comparisons = list(c("KRT5/7+", "KRT5+"), c("KRT5/7+", "KRT5/7-"),c("KRT5/7+", "KRT7+")),
    map_signif_level = FALSE, step_increase = 0.1, test = "t.test"
  )
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_KRT57score_KaplanMeier.pdf",width = 6,height = 7, onefile = FALSE)
ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          palette = c("grey","#85D4E3","#F4B5BD","#9C964A"))
          #log.rank.weights = "n")
          #xlim = c(0, 4000))
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDgroups_KaplanMeier.pdf",width = 5,height = 5, onefile = FALSE)
ggsurvplot(fit_1,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #log.rank.weights = "S1",
          palette = c("#3B9AB2", "gold", "pink", "orange","#F21A00"))
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDgroups_KaplanMeier_TNBC.pdf",width = 5,height = 5, onefile = FALSE)
ggsurvplot(fit_1,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #log.rank.weights = "S1",
          palette = c("#3B9AB2", "gold", "pink", "orange","#F21A00"))
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDgroups_Risk_KaplanMeier.pdf",width = 5,height = 5, onefile = FALSE)
ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #log.rank.weights = "S1",
          palette = c(wes_palette("Zissou1")[5],"gold",wes_palette("Zissou1")[1]), 
          conf.int = FALSE)
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDgroups_Risk_TNBC_KaplanMeier.pdf",width = 5,height = 5, onefile = FALSE)
ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #log.rank.weights = "S1",
          palette = c(wes_palette("Zissou1")[5],"gold",wes_palette("Zissou1")[1]), 
          conf.int = FALSE)
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDgroups_Risk_TNBCtype_KaplanMeier.pdf",width = 5,height = 5, onefile = FALSE)
ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #log.rank.weights = "n",
          palette = "Set1", 
          conf.int = FALSE)
          #log.rank.weights = "n")
          #xlim = c(0, 4000))
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDgroups_Risk_TNBCtype4_KaplanMeier.pdf",width = 5,height = 5, onefile = FALSE)
ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #log.rank.weights = "n",
          palette = "Set1", 
          conf.int = FALSE)
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDgroups_Cox_Uni.pdf",width = 5,height = 5)
hr_prop
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDgroups_Cox_Multi.pdf",height = 5, width = 6)
hr_prop
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDgroups_Cox_Uni_TNBC.pdf",width = 5,height = 5)
hr_prop
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDrisk_Cox_Uni_TNBC.pdf",width = 5,height = 5)
hr_prop
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_TNBCtype_Cox_Uni_TNBC.pdf",width = 5,height = 5)
hr_prop
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_TNBCtype4_Cox_Uni_TNBC.pdf",width = 5,height = 5)
hr_prop
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_KRT57score_Cox_Uni.pdf",width = 4,height = 4)
hr_prop
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_KRT57score_Cox_Multi.pdf",height = 3, width = 7)
hr_prop
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_KRT57score_TNBC_Bar.pdf",width = 4,height = 4)
ggplot(bar_out, aes(x = TNBC, y = fra, fill = KRT5_7_score))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = col_score)+
  theme_classic()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDgroups_TNBC_Bar.pdf",width = 4,height = 4)
ggplot(bar_out, aes(x = TNBC, y = fra, fill = PID_groups))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = group_color)+
  theme_classic()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_KRT57score_PAM50_Bar.pdf",width = 6,height = 4)
ggplot(bar_out, aes(x = PAM50, y = fra, fill = KRT5_7_score))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = col_score)+
  theme_classic()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDgroups_PAM50_Bar.pdf",width = 6,height = 4)
ggplot(bar_out, aes(x = PAM50, y = fra, fill = PID_groups))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = group_color)+
  theme_classic()
dev.off()


pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDgroups_ChemoResponse.pdf",width = 5,height = 4)
ggplot(bar_out, aes(x = PID_groups, y = fra, fill = response))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = c("#8019C0","#ECD2FC"))+
  theme_classic()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDgroups_Alluvial.pdf",width = 4,height = 5)
alluvial_wide(df_alluvial, 
              colorful_fill_variable_stratum = FALSE,
              col_vector_flow = col_score, 
              order_levels = c("KRT5/7-","KRT7+","KRT5+","KRT5/7+"))+
  theme_classic()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_PIDgroups_KeyMarkers.pdf",width = 4,height = 5)
Heatmap(scale(ht), name = "Scaled mean Z-scores")+
  #rowAnnotation(n = anno_barplot(anno$n, gp = gpar(fill = "#440154FF")))+
  rowAnnotation(anno = anno_text(anno$PID_groups))
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_CK57score_Barplot_Pam50.pdf", height = 4, width = 5, onefile = FALSE)
ggplot(bar_out, aes(x = PAM50, y = fra, fill = KRT5_7_score))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = col_score)+
  theme_classic()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_CK57score_Barplot_TNBC.pdf", height = 4, width = 4, onefile = FALSE)
ggplot(bar_out, aes(x = TNBC, y = fra, fill = KRT5_7_score))+
  geom_bar(stat = "identity", color = "black")+
  scale_fill_manual(values = col_score)+
  theme_classic()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_Alluvial_Score_Group_Risk.pdf", height = 5, width = 5, onefile = FALSE)
alluvial_wide(df_alluvial, 
              colorful_fill_variable_stratum = FALSE,
              col_vector_flow = col_score, 
              order_levels = c("KRT5/7+","KRT5/7-","KRT7+","KRT5+", "high", "medium", "low"))+
  theme_classic()
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_MarkerHeatmap.pdf", height = 5, width = 4, onefile = FALSE)
Heatmap(scale(ht), name = "Scaled mean Z-scores")+
  #rowAnnotation(n = anno_barplot(anno$n, gp = gpar(fill = "#440154FF")))+
  rowAnnotation(anno = anno_text(anno$PID_groups))
dev.off()

pdf("/mnt/central_nas/tnbc_volume/TNBC/data_analysis/01_figures/GEO_microarray/MDACC_HLADR_GMM.pdf", height = 5, width = 6, onefile = FALSE)
ggplot(GMM_df, aes(x = HLADRA_exprs, fill = class_epi))+
  geom_density()+
  geom_rug(aes(color = class_epi))+
  theme_classic(base_size = 15)+
  theme(axis.title.x = element_blank())+
  scale_fill_brewer(palette = "Set1")+
  scale_color_brewer(palette = "Set1")
dev.off()
```




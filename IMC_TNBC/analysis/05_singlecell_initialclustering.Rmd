---
title: "05_SingleCell_InitialClustering"
output: html_document
date: '2022-03-30'
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Software requirements

```{r lib, message=FALSE,warning=FALSE}
#Data containers
library(SpatialExperiment)
library(SingleCellExperiment)

#Data processing
library(scuttle)
library(scater)
library(scran)
library(imcRtools)

#Data visualization
library(cytomapper)
library(dittoSeq)
library(pheatmap)
library(cowplot)
library(ComplexHeatmap)

#Utilities
library(tidyverse)
library(openxlsx)
library(stringr)
library(patchwork)
library(parallel)
library(BiocParallel)
library(BiocNeighbors)
library(BiocSingular)
library(tiff)
library(ggrepel)
library(EBImage)
library(viridis)
library(mclust)
library(Rphenograph)
library(igraph)
library(RColorBrewer)
library(foreach)
library(VennDiagram)

#Batch correction
library(batchelor)
```

# Single-cell analysis - Pipeline 1 - Distinguish tumor and immune cells

Here, we will perform the first single cell analysis steps, including distinguishing tumor and stromal cells and dimensionality reduction.

## Read in data and filter for ZTMA249
First, we will read in the `SingleCellExperiment` object containing the cleaned, spillover- and (batch-corrected) single-cell data. 
**Important:** For now, We will filter the object for ZTMA249 samples, since we are sure that those are TNBC. 

```{r read-data-batch-correction, message=FALSE}
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_QC.rds")

#Filter sce for ZTMA249 (n=654357)
summary(str_detect(colData(sce)$sample_id,"ZTMA249"))
sce <- sce[,str_detect(colData(sce)$sample_id,"ZTMA249")]
```

## Perform "overclustering"

Next, we will run a granular Rphenograph (Jaccard-based weights, Louvain clustering as community detection algorithm) clustering. 

```{r overcluster, message=FALSE}
set.seed(22)
snn.sce <- buildSNNGraph(sce[rowData(sce)$use_channel==TRUE,], k=30, 
                         d = NA, 
                         type = "jaccard",
                         assay.type = "exprs",
                         BNPARAM=AnnoyParam(),
                         BPPARAM = MulticoreParam(workers = (detectCores()-2), progressbar = TRUE)
                         )

clusters <- igraph::cluster_louvain(snn.sce) #Memory issues with this function!
sce$cluster <- as.factor(clusters$membership)
```

## Use GMM for panCK

We will use a two component gaussian mixture model to distinguish between tumor (panCK+) and stromal (panCK-) cells. 

```{r GMM_CK, message=FALSE,warning=FALSE}
#Gaussian mixture model to distinguish tumor/stroma based on panCK expression
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_Clus_249.rds")

GMM_CK <- Mclust(assay(sce, "exprs")["panCK",], G = 2)

GMM_df <- data.frame(class_CK = ifelse(GMM_CK$classification == 2 & GMM_CK$uncertainty == 0, "panCK+", "panCK-"), 
                     panCK_exprs = assay(sce, "exprs")["panCK",],
                     uncertainty = GMM_CK$uncertainty)

#Visualize GMM
GMM_plot_exp <- ggplot(GMM_df, aes(x = panCK_exprs, fill = class_CK))+
  geom_density()+
  theme_classic(base_size = 15)+
  theme(axis.title.x = element_blank())+
  scale_fill_brewer(palette = "Set1")
  
GMM_plot_unc <- ggplot(GMM_df, aes(x = panCK_exprs, y = uncertainty, color = class_CK))+
  geom_line()+
  theme_classic(base_size = 15)+
  theme(axis.title.x = element_blank())+
  scale_color_brewer(palette = "Set1")

GMM_plot_exp/GMM_plot_unc

#Add GMM CK class to SCE
sce$GMM_CK <- GMM_df$class_CK

#Save sce after clustering and GMM
saveRDS(sce, "/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_Clus_249.rds")
```

## Check correlation of panCK and Ecad as epithelial cell markers

```{r marker correlations, message = FALSE}
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_Clus_249.rds")

GOI <- c("panCK","Ecad","CK7","CK5","KRT14","CK8_18")
cor_sce <- as.data.frame(t(assay(sce,"exprs")[rowData(sce)$cluster_channel,]))
library(psych)
# For specific markers of interest (also shows the value distribution which is recommended)
pairs.panels(cor_sce,
             method = "spearman",
             hist.col = "#A6CEE3",
             digits = 2)
```

## Astir for automated cell type assignment 

## 2. ASTIR model

see [here](https://www.sciencedirect.com/science/article/pii/S2405471221003355?via%3Dihub) for full publication (Geuenich et al.,2021, Cell Systems).

```{r astir-expo}
#Export arsinh normalized expression matrix as csv
#Add sampleID as covariate in design matrix
expr_astir <- assay(sce,"exprs") %>% t() %>% as.data.frame() %>% mutate(sample = sce$sample_id)

write.csv(expr_astir, file = "/mnt/rcc_volume/TNBC/data_analysis/04_astir/expr_TNBC_astir.csv",row.names = TRUE)
```

`Next: Run Astir in conda-environment.`

```{r astir-ana, message = FALSE,warning=FALSE}
#Import Astir cell type assignments
astir_type <- read_csv("/mnt/rcc_volume/TNBC/data_analysis/04_astir/cell_types_TNBC.csv",col_names = c("ID","cell_type"),skip = 1)

astir_sum <- astir_type %>% group_by(cell_type) %>% count()

sce$astir_type <- astir_type$cell_type

#Mark channels used for cell type assignment 
astir_channel = c("panCK","CD3","CD20","CD68")

rowData(sce)$use_astir <- rowData(sce) %>% as.data.frame() %>% mutate(use_astir = ifelse(rownames(sce) %in% astir_channel,TRUE,FALSE)) %>% pull(use_astir)
```


## Heatmap 

Heatmap of clusters with GMM and ASTIR information 

```{r heatmap, message=FALSE, warning=FALSE}
#Read sce after clustering and GMM
#sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_Clus_249.rds")

### 1. Marker Heatmap 

#Min-Max [0,1] normalization of arcsinh-transformed counts
assay(sce, "min_max") <- assay(sce, "exprs") - rowMins(assay(sce, "exprs"))
assay(sce, "min_max") <- assay(sce, "min_max") / (rowMaxs(assay(sce, "exprs")) - rowMins(assay(sce, "exprs")))

#Aggregrate across cells with the mean (median is also possible)
mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster,
                                 statistics = "mean",
                                 use.assay.type = "min_max",
                                 subset.row = rowData(sce)$use_channel)

### 2. Spatial Heatmap
#Add number of neighbors to sce object (saved in ColPair)
n_neighbors <- colPair(sce) %>% as.data.frame() %>% group_by(from) %>% count() %>% arrange(desc(n))

sce$n_neighbors <- n_neighbors$n[match(seq_along(colnames(sce)),n_neighbors$from)]
sce$n_neighbors <- sce$n_neighbors %>% replace_na(0)

#Double-check 
sp1 <- plotSpatial(sce[,colData(sce)$sample_id == "ZTMA249.1_ZTMA249_ID_1_AX1Y1_93"],img_id = "sample_id",colPairName = "neighborhood",draw_edges = FALSE, assay_type = "exprs",node_color_by = "panCK")+
  scale_color_continuous(type = "viridis")+
  theme_classic()
sp2 <- plotSpatial(sce[,colData(sce)$sample_id == "ZTMA249.1_ZTMA249_ID_1_AX1Y1_93"],img_id = "sample_id",colPairName = "neighborhood",draw_edges = FALSE, node_color_by = "GMM_CK")+
  scale_color_brewer(palette = "Set1")+
  theme_classic()
sp3 <- plotSpatial(sce[,colData(sce)$sample_id == "ZTMA249.1_ZTMA249_ID_1_AX1Y1_93"],img_id = "sample_id",colPairName = "neighborhood",draw_edges = FALSE, node_color_by = "n_neighbors",node_size_fix = 2)+
  scale_color_continuous(type = "viridis")+
  theme_classic()
sp1+sp2+sp3

#Select spatial features and average over clusters 
spatial <- colData(sce) %>% as.data.frame %>% select(area,eccentricity,cluster,n_neighbors)
spatial <- spatial %>% select(-cluster) %>% aggregate(by = list(cluster = spatial$cluster), FUN = mean) %>% column_to_rownames("cluster")
#define min_max fct
min_max_norm <- function(x) {(x - min(x)) / (max(x) - min(x))}
#normalize
spatial_norm <- as.data.frame(lapply(spatial, min_max_norm))

### 3. Row annotation plots with number and fraction of tumor cells
#GMM
nr_tum <- colData(sce) %>% as.data.frame %>% select(cluster, GMM_CK) %>% table()
fr_tum <- as.data.frame(nr_tum) %>% pivot_wider(names_from = GMM_CK, values_from = Freq) %>% column_to_rownames("cluster")
fr_tum <- fr_tum %>% transmute(fr_tum = `panCK+`/rowSums(fr_tum)) %>% as.data.frame()

#Astir
nr_tum_2 <- colData(sce) %>% as.data.frame %>% select(cluster, astir_type) %>% table()

fr_tum_2 <- as.data.frame(nr_tum_2) %>% pivot_wider(names_from = astir_type, values_from = Freq) %>% column_to_rownames("cluster")
fr_tum_2 <- fr_tum_2 %>% transmute(fr_tum = `Epithelial`/rowSums(fr_tum_2)) %>% as.data.frame()

col_main = viridis(100)

### 4. Define tumor and stroma cluster (Fraction of tumor cells according to GMM >80%)
anno_tumor <- fr_tum %>% rownames_to_column(var = "cluster") %>% mutate(cluster_category = ifelse(fr_tum >= 0.8,"Epithelial",
                                                                                                  ifelse(fr_tum < 0.8 & fr_tum > 0.2,"Mixed","Non_Epithelial")))

col <- list(cluster = colorRampPalette(brewer.pal(9, "Paired"))(length(unique(anno_tumor$cluster))),
           cluster_category = c("#1F78B4","#A6CEE3","#B2DF8A"))

col_list_1 <- foreach(i=1:2) %do% {
  color= col[[i]]
  names(color)= sort(unique(anno_tumor[,names(col)[i]]))
  color
}
names(col_list_1) <- c(names(col))

### Plot combined Heatmap
h <- Heatmap(t(assay(mean_sce, "min_max")),
        col = col_main,
        name= "min-max",
        km = 1,
        show_row_names = T, 
        show_column_names =  T, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")+
  Heatmap(spatial_norm,
        col = col_main,
        name= "min-max",
        km = 1,
        show_row_names = T, 
        show_column_names =  T, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")+
  rowAnnotation(panCK_GMM = anno_barplot(fr_tum, width = unit(10, "mm"),gp = gpar(fill = "#377EB8", col = 1)),annotation_name_rot = 90)+
  rowAnnotation(panCK_Astir = anno_barplot(fr_tum_2, width = unit(10, "mm"),gp = gpar(fill = "#377EB8", col = 1)),annotation_name_rot = 90)+
  rowAnnotation(Number_Cells = anno_barplot(nr_tum, width = unit(10, "mm"),gp = gpar(fill = c("#E41A1C","#377EB8"), col = 1)),annotation_name_rot = 90)+
  rowAnnotation(cluster = anno_tumor$cluster,
                cluster_category = anno_tumor$cluster_category,
                col = col_list_1, 
                border = TRUE)

draw(h)

### Add cluster_categories to sce
sce$cluster_category <- anno_tumor$cluster_category[match(sce$cluster,anno_tumor$cluster)]

#Save sce
#saveRDS(sce, "/Volumes/rcc_volume/TNBC/data_analysis/sce_TNBC_Clus_249.rds")
```

## Venn diagrams / Pie plots for categories

```{r prop_tumor, message=FALSE, warning=FALSE}
## Pie plots 
#panCK+ per cluster category
prop_tumor <- colData(sce) %>% as.data.frame() %>%
  select(GMM_CK,cluster_category) %>% filter(GMM_CK == "panCK+") %>% group_by(cluster_category) %>% count()
prop_tumor <- prop_tumor %>% mutate(fr_tumor_clus = n/sum(prop_tumor$n))

pie(prop_tumor$fr_tumor_clus, labels = paste0(prop_tumor$cluster_category," - ",round(prop_tumor$fr_tumor_clus,3),"%"),col=col_list_1$cluster_category, main = "panCK+")

#panCK- per cluster category
prop_tumor_1 <- colData(sce) %>% as.data.frame() %>%
  select(GMM_CK,cluster_category) %>% filter(GMM_CK == "panCK-") %>% group_by(cluster_category) %>% count()
prop_tumor_1 <- prop_tumor_1 %>% mutate(fr_tumor_clus = n/sum(prop_tumor_1$n))
pie(prop_tumor_1$fr_tumor_clus, labels = paste0(prop_tumor_1$cluster_category," - ",round(prop_tumor_1$fr_tumor_clus,3),"%"),col=col_list_1$cluster_category, main = "panCK-")

#Tumor per GMM_CK
prop_tumor_2 <- colData(sce) %>% as.data.frame() %>%
  select(GMM_CK,cluster_category) %>% filter(cluster_category == "Epithelial") %>% group_by(GMM_CK) %>% count()
prop_tumor_2 <- prop_tumor_2 %>% mutate(fr_tumor_clus = n/sum(prop_tumor_2$n))
pie(prop_tumor_2$fr_tumor_clus, labels = paste0(prop_tumor_2$GMM_CK," - ",round(prop_tumor_2$fr_tumor_clus,3),"%"), col =c("#E41A1C","#377EB8"), main = "Epithelial")

prop_tumor_3 <- colData(sce) %>% as.data.frame() %>%
  select(GMM_CK,cluster_category) %>% filter(cluster_category == "Mixed") %>% group_by(GMM_CK) %>% count()
prop_tumor_3 <- prop_tumor_3 %>% mutate(fr_tumor_clus = n/sum(prop_tumor_3$n))
pie(prop_tumor_3$fr_tumor_clus, labels = paste0(prop_tumor_3$GMM_CK," - ",round(prop_tumor_3$fr_tumor_clus,3),"%"), col =c("#E41A1C","#377EB8"), main = "Mixed")

prop_tumor_4 <- colData(sce) %>% as.data.frame() %>%
  select(GMM_CK,cluster_category) %>% filter(cluster_category == "Non_Epithelial") %>% group_by(GMM_CK) %>% count()
prop_tumor_4 <- prop_tumor_4 %>% mutate(fr_tumor_clus = n/sum(prop_tumor_4$n))
pie(prop_tumor_4$fr_tumor_clus, labels = paste0(prop_tumor_4$GMM_CK," - ",round(prop_tumor_4$fr_tumor_clus,3),"%"), col =c("#E41A1C","#377EB8"), main = "Non_Epithelial")

## Upset plot
#panCK+ vs Epithelial/mixed clusters
library(UpSetR)
x = list(
Epithelial_Mixed_Clus = colData(sce) %>% as.data.frame %>% filter(cluster_category %in% c("Epithelial","Mixed")) %>% rownames_to_column() %>% pull("rowname"),
panCK_GMM = colData(sce) %>% as.data.frame %>% filter(GMM_CK == "panCK+") %>% rownames_to_column() %>% pull("rowname"),
panCK_Astir = colData(sce) %>% as.data.frame %>% filter(astir_type == "Epithelial") %>% rownames_to_column() %>% pull("rowname")
)
upset <- upset(fromList(x), order.by = "freq")
upset
```
## Re-analyse mixed clusters

```{r clus_mixed, message=FALSE, warning=TRUE}
sce_mixed <- sce[,colData(sce)$cluster_category == "Mixed"]

#Cluster on mixed cluster category
set.seed(22)
snn.sce_mixed <- buildSNNGraph(sce_mixed[rowData(sce_mixed)$use_channel==TRUE,], k=30, 
                         d = NA, 
                         type = "jaccard",
                         assay.type = "exprs",
                         BNPARAM=AnnoyParam(),
                         BPPARAM = MulticoreParam(workers = (detectCores()-2), progressbar = TRUE)
                         )

clusters <- igraph::cluster_louvain(snn.sce_mixed) #Memory issues with this function depending on size of graph
sce_mixed$cluster <- as.factor(clusters$membership)
unique(sce_mixed$cluster)

#Re-run GMM for panCK (useful?)
#Gaussian mixture model to distinguish tumor/stroma based on panCK expression
GMM_CK_2 <- Mclust(assay(sce_mixed, "exprs")["panCK",], G = 2)

GMM_df_2 <- data.frame(class_CK = ifelse(GMM_CK_2$classification == 2, "panCK+", "panCK-"), 
                     panCK_exprs = assay(sce_mixed, "exprs")["panCK",],
                     uncertainty = GMM_CK_2$uncertainty)

sce_mixed$GMM_CK_2 <- GMM_df_2$class_CK

#Heatmap 
dittoHeatmap(sce_mixed, genes = rownames(sce_mixed)[rowData(sce_mixed)$use_channel],
             assay = "exprs", cluster_cols = F, order.by = "GMM_CK", scale = "none",
             heatmap.colors = viridis(100), annot.by = c("GMM_CK","GMM_CK_2","astir_type","cluster","cluster_category"))
```

## Define categories for downstream analysis
Use all epithelial clusters and mixed clusters with panCK+ GMM for downstream tumor analysis.

```{r ana_cat, message = FALSE, warning=FALSE}
sce$analysis_cat <- colData(sce) %>% as.data.frame %>% select(cluster_category, GMM_CK) %>% mutate(analysis_cat = ifelse((sce$cluster_category == "Epithelial") | (sce$cluster_category == "Mixed" & sce$GMM_CK == "panCK+"),"tumor","non_tumor")) %>% pull(analysis_cat)

colData(sce) %>% as.data.frame %>% select(analysis_cat) %>% group_by(analysis_cat) %>% count()
#315070 tumor cells
#339287 non-tumor cells

#Intersection plot
## Upset plot
library(UpSetR)
x = list(
analysis_cat = colData(sce) %>% as.data.frame %>% filter(analysis_cat == "tumor") %>% rownames_to_column() %>% pull("rowname"),
panCK_GMM = colData(sce) %>% as.data.frame %>% filter(GMM_CK == "panCK+") %>% rownames_to_column() %>% pull("rowname"),
#panCK_Astir = colData(sce) %>% as.data.frame %>% filter(astir_type == "Epithelial") %>% rownames_to_column() %>% pull("rowname"),
Epithelial_Mixed_Clus = colData(sce) %>% as.data.frame %>% filter(cluster_category %in% c("Epithelial","Mixed")) %>% rownames_to_column() %>% pull("rowname")
)

upset <- upset(fromList(x), order.by = "freq")
upset
```

## Visualization of results on UMAP/TSNE

```{r viz_sub, message = FALSE, warning=FALSE}
## Subsample 10% of cells from each core 
#to save time and not get super crowded dimensionality reduction plots
set.seed(22011995)
sub <- colData(sce) %>% as.data.frame() %>% group_by("sample_id") %>% slice_sample(prop = 0.1) %>% arrange("sample_id") %>% mutate(sub_id = paste(sample_id,ObjectNumber,sep="_")) %>% pull(sub_id)
sce_sub = sce[,sub]
sce_sub$cluster = as.factor(sce_sub$cluster)  

#Run UMAP/TSNE
sce_sub = runUMAP(sce_sub[rowData(sce_sub)$use_channel,], n_neighbors = 30, pca = 50,exprs_values = "exprs", external_neighbors=TRUE, BPPARAM = MulticoreParam((detectCores()-2)))
sce_sub = runTSNE(sce_sub[rowData(sce_sub)$use_channel,], exprs_values = "exprs", external_neighbors=TRUE, BPPARAM = MulticoreParam((detectCores()-2)))

## 1. Visualize UMAP
#panCK and GMM_CK
p1 <- plotReducedDim(sce_sub, dimred = "UMAP", by_exprs_values = "exprs",colour_by = "panCK")

p2 <- plotReducedDim(sce_sub, dimred = "UMAP", colour_by = "GMM_CK")+
  scale_color_brewer(palette="Set1")

#p3 <- plotReducedDim(sce_sub, dimred = "UMAP", colour_by = "astir_type")+
#  scale_color_brewer(palette="Set1")

p4 <- plotReducedDim(sce_sub, dimred = "UMAP", colour_by = "cluster_category")+
  scale_color_manual(values = col_list_1[[2]])

p5 <- plotReducedDim(sce_sub, dimred = "UMAP", colour_by = "analysis_cat")+
  scale_color_brewer(palette="Set1")

(p1+p2)/(p4+p5)

#Visualize all marker expression
all_plots_UMAP <- lapply(c(rownames(sce_sub)[rowData(sce_sub)$use_channel]),
                    function(x){
                      p <- plotReducedDim(sce_sub, dimred = "UMAP", 
                                          colour_by = x, 
                                          by_exprs_values = "exprs",
                                          point_size = 0.5)
                      return(p)                    
                    })

library(cowplot)
plots_UMAP_exp <- plot_grid(plotlist = all_plots_UMAP)


## 2. Visualize TSNE
#panCK and GMM_CK
p6 <- plotReducedDim(sce_sub, dimred = "TSNE", by_exprs_values = "exprs",colour_by = "panCK")

p7 <- plotReducedDim(sce_sub, dimred = "TSNE", colour_by = "GMM_CK")+
  scale_color_brewer(palette="Set1")

p8 <- plotReducedDim(sce_sub, dimred = "TSNE", colour_by = "cluster_category")+
  scale_color_manual(values = col_list_1[[2]])

p9 <- plotReducedDim(sce_sub, dimred = "TSNE", colour_by = "analysis_cat")+
  scale_color_brewer(palette="Set1")

(p6+p7)/(p8+p9)

#Visualize all marker expression
all_plots_TSNE <- lapply(c(rownames(sce_sub)[rowData(sce_sub)$use_channel]),
                    function(x){
                      p <- plotReducedDim(sce_sub, dimred = "TSNE", 
                                          colour_by = x, 
                                          by_exprs_values = "exprs",
                                          point_size = 0.5)
                      return(p)                    
                    })

library(cowplot)
plots_TSNE_exp <- plot_grid(plotlist = all_plots_TSNE)

#Save sce_sub
#saveRDS(sce_sub, "/Volumes/rcc_volume/TNBC/data_analysis/sce_TNBC_Clus_249_sub.rds")
```
## Save sce objects

```{r save_objects, message = FALSE, warning=FALSE}
#Save sce
saveRDS(sce, "/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_Clus_249.rds")
#Save sce_sub
saveRDS(sce_sub, "/Volumes/rcc_volume/TNBC/data_analysis/sce_TNBC_Clus_249_sub.rds")
```

## Save plots as pdf

```{r save_plots}
##IMPORTANT: change to chunk output in console for this last part 

##save plots as pdf (vector graphics)
pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_Tumor_GMMpanCK.pdf",width = 10,height = 8)
GMM_plot_exp+GMM_plot_unc
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_Tumor_GMMpanCKspatial.pdf",width = 12,height = 6)
sp1+sp2+sp3
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_Tumor_HeatmapGMMCC.pdf",width = 15,height = 10)
draw(h)
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_Tumor_HeatmapMixed.pdf",width = 10,height = 12)
dittoHeatmap(sce_mixed, genes = rownames(sce_mixed)[rowData(sce_mixed)$use_channel],
             assay = "exprs", cluster_cols = F, order.by = "GMM_CK", scale = "none",
             heatmap.colors = viridis(100), annot.by = c("GMM_CK","GMM_CK_2","astir_type","cluster","cluster_category"))
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_Tumor_UpsetGMMCC.pdf",width = 8,height = 6)
upset
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_Tumor_UMAPGMMCC.pdf",width = 10,height = 8)
(p1+p2)/(p4+p5)
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_Tumor_TSNEGMMCC.pdf",width = 10,height = 8)
(p6+p7)/(p8+p9)
dev.off()

##IMPORTANT: change back to chunk output inline
```

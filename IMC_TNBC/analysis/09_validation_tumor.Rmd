---
title: "09_validation_prediction"
author: "Lasse Meyer"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Software requirements

```{r lib, message=FALSE,warning=FALSE}
#Data containers
library(SpatialExperiment)
library(SingleCellExperiment)

#Data processing
library(scuttle)
library(scater)
library(scran)
library(imcRtools)

#Data visualization
library(cytomapper)
library(dittoSeq)
library(pheatmap)
library(cowplot)
library(ComplexHeatmap)
library(circlize)

#Utilities
library(tidyverse)
library(openxlsx)
library(stringr)
library(patchwork)
library(parallel)
library(BiocParallel)
library(BiocNeighbors)
library(BiocSingular)
library(tiff)
library(ggrepel)
library(EBImage)
library(viridis)
library(mclust)
library(Rphenograph)
library(igraph)
library(RColorBrewer)
library(foreach)
library(clValid)
library(bluster)
library(psych)
library(corrplot)
library(psych)

#Batch correction
library(batchelor)

#Machine learning
library(caret)
library(caretEnsemble)
```

# Classifier for metacluster prediction

Here, we will train a classifier to predict tumor metacluster in an independent validation dataset (Janas data). For this, we will use the `caret` package.

## 1. Read in data (train)

```{r}
##Load sce
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/07_sce_combined.rds")
```

### Filter for tumor cells

```{r}
sce <- sce[,sce$analysis_cat == "tumor"]
sce$metacluster_combined <- factor(unfactor(sce$metacluster_combined))
sce

## Add more rowData 

rowData(sce)$tumor_metacluster_relevant <- rowData(sce)$clean_target %in% c("CK5","CK7","KRT14","CK8_18","CD15","HLADR","Vimentin","pH3","Ki67","EGFR")
```

## 2. Train the model

```{r}
library(caret)
library(doParallel)

set.seed(22)

# Register parallel backend 
cl <- makePSOCKcluster(5, setup_strategy = "sequential")
registerDoParallel(cl)

#Set seeds for each iteration for parallel processing
seeds <- vector(mode = "list", length = 6)
for (i in 1:5) {
  seeds[[i]] <- sample(5000, 5)
}
seeds[[6]] <- sample(5000, 1) # for the final model


# Randomly split into train and test data
set.seed(22)
trainIndex <- createDataPartition(sce$metacluster_combined, p = 0.75)
train_sce <- sce[,trainIndex$Resample1]
test_sce <- sce[,-trainIndex$Resample1]

# Train data
train_data <- t(assay(train_sce, "exprs")[rowData(train_sce)$tumor_metacluster_relevant,])

# Specify train parameters for 5-fold cross validation
fitControl <- trainControl(method = "cv",
                           number = 5,
                           seeds = seeds)

# Train a random forest model for predicting cell labels
# This call also performs parameter tuning
rffit <- train(x = train_data, 
               y = train_sce$metacluster_combined,
               method = "rf", 
               metric = 'Accuracy',
               tuneLength = 5,
               trControl = fitControl)

rffit
stopCluster(cl)

saveRDS(rffit, "/mnt/rcc_volume/TNBC/data_analysis/randomforest_metacluster_pred_submarker.rds")
```


## Assess feature importance

```{r}
# Classification accuracy during parameter tuning
ggplot(rffit) + 
  geom_errorbar(data = rffit$results,
                aes(ymin = Accuracy - AccuracySD,
                    ymax = Accuracy + AccuracySD),
                width = 0.4) +
    theme_classic(base_size = 15)

# Feature importance
plot(varImp(rffit))
```

## 3. Predict on test data

```{r}
# Select test data
mat_test <- t(assay(test_sce, "exprs")[rowData(test_sce)$tumor_cluster_channel,])

# Predict cell phenotypes in test data
cur_pred <- predict(rffit, 
                    newdata = mat_test)
```

## Assess classifier performance

```{r}
cm <- confusionMatrix(data = cur_pred, 
                      reference = test_sce$metacluster_combined, 
                      mode = "everything")

cm
```


```{r}
library(tidyverse)

data.frame(cm$byClass) %>%
  mutate(class = sub("Class: ", "", rownames(cm$byClass))) %>%
  ggplot() + 
  geom_point(aes(1-Specificity, Sensitivity, 
                 size = Detection.Rate,
                 fill = class),
             shape = 21) + 
  scale_fill_manual(values = metadata(sce)$colors$metacluster_combined, limits = force) +
  theme_classic(base_size = 15) + 
  ylab("Sensitivity (TPR)") +
  xlab("1 - Specificity (FPR)")
```

```{r}
cur_pred <- predict(rffit, 
                    newdata = mat_test, 
                    type = "prob")
cur_pred$truth <- factor(test_sce$metacluster_combined)

cur_plot <- cur_pred %>%
  pivot_longer(cols = 1:11)

ggplot(cur_plot, aes(x = name, y = value, fill = name)) +
  geom_boxplot(outlier.size = 0.5) +
  facet_wrap(. ~ truth, ncol = 1) + 
  scale_fill_manual(values = metadata(sce)$colors$metacluster_combined, limits = force)+
  theme(panel.background = element_blank(), 
        axis.text.x = element_text(angle = 45, hjust = 1))
```


## 4. Read in validation dataset
First, we will read in the `SingleCellExperiment` object containing the cleaned, spillover-corrected single-cell data. 
**Note:** We pre-processed the main cohort together with the validation cohort (including segmentation) to avoid strong batch effects. 

```{r read-data-batch-correction, message=FALSE}
sce_val <- readRDS("/mnt/tnbc_volume/TNBC_all/data_analysis/04_sce_TNBC_Clus_com.rds")
```

Filter sce for validation cohort and tumor cells

```{r filter sce, message=FALSE}
sce_val <- sce_val[,sce_val$analysis_cat == "tumor" & sce_val$TMANr %in% c("TMA21", "TMA26")]
sce_val

# Add rowData 
rowData(sce_val)$tumor_cluster_channel <- rowData(sce)$tumor_cluster_channel
```

Correct survival information 

```{r}
sce_val$status_OS <- ifelse(is.na(sce_val$status_OS) & !is.na(sce_val$OS_months), 0,sce_val$status_OS)
```

## 5. Predict on validation dataset 

```{r}
# Select validation expression matrix
mat_valid <- t(assay(sce_val, "exprs")[rowData(sce_val)$tumor_cluster_channel,])

# Predict metacluster
cell_class <- as.character(predict.train(rffit, 
                                         newdata = mat_valid, 
                                         type = "raw"))

names(cell_class) <- rownames(mat_valid)

table(cell_class)
```

```{r}
cell_prob <- predict.train(rffit, 
                           newdata = mat_valid, 
                           type = "prob")
```


```{r}
library(ggridges)

# Distribution of maximum probabilities
tibble(max_prob = rowMax(as.matrix(cell_prob)),
       type = cell_class) %>%
    ggplot() +
        geom_density_ridges(aes(x = max_prob, y = cell_class, fill = cell_class)) +
        scale_fill_manual(values = metadata(sce)$colors$metacluster_combined, limits = force) +
        theme_classic(base_size = 15) +
        xlab("Maximum probability") +
        ylab("Metacluster") + 
        xlim(c(0,1.2))

# Distribution of probability margins (max - 2.max)



  
margin <- cell_prob %>% rownames_to_column(var = "cell_id") %>% pivot_longer(cols = 2:12, values_to = "prob", names_to = "MC") %>% group_by(cell_id) %>% arrange(desc(prob)) %>% summarise(max = max(prob), second = nth(prob,2), MC = MC) %>% mutate(margin = max - second)

margin$MC <- cell_class[match(margin$cell_id, names(cell_class))]

margin <- margin %>% unique()

ggplot(margin, aes(x=margin, y = MC, fill = MC)) +
        geom_density_ridges() +
        scale_fill_manual(values = metadata(sce)$colors$metacluster_combined, limits = force) +
        theme_classic(base_size = 15) +
        xlab("Probability margin") +
        ylab("Metacluster") + 
        xlim(c(0,1.2))



```

Add to sce 

```{r}
# Store labels in SpatialExperiment onje

sce_val$metacluster_predict <- cell_class[match(sce_val$cell_id, names(cell_class))]

cur_table <- table(sce_val$metacluster_predict, sce_val$PID)

colData(sce_val) %>% as.data.frame %>% filter(PID %in% c("2123","924","458","21","863")) %>% select(PID, pN_simple, pM_simple, status_OS, OS_months) %>% unique()

plotSpatial()

plotSpatial(sce_val[,sce_val$PID == "2123"], 
            node_color_by = "metacluster_predict", 
            img_id = "sample_id", 
            node_size_fix = 2,
            node_shape_by = "analysis_cat")

plotSpatial(sce_val[,sce_val$PID == "2123"], 
            node_color_by = "CK5", 
            assay_type = "exprs",
            img_id = "sample_id", 
            node_size_fix = 2,
            node_shape_by = "analysis_cat")

plotSpatial(sce_val[,sce_val$PID == "2123"], 
            node_color_by = "CK7", 
            assay_type = "exprs",
            img_id = "sample_id", 
            node_size_fix = 2,
            node_shape_by = "analysis_cat")

plotSpatial(sce_val[,sce_val$PID == "2123"], 
            node_color_by = "CK8_18", 
            assay_type = "exprs",
            img_id = "sample_id", 
            node_size_fix = 2,
            node_shape_by = "analysis_cat")



    scale_color_manual(values = metadata(sce)$colors$metacluster_combined, limits = force)
2123


```

## 6. Result analysis 

```{r}
# Focus on basoluminal cells
cur_scat <- t(assay(sce_val,"exprs")) %>% as.data.frame %>% select("CK5","CK7","CK8_18")

cur_scat$metacluster_predict <- sce_val$metacluster_predict[match(rownames(cur_scat),sce_val$cell_id)]
  
#cur_scat <- cur_scat %>% filter(metacluster_predict == "tumor_8")

ggplot(cur_scat, aes(x=CK7, y=CK5, color = metacluster_predict)) +
  geom_point(alpha = 0.5)+
  #stat_density_2d(aes(fill = ..level..), geom="polygon", contour_var = "count")+
  theme_classic()

ggplot(cur_scat, aes(x=CK8_18, y=CK5, color = metacluster_predict)) +
  geom_point(alpha = 0.5)+
  #stat_density_2d(aes(fill = ..level..), geom="polygon", contour_var = "count")+
  theme_classic()
```


```{r}
test <- Cox_df %>% filter(is.na(status_OS) & !is.na(OS_months)) %>% select(12:18)
```







```{r}
library(survival)
library(survminer)

PID_metacluster_predict <- colData(sce_val) %>% as.data.frame() %>% select(metacluster_predict,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_metacluster_predict <- PID_metacluster_predict %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

### Multivariate cox proportional hazard model on multiple covariates (here proportion of phenotypes)
PID_metagroups <- PID_metacluster_predict %>% pivot_wider(id_cols = "PID",names_from = "metacluster_predict",values_from = "fra") %>% column_to_rownames("PID")

## 1. Based on continuous cluster proportions
Cox_df <- PID_metagroups

#add covariates for correction
Cox_df$status_OS <- sce_val$status_OS[match(rownames(Cox_df),sce_val$PID)]
Cox_df$OS_months <- sce_val$OS_months[match(rownames(Cox_df),sce_val$PID)]

Cox_df$age <- sce_val$age[match(rownames(Cox_df),sce_val$PID)]
Cox_df$grade <- factor(sce_val$grade[match(rownames(Cox_df),sce_val$PID)], levels = c("3","2","1"))
Cox_df$pT_simple <- as.factor(sce_val$pT_simple[match(rownames(Cox_df),sce_val$PID)])
Cox_df$pN_simple <- as.factor(sce_val$pN_simple[match(rownames(Cox_df),sce_val$PID)])
Cox_df$pM_simple <- as.factor(sce_val$pM_simple[match(rownames(Cox_df),sce_val$PID)])

is.na(Cox_df$status_OS)

#Based on proportions
covariates <- Cox_df %>% select(-status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple, -tumor_10) %>% colnames

multi_formula <- as.formula(paste("Surv(OS_months, status_OS) ~ age + grade + pT_simple + pN_simple + pM_simple +", paste(covariates, collapse = " + "),"+ tumor_10"))

multi_model <- coxph(multi_formula, data = Cox_df)

multi_res <- summary(multi_model)

plot_df_prop <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))


#Plot hazard ratios
hr_prop <- ggplot(plot_df_prop, aes(x = reorder(group,desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
coord_cartesian(ylim=c(0,50))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("Tumor metacluster_predicts")+
ylab("HR for con_prop")+
theme_classic()+
theme(axis.text.x = element_text(angle = 90))

hr_prop

## 2. Based on categories (mean division of cluster proportions)
Cox_df_mean <- foreach(i = Cox_df %>% select(-status_OS,-OS_months, -status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames,.combine = "cbind")%do%{
Cox_df %>% select(i) %>% mutate(mean = ifelse(Cox_df[,i] > mean(Cox_df[,i]),"B","A")) %>% pull(mean)
}

colnames(Cox_df_mean) <- Cox_df %>% select(-status_OS,-OS_months, -status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames
rownames(Cox_df_mean) <- Cox_df %>% select(-status_OS,-OS_months, -status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% rownames
Cox_df_mean <- as.data.frame(Cox_df_mean)

identical(rownames(Cox_df), rownames(Cox_df_mean))

Cox_df_mean <- cbind(Cox_df_mean, Cox_df %>% select(status_OS,OS_months, status_OS, OS_months, age, grade, pT_simple, pN_simple, pM_simple))

#Based on proportions
covariates <- Cox_df_mean %>% select(-status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames

multi_formula <- as.formula(paste("Surv(OS_months, status_OS) ~ age + grade + pT_simple + pN_simple + pM_simple +", paste(covariates, collapse = " + ")))

multi_model <- coxph(multi_formula, data = Cox_df_mean)

summary(multi_model)

multi_res <- summary(multi_model)

plot_df_mean <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))

#Plot hazard ratios
hr_mean <- ggplot(plot_df_mean, aes(x = reorder(group,desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
coord_cartesian(ylim=c(0,50))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("Tumor metacluster_predicts")+
ylab("HR for mean")+
theme_classic()+
theme(axis.text.x = element_text(angle = 90))

hr_mean

## 3. Based on categories (GMM division of cluster proportions)
Cox_df_GMM <- foreach(i = Cox_df %>% select(-status_OS,-OS_months, -status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames,.combine = "cbind")%do%{
GMM_Cox <- Mclust(Cox_df[,i], G = 2)
as.character(GMM_Cox$classification)
}

colnames(Cox_df_GMM) <- Cox_df %>% select(-status_OS,-OS_months, -status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames
rownames(Cox_df_GMM) <- Cox_df %>% select(-status_OS,-OS_months, -status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% rownames
Cox_df_GMM <- as.data.frame(Cox_df_GMM,stringsAsFactors=TRUE)

identical(rownames(Cox_df), rownames(Cox_df_GMM))

Cox_df_GMM <- cbind(Cox_df_GMM, Cox_df %>% select(status_OS,OS_months, status_OS, OS_months, age, grade, pT_simple, pN_simple, pM_simple))

#Based on proportions
covariates <- Cox_df_GMM %>% select(-status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames

multi_formula <- as.formula(paste("Surv(OS_months, status_OS) ~ age + grade + pT_simple + pN_simple + pM_simple +", paste(covariates, collapse = " + ")))

multi_model <- coxph(multi_formula, data = Cox_df_GMM)

summary(multi_model)

summary(Cox_df_GMM)

multi_res <- summary(multi_model)

plot_df_GMM <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))

#Plot hazard ratios
hr_GMM <- ggplot(plot_df_GMM, aes(x = reorder(group,desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
coord_cartesian(ylim=c(0,50))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("Tumor metacluster_predicts")+
ylab("HR for GMM")+
theme_classic()+
theme(axis.text.x = element_text(angle = 90))

hr_prop/
hr_mean/
hr_GMM
```


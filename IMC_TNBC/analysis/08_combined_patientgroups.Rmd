---
title: "08_combined_patient_grouping"
author: "Lasse Meyer"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Software requirements

```{r lib, message=FALSE,warning=FALSE}
#Data containers
library(SpatialExperiment)
library(SingleCellExperiment)

#Data processing
library(scuttle)
library(scater)
library(scran)
library(imcRtools)

#Data visualization
library(cytomapper)
library(dittoSeq)
library(pheatmap)
library(cowplot)
library(ComplexHeatmap)
library(circlize)

#Utilities
library(tidyverse)
library(openxlsx)
library(stringr)
library(patchwork)
library(parallel)
library(BiocParallel)
library(BiocNeighbors)
library(BiocSingular)
library(tiff)
library(ggrepel)
library(EBImage)
library(viridis)
library(mclust)
library(Rphenograph)
library(igraph)
library(RColorBrewer)
library(foreach)
library(clValid)
library(bluster)
library(psych)
library(corrplot)
library(psych)

#Batch correction
library(batchelor)
```

# Load data

```{r load combined sce}
##Load sce
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/07_sce_combined.rds")
```

# 1. Patient grouping 

## Based on metacluster fractions (tumor)

```{r pgroups, eval = F}
#sce_tumor$metacluster_combined <- unfactor(sce_tumor$metacluster_combined)

PID_metacluster_combined <- colData(sce_tumor) %>% as.data.frame() %>% select(metacluster_combined,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_metacluster_combined <- PID_metacluster_combined %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

PID_metagroups <- PID_metacluster_combined %>% pivot_wider(id_cols = "PID",names_from = "metacluster_combined",values_from = "fra") %>% column_to_rownames("PID")

#double-check that rowsums are 1 
rowSums(PID_metagroups)

#Option: Column-scaled
PID_metagroups_scaled <- scale(as.matrix(PID_metagroups))
col_scaled <- colorRamp2(c(-1, 0, 2, 3), c("#A278FAFF", "#F1E9E7FF", "#FF8061FF", "#FF0000FF"))

### 1. Cluster-testing
library(clValid)
#Internal measures
testCL<- clValid(PID_metagroups,nClust = 2:20,clMethods = c("hierarchical","agnes","kmeans"),validation="internal",metric="euclidean", method = "ward")
summary(testCL)
plot(testCL)

#Stability measures 
testCL_1<- clValid(PID_metagroups,nClust = 2:20,clMethods = c("hierarchical","agnes","kmeans"),validation="stability",metric="euclidean", method = "ward")
summary(testCL_1)
plot(testCL_1, legend = FALSE)

#Selected method: agnes, 8

library(dendextend)
avg_dend_obj_MCP <- as.dendrogram(agnes(PID_metagroups,metric = "euclidean",method = "ward"))
avg_col_dend_MCP <- color_branches(avg_dend_obj_MCP, k = 11)
plot(avg_col_dend_MCP)

# Print heatmap
h_g <- Heatmap(PID_metagroups, name = "Cluster fraction", 
        col = viridis(100),
        cluster_rows = avg_col_dend_MCP,
        row_split = 10,
        clustering_method_columns = "ward.D2",
        clustering_method_rows = "ward.D2")+
  Heatmap(PID_metagroups_scaled, name = "Scaled metacluster fraction", 
        col = col_scaled,
        #cluster_rows = avg_col_dend_MCP,
        #row_split = 8,
        clustering_method_columns = "ward.D2",
        clustering_method_rows = "ward.D2")

h_g <- draw(h_g)
draw(h_g)

#Retrieve PID groups (for agnes)
row_groups <- foreach(i = 1:11, .combine = rbind) %do%{
data.frame(PID = rownames(PID_metagroups[row_order(h_g)[[i]],]), PID_group = i)
}

#Add to sce
sce$PID_metagroups <- row_groups$PID_group[match(sce$PID,row_groups$PID)]
```

```{r}
#Assess survival impact 

library(survival)
library(survminer)

cur_surv <- colData(sce) %>% as.data.frame() %>% 
  select(PID, PID_metagroups, OS_months, DFS_months, status_DFS, status_OS) %>% 
  #mutate(PID_metagroups_2 = ifelse(PID_metagroups == "6","6","Not_6")) %>% unique()
  filter(!PID_metagroups %in% c("1")) %>% 
  unique()

#Plot survival curves
fit <- survfit(Surv(OS_months, status_OS) ~ PID_metagroups, data = cur_surv)
print(fit)

ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          palette = "Set1",
          log.rank.weights = "S2")

fit <- survfit(Surv(DFS_months, status_DFS) ~ PID_metagroups, data = cur_surv)
print(fit)

PID_DFS_1 <- ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #palette = "Set1",
          log.rank.weights = "S2") 

PID_DFS_1
```
```{r coxph dfs}
### Multivariate cox proportional hazard model on multiple covariates (here PID groups)
PID_metagroups <- colData(sce) %>% as.data.frame() %>% select(PID_metagroups,PID) %>% group_by(PID) %>% table() %>% as.data.frame

PID_metagroups <- PID_metagroups %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

PID_metagroups <- PID_metagroups %>% pivot_wider(id_cols = "PID",names_from = "PID_metagroups",values_from = "fra") %>% column_to_rownames("PID")
colnames(PID_metagroups) <- paste0("SCP",colnames(PID_metagroups))

## 1. Based on SCP assignments
Cox_df <- PID_metagroups

#add covariates for correction
Cox_df$status_DFS <- sce$status_DFS[match(rownames(Cox_df),sce$PID)]
Cox_df$DFS_months <- sce$DFS_months[match(rownames(Cox_df),sce$PID)]

Cox_df$age <- sce$age[match(rownames(Cox_df),sce$PID)]
Cox_df$grade <- factor(sce$grade[match(rownames(Cox_df),sce$PID)], levels = c("3","2","1"))
Cox_df$pT_simple <- as.factor(sce$pT_simple[match(rownames(Cox_df),sce$PID)])
Cox_df$pN_simple <- as.factor(sce$pN_simple[match(rownames(Cox_df),sce$PID)])
Cox_df$pM_simple <- as.factor(sce$pM_simple[match(rownames(Cox_df),sce$PID)])

#Based on proportions
covariates <- Cox_df %>% select(-status_DFS,-DFS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple, -SCP1) %>% colnames

multi_formula <- as.formula(paste("Surv(DFS_months, status_DFS) ~ age + grade + pT_simple + pN_simple + pM_simple +", paste(covariates, collapse = " + "), "+ SCP1"))

multi_model <- coxph(multi_formula, data = Cox_df)

multi_res <- summary(multi_model)

plot_df_prop <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))


#Plot hazard ratios
hr_prop <- ggplot(plot_df_prop, aes(x = reorder(group,desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
coord_cartesian(ylim=c(0,50))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("SCP")+
ylab("HR for PID groups")+
theme_classic()+
theme(axis.text.x = element_text(angle = 90))

hr_prop
```

## Based on metacluster densities

```{r}
#create density matrix
PID_metacluster <- colData(sce) %>% as.data.frame() %>% select(metacluster_combined,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_area <- colData(sce) %>% as.data.frame() %>% select(tissue_area,PID) %>% unique() %>% group_by(PID) %>% mutate(mean_tissue_area = mean(tissue_area))

PID_metacluster$mean_tissue_area <- PID_area$mean_tissue_area[match(PID_metacluster$PID, PID_area$PID)]
PID_metacluster <- PID_metacluster %>% group_by(PID) %>% mutate(density = Freq/(mean_tissue_area/1000000))  

PID_metagroups <- PID_metacluster %>% pivot_wider(id_cols = "PID",names_from = "metacluster_combined",values_from = "density") %>% column_to_rownames("PID")

#Option: Column-scaled
PID_metagroups_scaled <- scale(as.matrix(PID_metagroups))
col_scaled <- colorRamp2(c(-1, 0, 2, 3), c("#A278FAFF", "#F1E9E7FF", "#FF8061FF", "#FF0000FF"))

### 1. Cluster-testing
library(clValid)
#Internal measures
testCL<- clValid(PID_metagroups,nClust = 2:20,clMethods = c("hierarchical","agnes","kmeans"),validation="internal",metric="euclidean", method = "ward")
summary(testCL)
plot(testCL)

#Stability measures 
testCL_1<- clValid(PID_metagroups,nClust = 2:20,clMethods = c("hierarchical","agnes","kmeans"),validation="stability",metric="euclidean", method = "ward")
summary(testCL_1)
plot(testCL_1, legend = FALSE)

#Selected method: kmeans, 12

### 2. Plot heatmap 
library(dendextend)
avg_dend_obj_MCP <- as.dendrogram(diana(PID_metagroups,metric = "euclidean"))
avg_col_dend_MCP <- color_branches(avg_dend_obj_MCP, k = 9)
plot(avg_col_dend_MCP)

set.seed(22)
h_g <- Heatmap(PID_metagroups, name = "Cluster fraction", 
        col = viridis(100),
        #cluster_rows = avg_col_dend_MCP,
        #row_split = 9,
        row_km = 14,
        row_km_repeats = 1000,
        clustering_method_columns = "ward.D2",
        clustering_method_rows = "ward.D2",
        cluster_row_slices = FALSE)+
  Heatmap(PID_metagroups_scaled, name = "Scaled metacluster fraction", 
        col = col_scaled,
        #cluster_rows = avg_col_dend_MCP,
        #row_split = 8,
        clustering_method_columns = "ward.D2",
        clustering_method_rows = "ward.D2")

h_g <- draw(h_g)
draw(h_g)

### 3. Retrieve PID groups
row_groups <- foreach(i = 1:14, .combine = rbind) %do%{
data.frame(PID = rownames(PID_metagroups[row_order(h_g)[[i]],]), PID_group = i)
}

#Add to sce
sce$PID_metagroups_density <- row_groups$PID_group[match(sce$PID,row_groups$PID)]
```

```{r}
#Assess survival impact 

library(survival)
library(survminer)

cur_surv <- colData(sce) %>% as.data.frame() %>% select(PID, PID_metagroups_density, OS_months, DFS_months, status_DFS, status_OS) %>% filter(!PID_metagroups_density %in% c("1")) %>% unique()

#Plot survival curves
fit <- survfit(Surv(OS_months, status_OS) ~ PID_metagroups_density, data = cur_surv)
print(fit)

ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #palette = "Set1",
          log.rank.weights = "n")

fit <- survfit(Surv(DFS_months, status_DFS) ~ PID_metagroups_density, data = cur_surv)
print(fit)

ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #palette = "Set1",
          log.rank.weights = "n")
```


## Based on tumor community fractions

```{r pgroups, eval = F}
#sce_tumor$spatial_metacommunity

tumor_sce <- sce[,sce$analysis_cat == "tumor"]

PID_cellular_neighborhood <- colData(tumor_sce) %>% as.data.frame() %>% select(spatial_metacommunity,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_cellular_neighborhood <- PID_cellular_neighborhood %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

PID_metagroups <- PID_cellular_neighborhood %>% pivot_wider(id_cols = "PID",names_from = "spatial_metacommunity",values_from = "fra") %>% column_to_rownames("PID")

PID_metagroups <- PID_metagroups[complete.cases(PID_metagroups),]

#double-check that rowsums are 1 
rowSums(PID_metagroups)

#Option: Column-scaled
PID_metagroups_scaled <- scale(as.matrix(PID_metagroups))
col_scaled <- colorRamp2(c(-1, 0, 2, 3), c("#A278FAFF", "#F1E9E7FF", "#FF8061FF", "#FF0000FF"))

### 1. Cluster-testing
library(clValid)
#Internal measures
testCL<- clValid(PID_metagroups,nClust = 2:20,clMethods = c("hierarchical","agnes","kmeans","pam"),validation="internal",metric="euclidean", method = "ward")
summary(testCL)
plot(testCL, legend = FALSE)


#Stability measures 
testCL_1<- clValid(PID_metagroups,nClust = 2:20,clMethods = c("hierarchical","agnes","kmeans","pam"),validation="stability",metric="euclidean", method = "ward")
summary(testCL_1)
plot(testCL_1, legend = FALSE)

#Selected method: kmeans, 9

library(dendextend)
avg_dend_obj_MCP <- as.dendrogram(agnes(PID_metagroups,metric = "euclidean",method = "ward"))
avg_col_dend_MCP <- color_branches(avg_dend_obj_MCP, k = 11)
plot(avg_col_dend_MCP)

# Print heatmap
h_g <- Heatmap(PID_metagroups, name = "Community fraction", 
        col = viridis(100),
        cluster_rows = avg_col_dend_MCP,
        row_split = 11,
        #row_km = 11, 
        #row_km_repeats = 1000,
        clustering_method_columns = "ward.D2",
        clustering_method_rows = "ward.D2",
        cluster_row_slices = FALSE, 
        show_row_names = FALSE)#+
  #Heatmap(PID_metagroups_scaled, name = "Scaled metacluster fraction", 
        #col = col_scaled,
        #cluster_rows = avg_col_dend_MCP,
        #row_split = 8,
        #clustering_method_columns = "ward.D2",
        #clustering_method_rows = "ward.D2")

h_g <- draw(h_g)
draw(h_g)

#Retrieve PID groups
row_groups <- foreach(i = 1:11, .combine = rbind) %do%{
data.frame(PID = rownames(PID_metagroups[row_order(h_g)[[i]],]), PID_group = i)
}

#Add to sce
sce$PID_SC_groups <- row_groups$PID_group[match(sce$PID,row_groups$PID)]
```

```{r}
#Assess survival impact 
library(survival)
library(survminer)

cur_surv <- colData(sce) %>% as.data.frame() %>% select(PID, PID_SC_groups, OS_months, DFS_months, status_DFS, status_OS) %>% filter(PID_SC_groups %in% c("4","10")) %>%
  unique()


#Plot survival curves
fit <- survfit(Surv(OS_months, status_OS) ~ PID_SC_groups, data = cur_surv)
print(fit)

ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #palette = "Set1",
          log.rank.weights = "S2")

fit <- survfit(Surv(DFS_months, status_DFS) ~ PID_SC_groups, data = cur_surv)
print(fit)

ggsurvplot(fit,
          pval = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_classic(), # Change ggplot2 theme
          #palette = "Set1",
          log.rank.weights = "S2")

```

```{r}
### Multivariate cox proportional hazard model on multiple covariates (here PID groups)
PID_metagroups <- colData(sce) %>% as.data.frame() %>% select(PID_SC_groups,PID) %>% group_by(PID) %>% table() %>% as.data.frame

PID_metagroups <- PID_metagroups %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

PID_metagroups <- PID_metagroups %>% pivot_wider(id_cols = "PID",names_from = "PID_SC_groups",values_from = "fra") %>% column_to_rownames("PID")
colnames(PID_metagroups) <- paste0("SCP",colnames(PID_metagroups))

## 1. Based on SCP assignments
Cox_df <- PID_metagroups

#add covariates for correction
Cox_df$status_DFS <- sce$status_DFS[match(rownames(Cox_df),sce$PID)]
Cox_df$DFS_months <- sce$DFS_months[match(rownames(Cox_df),sce$PID)]

Cox_df$age <- sce$age[match(rownames(Cox_df),sce$PID)]
Cox_df$grade <- factor(sce$grade[match(rownames(Cox_df),sce$PID)], levels = c("3","2","1"))
Cox_df$pT_simple <- as.factor(sce$pT_simple[match(rownames(Cox_df),sce$PID)])
Cox_df$pN_simple <- as.factor(sce$pN_simple[match(rownames(Cox_df),sce$PID)])
Cox_df$pM_simple <- as.factor(sce$pM_simple[match(rownames(Cox_df),sce$PID)])

#Based on proportions
covariates <- Cox_df %>% select(-status_DFS,-DFS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple, -SCP1) %>% colnames

multi_formula <- as.formula(paste("Surv(DFS_months, status_DFS) ~ age + grade + pT_simple + pN_simple + pM_simple +", paste(covariates, collapse = " + "), "+ SCP1"))

#multi_formula <- as.formula(paste("Surv(DFS_months, status_DFS) ~" paste(covariates, collapse = " + "), "+ SCP8"))

multi_model <- coxph(multi_formula, data = Cox_df)

multi_res <- summary(multi_model)

plot_df_prop <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))


#Plot hazard ratios
hr_prop <- ggplot(plot_df_prop, aes(x = reorder(group,desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
coord_cartesian(ylim=c(0,50))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("SCP")+
ylab("HR for PID groups")+
theme_classic()+
theme(axis.text.x = element_text(angle = 90))

hr_prop
```

## Based on cellular neighborhood densities

```{r}
#create density matrix
PID_metacluster <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_area <- colData(sce) %>% as.data.frame() %>% select(tissue_area,PID) %>% unique() %>% group_by(PID) %>% mutate(mean_tissue_area = mean(tissue_area))

PID_metacluster$mean_tissue_area <- PID_area$mean_tissue_area[match(PID_metacluster$PID, PID_area$PID)]
PID_metacluster <- PID_metacluster %>% group_by(PID) %>% mutate(density = Freq/(mean_tissue_area/1000000))  

PID_metagroups <- PID_metacluster %>% pivot_wider(id_cols = "PID",names_from = "cellular_neighborhood",values_from = "density") %>% column_to_rownames("PID")

#Option: Column-scaled
PID_metagroups_scaled <- scale(as.matrix(PID_metagroups))
col_scaled <- colorRamp2(c(-1, 0, 2, 3), c("#A278FAFF", "#F1E9E7FF", "#FF8061FF", "#FF0000FF"))

### 1. Cluster-testing
library(clValid)
#Internal measures
testCL<- clValid(PID_metagroups,nClust = 2:20,clMethods = c("hierarchical","agnes","kmeans"),validation="internal",metric="euclidean", method = "ward")
summary(testCL)
plot(testCL)

#Stability measures 
testCL_1<- clValid(PID_metagroups,nClust = 2:20,clMethods = c("hierarchical","agnes","kmeans"),validation="stability",metric="euclidean", method = "ward")
summary(testCL_1)
plot(testCL_1, legend = FALSE)

#Selected method: kmeans, 6

### 2. Plot heatmap 
library(dendextend)
avg_dend_obj_MCP <- as.dendrogram(diana(PID_metagroups,metric = "euclidean"))
avg_col_dend_MCP <- color_branches(avg_dend_obj_MCP, k = 9)
plot(avg_col_dend_MCP)

set.seed(23)
h_g <- Heatmap(PID_metagroups, name = "Cluster fraction", 
        col = viridis(100),
        #cluster_rows = avg_col_dend_MCP,
        #row_split = 8,
        row_km = 13,
        row_km_repeats = 100,
        clustering_method_columns = "ward.D2",
        clustering_method_rows = "ward.D2",
        cluster_row_slices = FALSE)+
  Heatmap(PID_metagroups_scaled, name = "Scaled metacluster fraction", 
        col = col_scaled,
        #cluster_rows = avg_col_dend_MCP,
        #row_split = 8,
        clustering_method_columns = "ward.D2",
        clustering_method_rows = "ward.D2")

h_g <- draw(h_g)
draw(h_g)

### 3. Retrieve PID groups
row_groups <- foreach(i = 1:13, .combine = rbind) %do%{
data.frame(PID = rownames(PID_metagroups[row_order(h_g)[[i]],]), PID_group = i)
}

#Add to sce
sce$PID_CN_density <- row_groups$PID_group[match(sce$PID,row_groups$PID)]
```

## Compare between patient grouping 

```{r}
library(patchwork)
library(pheatmap)
library(gridExtra)

tab1 <- table(paste("Meta_Fra_", sce$PID_metagroups), 
              paste("Meta_Dens", sce$PID_metagroups_density))
tab2 <- table(paste("Meta_Fra_", sce$PID_metagroups), 
              paste("CN_Fra", sce$PID_CN_groups))
tab3 <- table(paste("Meta_Fra_", sce$PID_metagroups), 
              paste("CN_Dens", sce$PID_CN_density))

pheatmap(log2(tab1 + 1), color = viridis(100), name = "log2(count+1)")
pheatmap(log2(tab2 + 1), color = viridis(100),name = "log2(count+1)")
pheatmap(log2(tab3 + 1), color = viridis(100),name = "log2(count+1)")

```
```{r save_objects, message = FALSE, warning=FALSE}
#Save sce
saveRDS(sce, "/mnt/rcc_volume/TNBC/data_analysis/08_sce_PIDgroup.rds")
```

# 2. Patient group visualization

## Immune scores

```{r}
# mixing pheno
#mixing_pheno <- colData(sce) %>% as.data.frame() %>% select(PID_metagroups,mixing_pheno) %>% group_by(PID_metagroups) %>% table() %>% as.data.frame
#mixing_pheno <- mixing_pheno %>% group_by(PID_metagroups) %>% mutate(fra = Freq/sum(Freq)) 
#mixing_pheno <- mixing_pheno %>% select(-Freq) %>% pivot_wider(id_cols = PID_metagroups,names_from = mixing_pheno,values_from = fra) %>% column_to_rownames("PID_metagroups")

# ## mixing pheno per group
# mixing_group <- colData(sce) %>% as.data.frame() %>% select(PID,PID_metagroups,mixing_pheno_merg) %>% unique() %>% select(-PID) %>% group_by(mixing_pheno_merg) %>% table() %>% as.data.frame
# mixing_group <- mixing_group %>% group_by(mixing_pheno_merg) %>% mutate(fra = Freq/sum(Freq)) 
# ggplot(mixing_group, aes(x = mixing_pheno_merg, y = fra, fill = PID_metagroups))+
#   geom_bar(stat = "identity", color = "black")+
#   theme_classic()+
#   ylab("Fraction of PID")+
#   scale_fill_manual(values = metadata(sce)$colors$PID_metagroups)

```

## Shannon diversity index

```{r shannon div, message = FALSE, warning= FALSE}
library(vegan)
library(ggpubr)

PID_metacluster_combined <- colData(sce) %>% as.data.frame() %>% select(metacluster_combined,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_metacluster_combined <- PID_metacluster_combined %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

shannon_df <- PID_metacluster_combined %>% pivot_wider(id_cols = "PID",names_from = "metacluster_combined",values_from = "Freq") %>% column_to_rownames("PID")

## 1.For fraction-based
#Calculate shannon-diversity/equitability for each patient separately

shannon_plot <- data.frame(shannon_div = diversity(shannon_df),
                           number = length(unique(sce$metacluster_combined)),
                           shannon_equi = (diversity(shannon_df)/log(length(unique(sce$metacluster_combined)))),
                           PID_group = as.character(sce$PID_SC_groups[match(rownames(shannon_df),sce$PID)]))

shannon_plot <- shannon_plot %>% filter(!is.na(PID_group))

kw_shannon <- compare_means(formula = shannon_equi ~ PID_group,method = "kruskal.test",p.adjust.method = "BH",shannon_plot)

#Plot shannon equitability for PID groups and compare
ggplot(shannon_plot,aes(x=reorder(PID_group,shannon_equi),y=shannon_equi))+#color=PID_group))+
  geom_boxplot(outlier.colour = NA)+
  geom_jitter(aes(color = PID_group), size = 3, position=position_jitter(w=0.1,h=0.1))+
  theme_classic()+
  xlab("PID_group")+
  ylab("Shannon Equitability Index")+
  ggtitle(paste("p(Kruskal-Wallis) = ",round(kw_shannon$p,5)))+
  scale_color_manual(values = metadata(sce)$colors$PID_SC_groups)


shannon_mean <- shannon_plot %>% group_by(PID_group) %>% summarize(mean = mean(shannon_equi))
```

## CATALYST-based visualization 

We will first convert the sce into a CATALYST-compatible format.

```{r CATALYST}
library(CATALYST)
# save spe in CATALYST-compatible object with renamed colData entries and 
# new metadata information
sce_cat <- sce 
sce_cat$sample_id <- factor(sce$PID)
sce_cat$cluster_id <- factor(sce$PID_SC_groups)

#add celltype information to metadata
metadata(sce_cat)$cluster_codes <- data.frame(PID_SC_groups = factor(sce_cat$PID_SC_groups))
```

```{r CATALYST pbmds and clrDR, message=FALSE}
# MDS pseudobulk by metacluster
pbMDS(sce_cat, by = "cluster_id", 
      features = rownames(sce_cat)[rowData(sce_cat)$use_channel], 
      label_by = "cluster_id", k = "PID_SC_groups") +
  scale_color_manual(values = metadata(sce_cat)$colors$PID_SC_groups)+
  theme_classic()

# MDS pseudobulk by metacluster
pbMDS(sce_cat, by = "both", 
      features = rownames(sce_cat)[rowData(sce_cat)$use_channel], 
      k = "PID_SC_groups",
      size_by = TRUE) +
  #scale_color_manual(values = metadata(sce_cat)$colors$metacluster)+
  theme_classic()

# CLR on metacluster proportions across samples
clrDR(sce_cat, dr = "PCA", 
      by = "cluster_id", k = "PID_SC_groups", 
      label_by = "cluster_id", arrow_col = "PID", 
      #point_pal = metadata(sce_cat)$colors$metacluster, 
      arrows = FALSE) +
  scale_color_manual(values = metadata(sce_cat)$colors$PID)+
  guides(color = "none")+
  theme_classic()
```
## Rich heatmap visualization

```{r heatmap sce_1, message=FALSE, warning=FALSE}

### 1. Heatmap body ###

# Tumor communities 
PID_spatial_tumor <- colData(tumor_sce) %>% as.data.frame() %>% select(spatial_metacommunity,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_spatial_tumor <- PID_spatial_tumor %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))
PID_spatial_tumor$PID_SC_groups <- sce$PID_SC_groups[match(PID_spatial_tumor$PID, sce$PID)]
PID_spatial_tumor <- PID_spatial_tumor[!is.na(PID_spatial_tumor$PID_SC_groups),]
  
hb <- PID_spatial_tumor %>% ungroup %>% select(spatial_metacommunity,PID_SC_groups,fra) %>% group_by(PID_SC_groups, spatial_metacommunity) %>% summarize(mean = mean(fra)) %>% pivot_wider(names_from = spatial_metacommunity, values_from = mean) %>% column_to_rownames("PID_SC_groups")

hb_scaled <- scale(as.matrix(hb))

# TME communities 
TME_sce <- stroma_sce

PID_spatial_TME <- colData(TME_sce) %>% as.data.frame() %>% select(spatial_metacommunity,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_spatial_TME <- PID_spatial_TME %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))
PID_spatial_TME$PID_SC_groups <- sce$PID_SC_groups[match(PID_spatial_TME$PID, sce$PID)]
PID_spatial_TME <- PID_spatial_TME[!is.na(PID_spatial_TME$PID_SC_groups),]
PID_spatial_TME[is.na(PID_spatial_TME$fra),]$fra <- 0

hb_TME <- PID_spatial_TME %>% ungroup %>% select(spatial_metacommunity,PID_SC_groups,fra) %>% group_by(PID_SC_groups, spatial_metacommunity) %>% summarize(mean = mean(fra)) %>% pivot_wider(names_from = spatial_metacommunity, values_from = mean) %>% column_to_rownames("PID_SC_groups")

hb_TME_scaled <- scale(as.matrix(hb_TME))

# Heatmap body colors 
col_min_max <- colorRamp2(c(0,0.2,0.4,0.6,0.8), c("#440154FF", "#33628DFF", "#28AE80FF", "#DBE318FF", "#FDE725FF"))
col_scaled <- colorRamp2(c(-1, 0, 2, 3), c("#A278FAFF", "#F1E9E7FF", "#FF8061FF", "#FF0000FF"))
col <- colorRamp2(c(0,0.5,1), c("#440154FF","#20928CFF","#FDE725FF")) 

### 2. Heatmap annotation ###

###2.1 Row - Metadata features

# Annotation dataframe 
anno <- colData(sce) %>% as.data.frame %>% select(PID_SC_groups) %>% unique() %>% filter(!is.na(PID_SC_groups))

rownames(anno) <- anno$PID_SC_groups

anno$PID_SC_groups <- factor(sort(anno$PID_SC_groups))
  
# Proportion of grade per cluster
grade <- colData(sce) %>% as.data.frame() %>% select(PID_SC_groups,grade) %>% group_by(PID_SC_groups) %>% table() %>% as.data.frame
grade <- grade %>% group_by(PID_SC_groups) %>% mutate(fra = Freq/sum(Freq)) 
grade <- grade %>% select(-Freq) %>% pivot_wider(id_cols = PID_SC_groups,names_from = grade,values_from = fra) %>% column_to_rownames("PID_SC_groups")

# Proportion of pT stage per cluster
pT <- colData(sce) %>% as.data.frame() %>% select(PID_SC_groups,pT_simple) %>% group_by(PID_SC_groups) %>% table() %>% as.data.frame
pT <- pT %>% group_by(PID_SC_groups) %>% mutate(fra = Freq/sum(Freq)) 
pT <- pT %>% select(-Freq) %>% pivot_wider(id_cols = PID_SC_groups,names_from = pT_simple,values_from = fra) %>% column_to_rownames("PID_SC_groups")

# Proportion of pN stage per cluster
pN <- colData(sce) %>% as.data.frame() %>% select(PID_SC_groups,pN_simple) %>% group_by(PID_SC_groups) %>% table() %>% as.data.frame
pN <- pN %>% group_by(PID_SC_groups) %>% mutate(fra = Freq/sum(Freq)) 
pN <- pN %>% select(-Freq) %>% pivot_wider(id_cols = PID_SC_groups,names_from = pN_simple,values_from = fra) %>% column_to_rownames("PID_SC_groups")

# Number of contributing patients
cluster_PID <- colData(sce) %>% as.data.frame() %>% select(PID_SC_groups,PID) %>% group_by(PID_SC_groups) %>% table() %>% as.data.frame
n_PID <- cluster_PID %>% filter(Freq>0) %>% group_by(PID_SC_groups) %>% count(name = "n_PID") %>% column_to_rownames("PID_SC_groups")


# Define color scheme for PID groups 
PID_SC_groups_col <- setNames(colorRampPalette(brewer.pal(8, "Set1"))(length(anno$PID_SC_groups)), anno$PID_SC_groups)                   

metadata(sce)$colors$PID_SC_groups <- PID_SC_groups_col

# Metadata annotation
ha_meta <- HeatmapAnnotation(PID_SC_groups = anno_simple(unfactor(anno$PID_SC_groups), pch = unfactor(anno$PID_SC_groups),border=TRUE,col=metadata(sce)$colors$PID_SC_groups),
                            n_PID = anno_barplot(n_PID, width = unit(10, "mm"),gp = gpar(fill = "#440154FF")),
                            grade = anno_barplot(grade, width = unit(10, "mm"),gp = gpar(fill = metadata(sce)$colors$grade)),
                            pT = anno_barplot(pT, width = unit(10, "mm"),gp = gpar(fill = metadata(sce)$colors$pT_simple)),
                            pN = anno_barplot(pN, width = unit(10, "mm"),gp = gpar(fill = metadata(sce)$colors$pN_simple)),
                            border = TRUE, 
                            annotation_name_rot = 90,
                            gap = unit(1,"mm"),
                            which = "row")

###2.2 Row - Score features

#Proportion of spatial CD8 pheno
spatial_CD8_pheno
spatial_CD8_pheno <- spatial_CD8_pheno[names(metadata(sce)$colors$spatial_CD8_pheno)]

#Shannon diversity index
shannon_mean <- shannon_mean %>% filter(!is.na(PID_group))
#shannon_mean[rownames(spatial_CD8_pheno)]

shannon_mean <- shannon_mean %>% arrange(as.numeric(PID_group))

## Create color scheme for shannon
shannon_col <- colorRamp2(c(min(shannon_mean$mean),median(shannon_mean$mean),max(shannon_mean$mean)), c(brewer.pal(3,"YlOrRd")[1],brewer.pal(3,"YlOrRd")[2],brewer.pal(3,"YlOrRd")[3]))
metadata(sce)$colors$shannon_col <- shannon_col

# Score annotation
ha_score <- HeatmapAnnotation(spatial_CD8_pheno = anno_barplot(spatial_CD8_pheno, width = unit(15, "mm"),gp = gpar(fill = metadata(sce)$colors$spatial_CD8_pheno)),
                              shannon_mean = anno_simple(shannon_mean$mean, border = TRUE, col=metadata(sce)$colors$shannon_col),
                            border = TRUE,
                            annotation_name_rot = 90,
                            gap = unit(1,"mm"),
                            which = "row")

ha_score + NULL

### 3. Plot heatmap ###
h <- Heatmap(hb,
        col = col_min_max,
        name = "MC_fraction",
        row_title = NULL, 
        show_column_names =  TRUE, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2",
        row_split = anno$PID_SC_groups,
        cluster_row_slices = FALSE)+
  Heatmap(hb_TME,
        col = col_min_max,
        name = "MC_fraction",
        row_title = NULL, 
        show_column_names =  TRUE, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2",
        row_split = anno$PID_SC_groups,
        cluster_row_slices = FALSE)+
  ha_meta+
  ha_score

h_scaled <- Heatmap(hb_scaled,
        col = col_scaled,
        name = "MC_fraction",
        row_title = NULL, 
        show_column_names =  TRUE, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2",
        row_split = anno$PID_SC_groups,
        cluster_row_slices = FALSE)+
  Heatmap(hb_TME_scaled,
        col = col_scaled,
        name = "MC_fraction",
        row_title = NULL, 
        show_column_names =  TRUE, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2",
        row_split = anno$PID_SC_groups,
        cluster_row_slices = FALSE)+
  ha_meta+
  ha_score

  #ha_score

draw(h_scaled)

#Create legends for annotation 

#lgd <- Legend(title = "mixing_pheno", at = colnames(mixing_pheno), 
#              legend_gp = gpar(fill = metadata(sce)$colors$mixing_pheno))

#lgd_1 <- Legend(title = "spatial_CD8_pheno", at = colnames(spatial_CD8_pheno), 
#              legend_gp = gpar(fill = metadata(sce)$colors$spatial_CD8_pheno))

#lgd_2 <- Legend(col_fun = shannon_col, title = "shannon equitability")

# Draw heatmap 
#draw(h,annotation_legend_list = list(lgd,lgd_1,lgd_2))
```

# 3. Image visualization

## Save plots as pdf

```{r save_plots}
##IMPORTANT: change to chunk output in console for this last part 

##save plots as pdf (vector graphics)
pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/08_PIDgroup/TNBC_PIDgroup_CNDens_Heatmap.pdf",width = 9,height = 10)
h_g
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/08_PIDgroup/TNBC_PIDgroup_MetaclusterFra_Kaplan_DFS.pdf",width = 8,height = 5, onefile = FALSE)
PID_DFS_1
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/08_PIDgroup/TNBC_PIDgroup_MetaclusterFra_RichHeatmap.pdf",width = 12,height = 6)
draw(h,annotation_legend_list = list(lgd,lgd_1,lgd_2))
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/08_PIDgroup/TNBC_PIDgroup_MetaclusterFra_CoxModel_DFS.pdf",width = 6,height = 5, onefile = FALSE)
hr_prop
dev.off()
```




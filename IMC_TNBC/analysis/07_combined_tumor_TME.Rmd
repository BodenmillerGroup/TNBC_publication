---
title: "08_combined_tumor_TME"
author: "Lasse Meyer"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Software requirements

```{r lib, message=FALSE,warning=FALSE}
#Data containers
library(SpatialExperiment)
library(SingleCellExperiment)

#Data processing
library(scuttle)
library(scater)
library(scran)
library(imcRtools)

#Data visualization
library(cytomapper)
library(dittoSeq)
library(pheatmap)
library(cowplot)
library(ComplexHeatmap)

#Utilities
library(tidyverse)
library(openxlsx)
library(stringr)
library(patchwork)
library(parallel)
library(BiocParallel)
library(BiocNeighbors)
library(BiocSingular)
library(tiff)
library(ggrepel)
library(EBImage)
library(viridis)
library(mclust)
library(Rphenograph)
library(igraph)
library(RColorBrewer)
library(foreach)
library(clValid)
library(bluster)
library(psych)
library(corrplot)
library(psych)

#Batch correction
library(batchelor)
```

# Single-cell analysis - Pipeline 4 - Combined analysis

Here, we will perform the first combined analysis steps for tumor and TME phenotypes.

## Load data

```{r load data, message = FALSE, warning = FALSE}
#tumor sce
sce_tumor <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/05_sce_TNBC_tumor.rds") 
sce_tumor

#TME sce
sce_TME <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/06_sce_TNBC_TME.rds") 
sce_TME

#sce with all cells
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/04_sce_TNBC_Clus.rds")
sce
```

## 1. Data integration

## Combine tumor and TME cluster/metacluster/color information

```{r combine tumor TME, message=FALSE,warning=FALSE}
## 1. Cluster 
tumor_cluster <- colData(sce_tumor) %>% as.data.frame %>% mutate(cluster_combined = paste0("tumor_",sce_tumor$cluster_110)) %>% select(cell_id,cluster_combined)

TME_cluster <- colData(sce_TME) %>% as.data.frame %>% mutate(cluster_combined = paste0("TME_",sce_TME$cluster_130)) %>% select(cell_id,cluster_combined)

tumor_TME_cluster <- rbind(tumor_cluster, TME_cluster)

### Add to sce
sce$cluster_combined <- tumor_TME_cluster$cluster_combined[match(sce$cell_id, tumor_TME_cluster$cell_id)]
sce$cluster_combined <- factor(sce$cluster_combined)


## 2. Metacluster 
tumor_metacluster <- colData(sce_tumor) %>% as.data.frame %>% mutate(metacluster_combined = paste0("tumor_",sce_tumor$metacluster)) %>% select(cell_id,metacluster_combined)

TME_metacluster <- colData(sce_TME) %>% as.data.frame %>% mutate(metacluster_combined = sce_TME$immune_metacluster) %>% select(cell_id,metacluster_combined)

tumor_TME_metacluster <- rbind(tumor_metacluster, TME_metacluster)

### Add to sce
sce$metacluster_combined <- tumor_TME_metacluster$metacluster_combined[match(sce$cell_id, tumor_TME_metacluster$cell_id)]
sce$metacluster_combined <- factor(sce$metacluster_combined)

## 3. Color mapping
names(metadata(sce_tumor)$colors$cluster_110) <- paste0("tumor_", names(metadata(sce_tumor)$colors$cluster_110))
names(metadata(sce_TME)$colors$cluster_130) <- paste0("TME_", names(metadata(sce_TME)$colors$cluster_130))

names(metadata(sce_tumor)$colors$metacluster) <- paste0("tumor_", names(metadata(sce_tumor)$colors$metacluster))

#Add to sce 
metadata(sce)$colors$cluster_combined <- c(metadata(sce_tumor)$colors$cluster_110, metadata(sce_TME)$colors$cluster_130)
metadata(sce)$colors$metacluster_combined <- c(metadata(sce_tumor)$colors$metacluster, metadata(sce_TME)$colors$immune_metacluster)
```

```{r save_objects, message = FALSE, warning=FALSE}
#Save sce
saveRDS(sce, "/mnt/rcc_volume/TNBC/data_analysis/07_sce_combined.rds")
```

## Overlay tumor and TME cluster colors onto combined tSNE

```{r combined tSNE}
#Read subsampled sce from pipeline 1
sce_sub <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/04_sce_SUB_TNBC_Clus.rds")

#Add cluster_combined info
sce_sub$cluster_combined <- sce$cluster_combined[match(sce_sub$cell_id, sce$cell_id)]
sce_sub$metacluster_combined <- sce$metacluster_combined[match(sce_sub$cell_id, sce$cell_id)]

#Plot TSNE
plotReducedDim(sce_sub, dimred = "TSNE", colour_by = "metacluster_combined",shape_by = "analysis_cat")+
  scale_color_manual(values = metadata(sce)$colors$metacluster_combined)

plotReducedDim(sce_sub, dimred = "TSNE", colour_by = "cluster_combined",shape_by = "analysis_cat")+
    scale_color_manual(values = metadata(sce)$colors$cluster_combined)
```

# 2. Image visualization

## Load masks and images 

```{r load images}
#Load images and masks
images <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/images_segtest.rds")
masks <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/masks_segtest_4.rds")
```

## Plot cell features onto image

```{r image viz, eval =F}
set.seed(22)
img_random <- sample(seq_len(length(images)), 10)

img_files <- list.files("/mnt/rcc_volume/TNBC/img/")
img_selected <- c(which(str_detect(img_files ,"ZTMA249_ID_320_CX8Y10")),which(str_detect(img_files ,"ZTMA249_ID_289_CX1Y7")),which(str_detect(img_files ,"ZTMA249_ID_36_AX4Y5")),which(str_detect(img_files ,"ZTMA249_ID_7_AX7Y1")),which(str_detect(img_files ,"ZTMA249_ID_220_BX4Y13")),which(str_detect(img_files ,"ZTMA249_ID_271_CX7Y4")),which(str_detect(img_files ,"ZTMA249_ID_82_AX2Y11")), which(str_detect(img_files ,"ZTMA249_ID_179_BX3Y8")), which(str_detect(img_files ,"ZTMA249_ID_183_BX7Y8")), which(str_detect(img_files ,"ZTMA174_B08.26868_79_AX7Y10")))

img_ids <- c(img_selected,img_random)

#Plot masks of cell phenotypes
plotCells(mask = masks[img_ids], 
          object = sce,
          img_id = "sample_id", 
          cell_id = "ObjectNumber", 
          colour_by = "metacluster_combined",
          outline_by = "analysis_cat",
          colour = list(metacluster_combined = metadata(sce)$colors$metacluster_combined),
          thick = TRUE)
```


# 3. Spatial analysis

# 3.1 Cellular neighborhoods

## Detect CN

In the next section, we will define cellular neighborhoods by clustering cells based on their neighboring cells.

```{r neighborhood-1, message=FALSE, warning=FALSE}
library(imcRtools)
library(bluster)

##Load sce
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/07_sce_combined.rds")

# Build spatial knn graph
sce <- buildSpatialGraph(sce, img_id = "sample_id", type = "knn", k = 20, 
                         coords = c("Pos_X",  "Pos_Y"),
                         #max_dist = 30,
                         BPPARAM = MulticoreParam(progressbar = TRUE))

colPairNames(sce) #now includes knn_interaction_graph

# Aggregate across neighbors
sce <- aggregateNeighbors(sce, colPairName = "knn_interaction_graph", 
                              aggregate_by = "metadata", count_by = "metacluster_combined")

head(sce$aggregatedNeighbors)

# Perform cluster sweep for kmeans (silhouette width, wcss)
set.seed(22)
clust_list <- lapply(2:20, function(k){
  cur_km <- kmeans(sce$aggregatedNeighbors, centers = k)
  return(list(wss = sum(cur_km$withinss),
           clusters = cur_km$cluster))
})

sil <- vapply(lapply(clust_list, `[[`, 2), 
              function(x) mean(approxSilhouette(sce$aggregatedNeighbors, x)$width), 
              0)

ggplot(data.frame(k = 2:20, sil = sil))+
  geom_point(aes(k, sil, col = sil))+
  geom_line(aes(k, sil,col=sil))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  xlab("k")+
  ylab("Mean silhouette width")+
  scale_color_continuous(type = "viridis")

ggplot(data.frame(k = 2:20,wss = unlist(lapply(clust_list, `[[`, 1))))+
  geom_point(aes(k, wss, col = wss))+
  geom_line(aes(k, wss, col = wss))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("k")+
  ylab("Total WCSS")+
  scale_color_continuous(type = "viridis")

# Select 9 clusters
set.seed(22)
cur_clusters <- kmeans(sce$aggregatedNeighbors, centers = 9, nstart = 100)$cluster

sce$cellular_neighborhood <- as.factor(cur_clusters)
```

## Heatmap visualization

Quick and easy heatmap to visualize the proportion of metaclusters in each CN

```{r}
library(tidyverse)
for_plot <- colData(sce) %>% as_tibble() %>%
    group_by(cellular_neighborhood, metacluster_combined) %>%
    summarize(count = n()) %>%
    mutate(freq = count / sum(count)) %>%
    pivot_wider(id_cols = cellular_neighborhood, names_from = metacluster_combined, 
                values_from = freq, values_fill = 0) %>%
    ungroup() %>%
    select(-cellular_neighborhood)

pheatmap(for_plot, color = colorRampPalette(c("dark blue", "white", "dark red"))(100), 
         scale = "column")
```
Rich heatmap visualization 

```{r rich heatmap}
### 1. Heatmap body ###

# Visualize cell type proportions of cellular neighborhoods
cn_prop_wide <- colData(sce) %>% as_tibble() %>%
    group_by(cellular_neighborhood, metacluster_combined) %>%
    summarize(count = n()) %>%
    mutate(freq = count / sum(count)) %>%
    pivot_wider(id_cols = cellular_neighborhood, names_from = metacluster_combined, 
                values_from = freq, values_fill = 0) %>%
    ungroup() %>% column_to_rownames(var = "cellular_neighborhood")


#Option: Column-scaled
cn_prop_wide_scaled <- scale(as.matrix(cn_prop_wide))

#Heatmap body color
col_main = viridis(100)
col_scaled <- colorRamp2(c(-1, 0, 2, 3), c("#A278FAFF", "#F1E9E7FF", "#FF8061FF", "#FF0000FF"))


### 2. Heatmap annotation ###

#Number of cells per cluster 
n_cells <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood) %>% group_by(cellular_neighborhood) %>% count() 

# Proportion of grade per cluster
grade <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood,grade) %>% group_by(cellular_neighborhood) %>% table() %>% as.data.frame
grade <- grade %>% group_by(cellular_neighborhood) %>% mutate(fra = Freq/sum(Freq)) 
grade <- grade %>% select(-Freq) %>% pivot_wider(id_cols = cellular_neighborhood,names_from = grade,values_from = fra) %>% column_to_rownames("cellular_neighborhood")

# Proportion of pT stage per cluster
pT <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood,pT_simple) %>% group_by(cellular_neighborhood) %>% table() %>% as.data.frame
pT <- pT %>% group_by(cellular_neighborhood) %>% mutate(fra = Freq/sum(Freq)) 
pT <- pT %>% select(-Freq) %>% pivot_wider(id_cols = cellular_neighborhood,names_from = pT_simple,values_from = fra) %>% column_to_rownames("cellular_neighborhood")

# Proportion of pN stage per cluster
pN <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood,pN_simple) %>% group_by(cellular_neighborhood) %>% table() %>% as.data.frame
pN <- pN %>% group_by(cellular_neighborhood) %>% mutate(fra = Freq/sum(Freq)) 
pN <- pN %>% select(-Freq) %>% pivot_wider(id_cols = cellular_neighborhood,names_from = pN_simple,values_from = fra) %>% column_to_rownames("cellular_neighborhood")

# Number of contributing patients
cluster_PID <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood,PID) %>% group_by(cellular_neighborhood) %>% table() %>% as.data.frame
n_PID <- cluster_PID %>% filter(Freq>0) %>% group_by(cellular_neighborhood) %>% count(name = "n_PID") %>% column_to_rownames("cellular_neighborhood")

# Define colors for cellular neighborhood 
cn_col <- setNames(colorRampPalette(brewer.pal(9, "Accent"))(length(unique(sce$cellular_neighborhood))), sort(unique(sce$cellular_neighborhood)))         

metadata(sce)$colors$cellular_neighborhood <- cn_col

# Metadata annotation
ha_meta <- HeatmapAnnotation(cellular_neighborhood = anno_simple(unfactor(ncells$cellular_neighborhood),pch = unfactor(ncells$cellular_neighborhood), border=TRUE,col=metadata(sce)$colors$cellular_neighborhood),
                            n_cells = anno_barplot(ncells$n, width = unit(10, "mm"),gp = gpar(fill = "#440154FF")),
                            n_PID = anno_barplot(n_PID, width = unit(10, "mm"),gp = gpar(fill = "#440154FF")),
                            grade = anno_barplot(grade, width = unit(10, "mm"),gp = gpar(fill = metadata(sce)$colors$grade)),
                            pT = anno_barplot(pT, width = unit(10, "mm"),gp = gpar(fill = metadata(sce)$colors$pT_simple)),
                            pN = anno_barplot(pN, width = unit(10, "mm"),gp = gpar(fill = metadata(sce)$colors$pN_simple)),
                            border = TRUE, 
                            annotation_name_rot = 90,
                            gap = unit(1,"mm"),
                            which = "row")

### 3. Plot heatmap ###
h <- Heatmap(cn_prop_wide,
        name = "MC proportion",
        col = col_main,
        row_title = NULL,
        clustering_method_columns = "ward.D2",
        clustering_method_rows = "ward.D2")+
  Heatmap(cn_prop_wide_scaled,
          col = col_scaled,
          name = "scaled MC proportion")+
  ha_meta

draw(h)
```
## Patient visualization

```{r}
## 1. Fraction of CN per PID
dittoBarPlot(sce, var = "cellular_neighborhood", group.by = "PID")+
  scale_fill_manual(values = metadata(sce)$colors$cellular_neighborhood)+
  theme(axis.text.x = element_blank())

## 2. Fraction of PID per CN
dittoBarPlot(sce, var = "PID", group.by = "cellular_neighborhood")+
  scale_fill_manual(values = metadata(sce)$colors$PID)+
  guides(fill = "none")
```

## Image visualization

We can now visualize a few example images and highlight the CN

```{r neighborhood-2}
set.seed(22)
cur_sam <- sample(unique(sce$sample_id), 6)

# Metacluster
plotSpatial(sce[,sce$sample_id %in% cur_sam], 
            node_color_by = "metacluster_combined", 
            img_id = "sample_id", 
            node_size_fix = 0.5,
            node_shape_by = "analysis_cat") +
    scale_color_manual(values = metadata(sce)$colors$metacluster_combined)

# Cellular Neighborhoods
plotSpatial(sce[,sce$sample_id %in% cur_sam], 
            node_color_by = "cellular_neighborhood", 
            img_id = "sample_id", 
            node_size_fix = 0.5) +
    scale_color_manual(values = metadata(sce)$colors$cellular_neighborhood)

```
## Survival analysis 

### For OS on CN proportions

```{r cox}
library(survival)
library(survminer)

PID_cellular_neighborhood <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_cellular_neighborhood <- PID_cellular_neighborhood %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

### Multivariate cox proportional hazard model on multiple covariates (here proportion of phenotypes)
PID_metagroups <- PID_cellular_neighborhood %>% pivot_wider(id_cols = "PID",names_from = "cellular_neighborhood",values_from = "fra") %>% column_to_rownames("PID")
colnames(PID_metagroups) <- paste0("CN",colnames(PID_metagroups))

## 1. Based on continuous cluster proportions
Cox_df <- PID_metagroups

#add covariates for correction
Cox_df$status_OS <- sce$status_OS[match(rownames(Cox_df),sce$PID)]
Cox_df$OS_months <- sce$OS_months[match(rownames(Cox_df),sce$PID)]

Cox_df$age <- sce$age[match(rownames(Cox_df),sce$PID)]
Cox_df$grade <- factor(sce$grade[match(rownames(Cox_df),sce$PID)], levels = c("3","2","1"))
Cox_df$pT_simple <- as.factor(sce$pT_simple[match(rownames(Cox_df),sce$PID)])
Cox_df$pN_simple <- as.factor(sce$pN_simple[match(rownames(Cox_df),sce$PID)])
Cox_df$pM_simple <- as.factor(sce$pM_simple[match(rownames(Cox_df),sce$PID)])

#Based on proportions
covariates <- Cox_df %>% select(-status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple, -CN4) %>% colnames

multi_formula <- as.formula(paste("Surv(OS_months, status_OS) ~ age + grade + pT_simple + pN_simple + pM_simple +", paste(covariates, collapse = " + "),"+ CN4"))

multi_model <- coxph(multi_formula, data = Cox_df)

multi_res <- summary(multi_model)

plot_df_prop <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))


#Plot hazard ratios
hr_prop <- ggplot(plot_df_prop, aes(x = reorder(group,desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
coord_cartesian(ylim=c(0,50))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("CN")+
ylab("HR for con_prop")+
theme_classic()+
theme(axis.text.x = element_text(angle = 90))

hr_prop

## 2. Based on categories (mean division of cluster proportions)
Cox_df_mean <- foreach(i = Cox_df %>% select(-status_OS,-OS_months, -status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames,.combine = "cbind")%do%{
Cox_df %>% select(i) %>% mutate(mean = ifelse(Cox_df[,i] > mean(Cox_df[,i]),"B","A")) %>% pull(mean)
}

colnames(Cox_df_mean) <- Cox_df %>% select(-status_OS,-OS_months, -status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames
rownames(Cox_df_mean) <- Cox_df %>% select(-status_OS,-OS_months, -status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% rownames
Cox_df_mean <- as.data.frame(Cox_df_mean)

identical(rownames(Cox_df), rownames(Cox_df_mean))

Cox_df_mean <- cbind(Cox_df_mean, Cox_df %>% select(status_OS,OS_months, status_OS, OS_months, age, grade, pT_simple, pN_simple, pM_simple))

#Based on proportions
covariates <- Cox_df_mean %>% select(-status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames

multi_formula <- as.formula(paste("Surv(OS_months, status_OS) ~ age + grade + pT_simple + pN_simple + pM_simple +", paste(covariates, collapse = " + ")))

multi_model <- coxph(multi_formula, data = Cox_df_mean)

summary(multi_model)

multi_res <- summary(multi_model)

plot_df_mean <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))

#Plot hazard ratios
hr_mean <- ggplot(plot_df_mean, aes(x = reorder(group,desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
coord_cartesian(ylim=c(0,50))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("CN")+
ylab("HR for mean")+
theme_classic()+
theme(axis.text.x = element_text(angle = 90))

hr_mean

## 3. Based on categories (GMM division of cluster proportions)
Cox_df_GMM <- foreach(i = Cox_df %>% select(-status_OS,-OS_months, -status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames,.combine = "cbind")%do%{
GMM_Cox <- Mclust(Cox_df[,i], G = 2)
as.character(GMM_Cox$classification)
}

colnames(Cox_df_GMM) <- Cox_df %>% select(-status_OS,-OS_months, -status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames
rownames(Cox_df_GMM) <- Cox_df %>% select(-status_OS,-OS_months, -status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% rownames
Cox_df_GMM <- as.data.frame(Cox_df_GMM,stringsAsFactors=TRUE)

identical(rownames(Cox_df), rownames(Cox_df_GMM))

Cox_df_GMM <- cbind(Cox_df_GMM, Cox_df %>% select(status_OS,OS_months, status_OS, OS_months, age, grade, pT_simple, pN_simple, pM_simple))

#Based on proportions
covariates <- Cox_df_GMM %>% select(-status_OS,-OS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames

multi_formula <- as.formula(paste("Surv(OS_months, status_OS) ~ age + grade + pT_simple + pN_simple + pM_simple +", paste(covariates, collapse = " + ")))

multi_model <- coxph(multi_formula, data = Cox_df_GMM)

summary(multi_model)

summary(Cox_df_GMM)

multi_res <- summary(multi_model)

plot_df_GMM <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))

#Plot hazard ratios
hr_GMM <- ggplot(plot_df_GMM, aes(x = reorder(group,desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
coord_cartesian(ylim=c(0,50))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("CN")+
ylab("HR for GMM")+
theme_classic()+
theme(axis.text.x = element_text(angle = 90))

hr_prop/
hr_mean/
hr_GMM
```
### For DFS on CN proportions

```{r cox}
library(survival)
library(survminer)

PID_cellular_neighborhood <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_cellular_neighborhood <- PID_cellular_neighborhood %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

### Multivariate cox proportional hazard model on multiple covariates (here proportion of phenotypes)
PID_metagroups <- PID_cellular_neighborhood %>% pivot_wider(id_cols = "PID",names_from = "cellular_neighborhood",values_from = "fra") %>% column_to_rownames("PID")
colnames(PID_metagroups) <- paste0("CN",colnames(PID_metagroups))

## 1. Based on continuous cluster proportions
Cox_df <- PID_metagroups

#add covariates for correction
Cox_df$status_DFS <- sce$status_DFS[match(rownames(Cox_df),sce$PID)]
Cox_df$DFS_months <- sce$DFS_months[match(rownames(Cox_df),sce$PID)]

Cox_df$age <- sce$age[match(rownames(Cox_df),sce$PID)]
Cox_df$grade <- factor(sce$grade[match(rownames(Cox_df),sce$PID)], levels = c("3","2","1"))
Cox_df$pT_simple <- as.factor(sce$pT_simple[match(rownames(Cox_df),sce$PID)])
Cox_df$pN_simple <- as.factor(sce$pN_simple[match(rownames(Cox_df),sce$PID)])
Cox_df$pM_simple <- as.factor(sce$pM_simple[match(rownames(Cox_df),sce$PID)])

#Based on proportions
covariates <- Cox_df %>% select(-status_DFS,-DFS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple, -CN4) %>% colnames

multi_formula <- as.formula(paste("Surv(DFS_months, status_DFS) ~ age + grade + pT_simple + pN_simple + pM_simple +", paste(covariates, collapse = " + "),"+ CN4"))

multi_model <- coxph(multi_formula, data = Cox_df)

multi_res <- summary(multi_model)

plot_df_prop <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))


#Plot hazard ratios
hr_prop <- ggplot(plot_df_prop, aes(x = reorder(group,desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
coord_cartesian(ylim=c(0,50))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("CN")+
ylab("HR for con_prop")+
theme_classic()+
theme(axis.text.x = element_text(angle = 90))

hr_prop

## 2. Based on categories (mean division of cluster proportions)
Cox_df_mean <- foreach(i = Cox_df %>% select(-status_DFS,-DFS_months, -status_DFS,-DFS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames,.combine = "cbind")%do%{
Cox_df %>% select(i) %>% mutate(mean = ifelse(Cox_df[,i] > mean(Cox_df[,i]),"B","A")) %>% pull(mean)
}

colnames(Cox_df_mean) <- Cox_df %>% select(-status_DFS,-DFS_months, -status_DFS,-DFS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames
rownames(Cox_df_mean) <- Cox_df %>% select(-status_DFS,-DFS_months, -status_DFS,-DFS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% rownames
Cox_df_mean <- as.data.frame(Cox_df_mean)

identical(rownames(Cox_df), rownames(Cox_df_mean))

Cox_df_mean <- cbind(Cox_df_mean, Cox_df %>% select(status_DFS,DFS_months, status_DFS, DFS_months, age, grade, pT_simple, pN_simple, pM_simple))

#Based on proportions
covariates <- Cox_df_mean %>% select(-status_DFS,-DFS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames

multi_formula <- as.formula(paste("Surv(DFS_months, status_DFS) ~ age + grade + pT_simple + pN_simple + pM_simple +", paste(covariates, collapse = " + ")))

multi_model <- coxph(multi_formula, data = Cox_df_mean)

summary(multi_model)

multi_res <- summary(multi_model)

plot_df_mean <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))

#Plot hazard ratios
hr_mean <- ggplot(plot_df_mean, aes(x = reorder(group,desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
coord_cartesian(ylim=c(0,50))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("CN")+
ylab("HR for mean")+
theme_classic()+
theme(axis.text.x = element_text(angle = 90))

hr_mean

## 3. Based on categories (GMM division of cluster proportions)
Cox_df_GMM <- foreach(i = Cox_df %>% select(-status_DFS,-DFS_months, -status_DFS,-DFS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames,.combine = "cbind")%do%{
GMM_Cox <- Mclust(Cox_df[,i], G = 2)
as.character(GMM_Cox$classification)
}

colnames(Cox_df_GMM) <- Cox_df %>% select(-status_DFS,-DFS_months, -status_DFS,-DFS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames
rownames(Cox_df_GMM) <- Cox_df %>% select(-status_DFS,-DFS_months, -status_DFS,-DFS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% rownames
Cox_df_GMM <- as.data.frame(Cox_df_GMM,stringsAsFactors=TRUE)

identical(rownames(Cox_df), rownames(Cox_df_GMM))

Cox_df_GMM <- cbind(Cox_df_GMM, Cox_df %>% select(status_DFS,DFS_months, status_DFS, DFS_months, age, grade, pT_simple, pN_simple, pM_simple))

#Based on proportions
covariates <- Cox_df_GMM %>% select(-status_DFS,-DFS_months, -age, -grade, -pT_simple, -pN_simple, -pM_simple) %>% colnames

multi_formula <- as.formula(paste("Surv(DFS_months, status_DFS) ~ age + grade + pT_simple + pN_simple + pM_simple +", paste(covariates, collapse = " + ")))

multi_model <- coxph(multi_formula, data = Cox_df_GMM)

summary(multi_model)

summary(Cox_df_GMM)

multi_res <- summary(multi_model)

plot_df_GMM <- data.frame(group = rownames(multi_res$coefficients),
                      p_value = signif(multi_res$coefficients[,"Pr(>|z|)"],2),
                      HR = signif(multi_res$coefficients[,"exp(coef)"],2),
                      CI_low = signif(multi_res$conf.int[,"lower .95"],2),
                      CI_high = signif(multi_res$conf.int[,"upper .95"],2),
                      wald_test = signif(multi_res$waldtest["pvalue"],2))

#Plot hazard ratios
hr_GMM <- ggplot(plot_df_GMM, aes(x = reorder(group,desc(HR)), y = HR, color = p_value < 0.05))+
geom_point(size = 4)+
geom_errorbar(aes(ymax = CI_high, ymin = CI_low))+
coord_cartesian(ylim=c(0,50))+
geom_hline(yintercept = 1,color = "black",linetype = "dashed")+
scale_color_brewer(palette = "Set1")+
xlab("CN")+
ylab("HR for GMM")+
theme_classic()+
theme(axis.text.x = element_text(angle = 90))

hr_prop/
hr_mean/
hr_GMM
```

# 3.2 Spatial contexts

## Detect SC

Here, we will define spatial contexts based on the previous CN assignments.

```{r detectSpatialContext}
# Generate k-nearest neighbor graph for SC detection (k=40) 
sce <- buildSpatialGraph(sce, 
                         img_id = "sample_id", 
                         type = "knn", 
                         name = "knn_spatialcontext_graph", 
                         k = 40,
                         BPPARAM = MulticoreParam(progressbar = TRUE))

# Aggregate based on clustered_neighbors
sce <- aggregateNeighbors(sce, 
                          colPairName = "knn_spatialcontext_graph",
                          aggregate_by = "metadata",
                          count_by = "cellular_neighborhood",
                          name = "aggregatedNeighborhood")

# Detect spatial contexts
sce <- detectSpatialContext(sce, 
                            entry = "aggregatedNeighborhood",
                            threshold = 0.90,
                            name = "spatial_context")

length(unique(sce$spatial_context))
```

## Filter SC 

```{r}
#Abundant SC - at least 20 PID and 500 cells
sce <- filterSpatialContext(sce, group_by = "PID", group_threshold = 20, cells_threshold = 500)

length(unique(sce$spatial_context_filtered))

# Define SC color scheme and add to metadata
col_SC <- setNames(colorRampPalette(brewer.pal(8, "Accent"))(length(unique(sce$spatial_context_filtered))), 
                   sort(unique(sce$spatial_context_filtered)))

metadata(sce)$colors$col_SC <- col_SC 
```

## Plot SC Graph 

```{r}
plotSpatialContext(sce, entry = "spatial_context_filtered", 
                   group_by = "PID", node_color_by = "name", node_size_by = "n_cells")+
  scale_color_manual(values = metadata(sce)$colors$col_SC)


plotSpatialContext(sce, entry = "spatial_context_filtered", 
                   group_by = "PID", node_color_by = "n_group", node_size_by = "n_cells")+
  scale_color_viridis()
```

## Image visualization 

```{r}
set.seed(22)
cur_sam <- sample(unique(sce$sample_id), 6)

# Cellular Neighborhoods
plotSpatial(sce[,sce$sample_id %in% cur_sam], 
            node_color_by = "cellular_neighborhood", 
            img_id = "sample_id", 
            node_size_fix = 0.5) +
    scale_color_manual(values = metadata(sce)$colors$cellular_neighborhood)

# Spatial Contexts
plotSpatial(sce[,sce$sample_id %in% cur_sam], 
            node_color_by = "spatial_context_filtered", 
            img_id = "sample_id", 
            node_size_fix = 0.5) +
    scale_color_manual(values = metadata(sce)$colors$col_SC)
```

## Patient visualization

```{r}
## 1. Fraction of CN per PID
dittoBarPlot(sce, var = "spatial_context_filtered", group.by = "PID")+
  scale_fill_manual(values = metadata(sce)$colors$col_SC)+
  theme(axis.text.x = element_blank())

## 2. Fraction of PID per CN
dittoBarPlot(sce, var = "PID", group.by = "spatial_context_filtered")+
  scale_fill_manual(values = metadata(sce)$colors$PID)+
  guides(fill = "none")
```

## Survival analysis

### Lasso - OS

```{r lasso OS clusters}
library(glmnet)
library(broom) 

PID_SC <- colData(sce) %>% as.data.frame() %>% select(spatial_context_filtered,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_SC <- PID_SC %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))
PID_SC <- PID_SC %>% pivot_wider(id_cols = "PID",names_from = "spatial_context_filtered",values_from = "fra") %>% column_to_rownames("PID")

### Lasso regularization
### Multivariate cox proportional hazard model on multiple covariates (here proportion of phenotypes)

## 1. Based on continuous cluster proportions
Cox_df <- PID_SC

#add covariates for correction
Cox_df$status_OS <- sce$status_OS[match(rownames(Cox_df),sce$PID)]
Cox_df$OS_months <- sce$OS_months[match(rownames(Cox_df),sce$PID)]

Cox_df$age <- sce$age[match(rownames(Cox_df),sce$PID)]
Cox_df$grade <- factor(sce$grade[match(rownames(Cox_df),sce$PID)], levels = c("3","2","1"))
Cox_df$pT_simple <- as.factor(sce$pT_simple[match(rownames(Cox_df),sce$PID)])
Cox_df$pN_simple <- as.factor(sce$pN_simple[match(rownames(Cox_df),sce$PID)])
Cox_df$pM_simple <- as.factor(sce$pM_simple[match(rownames(Cox_df),sce$PID)]) #remove from model otherwise coefficients are shrinked to 0 for all others? 

## Run lasso regularized coxph model
Cox_df <- Cox_df[complete.cases(Cox_df),] #only have complete rows as input

x <- data.matrix(Cox_df %>% select(-status_OS,-OS_months)) #predictor variables

y <- Surv(time = Cox_df$OS_months, event = Cox_df$status_OS) #response variables

set.seed(22)
cv.fit <- cv.glmnet(x, y, family="cox", type.measure = "C")
plot(cv.fit)

fit <- glmnet(x, y, family="cox")

coef(fit, s = cv.fit$lambda.min)

# ## Run lasso 100 times and average error curves to be more robust
# MSEs <- NULL
# for (i in 1:100){
#                  cv <- cv.glmnet(x, y, family="cox", type.measure = "C")
#                  MSEs <- cbind(MSEs, cv$cvm)
#              }
# 
# rownames(MSEs) <- cv$lambda
# lambda.min <- as.numeric(names(which.min(rowMeans(MSEs))))
# 
# fit <- glmnet(x, y, family="cox")
# coef(fit, s = lambda.min)

#Extract output
lasso_df <- tidy(coef(fit, s = cv.fit$lambda.min))
colnames(lasso_df) <- c("predictor","column","coef")

#Visualize hazard ratios
ggplot(lasso_df, aes(x = reorder(predictor,-exp(coef)), y = exp(coef))) +
  geom_point(size = 4, aes(color = exp(coef)>1)) +
  geom_hline(yintercept = 1,color = "black")+
  scale_y_continuous(trans="log")+
  ylab("Lasso HR")+
  xlab("Predictors")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle("OS")+
  scale_color_brewer(palette = "Set1")
  scale_color_manual(values = metadata(sce)$colors$cluster_110, limits = force, na.value = "black")
```
### Lasso - DFS

```{r lasso OS clusters}
library(glmnet)
library(broom) 

PID_SC <- colData(sce) %>% as.data.frame() %>% select(spatial_context_filtered,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_SC <- PID_SC %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))
PID_SC <- PID_SC %>% pivot_wider(id_cols = "PID",names_from = "spatial_context_filtered",values_from = "fra") %>% column_to_rownames("PID")

### Lasso regularization
### Multivariate cox proportional hazard model on multiple covariates (here proportion of phenotypes)

## 1. Based on continuous cluster proportions
Cox_df <- PID_SC

#add covariates for correction
Cox_df$status_DFS <- sce$status_DFS[match(rownames(Cox_df),sce$PID)]
Cox_df$DFS_months <- sce$DFS_months[match(rownames(Cox_df),sce$PID)]

Cox_df$age <- sce$age[match(rownames(Cox_df),sce$PID)]
Cox_df$grade <- factor(sce$grade[match(rownames(Cox_df),sce$PID)], levels = c("3","2","1"))
Cox_df$pT_simple <- as.factor(sce$pT_simple[match(rownames(Cox_df),sce$PID)])
Cox_df$pN_simple <- as.factor(sce$pN_simple[match(rownames(Cox_df),sce$PID)])
Cox_df$pM_simple <- as.factor(sce$pM_simple[match(rownames(Cox_df),sce$PID)]) #remove from model otherwise coefficients are shrinked to 0 for all others? 

## Run lasso regularized coxph model
Cox_df <- Cox_df[complete.cases(Cox_df),] #only have complete rows as input

Cox_df <- Cox_df %>% filter(DFS_months != 0)

x <- data.matrix(Cox_df %>% select(-status_DFS,-DFS_months)) #predictor variables

y <- Surv(time = Cox_df$DFS_months, event = Cox_df$status_DFS) #response variables

set.seed(22)
cv.fit <- cv.glmnet(x, y, family="cox", type.measure = "C")
plot(cv.fit)

fit <- glmnet(x, y, family="cox")

coef(fit, s = cv.fit$lambda.min)

# ## Run lasso 100 times and average error curves to be more robust
# MSEs <- NULL
# for (i in 1:100){
#                  cv <- cv.glmnet(x, y, family="cox", type.measure = "C")
#                  MSEs <- cbind(MSEs, cv$cvm)
#              }
# 
# rownames(MSEs) <- cv$lambda
# lambda.min <- as.numeric(names(which.min(rowMeans(MSEs))))
# 
# fit <- glmnet(x, y, family="cox")
# coef(fit, s = lambda.min)

#Extract output
lasso_df <- tidy(coef(fit, s = cv.fit$lambda.min))
colnames(lasso_df) <- c("predictor","column","coef")

#Visualize hazard ratios
ggplot(lasso_df, aes(x = reorder(predictor,-exp(coef)), y = exp(coef))) +
  geom_point(size = 4, aes(color = exp(coef)>1)) +
  geom_hline(yintercept = 1,color = "black")+
  scale_y_continuous(trans="log")+
  ylab("Lasso HR")+
  xlab("Predictors")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90))+
  ggtitle("DFS")+
  scale_color_brewer(palette = "Set1")
  scale_color_manual(values = metadata(sce)$colors$cluster_110, limits = force, na.value = "black")

```

# 3.3 Spatial communities 

# 3.4 Interaction testing

A) Classical method: "How many neighbors of type B does a cell of type A have on average?"

```{r interaction testing}
library(scales)
out <- testInteractions(sce, 
                        method = "classic",
                        group_by = "PID",
                        label = "metacluster_combined", 
                        colPairName = "neighborhood",
                        BPPARAM = MulticoreParam())
head(out)
```

```{r viz interaction}
library(scales)
out_viz <- out %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    summarize(sum_sigval = sum(sigval, na.rm = TRUE)) %>% 
  pivot_wider(id_cols = "from_label", names_from = "to_label", values_from = "sum_sigval") %>%
  column_to_rownames("from_label")

Heatmap(out_viz,
        name = "Interaction_score",
        row_title = "from_label",
        column_title = "to_label",
        cluster_columns = FALSE,
        cluster_rows = FALSE)
```
B) Patch method - "What fraction of cells of type A have at least a given number of neighbors of type B?"

```{r}
out <- testInteractions(sce, 
                        group_by = "sample_id",
                        label = "metacluster_combined", 
                        colPairName = "neighborhood",
                        method = "patch", 
                        patch_size = 5,
                        BPPARAM = MulticoreParam())
head(out)
```

```{r}
library(scales)
out_viz <- out %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    summarize(sum_sigval = sum(sigval, na.rm = TRUE)) %>% 
  pivot_wider(id_cols = "from_label", names_from = "to_label", values_from = "sum_sigval") %>%
  column_to_rownames("from_label")

Heatmap(out_viz,
        name = "Interaction_score",
        row_title = "from_label",
        column_title = "to_label",
        cluster_columns = FALSE,
        cluster_rows = FALSE)
```

# 3.5 Patch detection




---
title: "08_combined_tumor_TME"
author: "Lasse Meyer"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Software requirements

```{r lib, message=FALSE,warning=FALSE}
#Data containers
library(SpatialExperiment)
library(SingleCellExperiment)

#Data processing
library(scuttle)
library(scater)
library(scran)
library(imcRtools)

#Data visualization
library(cytomapper)
library(dittoSeq)
library(pheatmap)
library(cowplot)
library(ComplexHeatmap)

#Utilities
library(tidyverse)
library(openxlsx)
library(stringr)
library(patchwork)
library(parallel)
library(BiocParallel)
library(BiocNeighbors)
library(BiocSingular)
library(tiff)
library(ggrepel)
library(EBImage)
library(viridis)
library(mclust)
library(Rphenograph)
library(igraph)
library(RColorBrewer)
library(foreach)
library(clValid)
library(bluster)
library(psych)
library(corrplot)
library(psych)

#Batch correction
library(batchelor)
```

# Single-cell analysis - Pipeline 4 - Combined analysis

Here, we will perform the first combined analysis steps for tumor and TME phenotypes.

## Load data and color mapping of phenotypes

```{r load data, message = FALSE, warning = FALSE}
#Set global seed
set.seed(22)

#tumor sce
sce_tumor <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_249_Tumor_CC_ClusterChannelClus_k.rds") 
sce_tumor

#TME sce
sce_TME <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_249_TME_CC_ClusterChannelClus_k.rds") 
sce_TME

#sce with all cells
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_Clus_249.rds")
sce

##Load color mapping of tumor and TME phenotypes
col_TMEpheno <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/color_TMEpheno.rds")
col_tumorpheno <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/color_Tumorpheno.rds")
```

## Combine tumor and TME phenotypes information and PID groups

```{r combine tumor TME, message=FALSE,warning=FALSE}
#Combine cluster phenotypes from tumor and TME (add "TME" character to distinguish)
tumor_pheno <- colData(sce_tumor) %>% as.data.frame %>% mutate(cluster_combined = sce_tumor$cluster_100) %>% select(cluster_combined,cluster_names) %>% rownames_to_column(var = "cell_id")
TME_pheno <- colData(sce_TME) %>% as.data.frame %>% mutate(cluster_combined = paste0("TME_",sce_TME$cluster_50_renamed)) %>% select(cluster_combined,cluster_names) %>% rownames_to_column(var = "cell_id")
tumor_TME_pheno <- rbind(tumor_pheno, TME_pheno)

sce$cluster_combined <- tumor_TME_pheno$cluster_combined[match(rownames(colData(sce)),tumor_TME_pheno$cell_id)]
sce$cluster_names <- tumor_TME_pheno$cluster_names[match(rownames(colData(sce)),tumor_TME_pheno$cell_id)]
sce$cluster_origin <- ifelse(str_detect(unfactor(sce$cluster_combined),"TME"),"02_TME","01_tumor")

#Add metaclusters by cell! to be updated
sce$metacluster <- sce_tumor$metacluster[match(rownames(colData(sce)),rownames(colData(sce_tumor)))]

#Add PID groups 
sce$PID_groups <- sce_tumor$PID_groups[match(sce$sample_id,sce_tumor$sample_id)]

no_PID_group <- colData(sce)[is.na(sce$PID_groups),] %>% as.data.frame %>% select(sample_id) %>% unique() #Undefined PID_groups - "ZTMA249.1_ZTMA249_ID_212_BX4Y12_123" "ZTMA249.3_ZTMA249_ID_329_CX1Y12_339" - no panck+ cells detected

#Combine color mapping
names(col_TMEpheno$cluster_50_renamed) <- paste0("TME_",names(col_TMEpheno$cluster_50_renamed))
col_clusters <- list("cluster_combined" = c(col_TMEpheno$cluster_50_renamed,col_tumorpheno$cluster_100), "metacluster" = col_tumorpheno$metaclusters)

#Add PID identifier to sce
sample_meta <- read.csv("/mnt/rcc_volume/TNBC/data_analysis/03_data/ZTMA249_metadata_processed.csv")
colData(sce)$ID <- str_split(colData(sce)$sample_id,"_",simplify = TRUE)[,4]
colData(sce)$PID <- sample_meta$PID[match(colData(sce)$ID,sample_meta$ID_Number)]

##Save sce and colors 
#saveRDS(sce, "/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_249_08.rds")
saveRDS(col_clusters, "/mnt/rcc_volume/TNBC/data_analysis/color_phenocombined.rds")
```

## Overlay tumor and TME cluster colors onto combined tSNE

```{r combined tSNE}
#Read subsampled sce from pipeline 1
sce_sub <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_Clus_249_sub.rds")

#Add cluster_combined info
sce_sub$cluster_combined <- sce$cluster_combined[match(rownames(colData(sce_sub)),rownames(colData(sce)))]
sce_sub$cluster_origin <- sce$cluster_origin[match(rownames(colData(sce_sub)),rownames(colData(sce)))]
sce_sub$metacluster <- sce$metacluster[match(rownames(colData(sce_sub)),rownames(colData(sce)))]

#Plot TSNE
plotReducedDim(sce_sub, dimred = "TSNE", colour_by = "metacluster",shape_by = "cluster_origin")+
  scale_color_manual(values = col_clusters$metacluster)
```
## Load masks and images 

```{r masks images}
#Load images and masks
images <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/images_segtest.rds")
masks <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/masks_segtest_4.rds")

#subset images and masks for TMA249
images <- images[str_detect(mcols(images)$sample_id,"ZTMA249")]
masks <- masks[str_detect(mcols(masks)$sample_id,"ZTMA249")]

#update masks mcols with PID
mcols(masks)$PID <- sce$PID[match(mcols(masks)$sample_id,sce$sample_id)]
mcols(images)$PID <- sce$PID[match(mcols(images)$sample_id,sce$sample_id)]
```

## Plot cell features onto image using cytomapper

```{r cytomapper, eval =F}
### TO BE UPDATED! 

#Add sample identifiers to own column for cytomapper
sce$sample_id_short <- as.numeric(str_split(sce$sample_id,"_",simplify = TRUE)[,6])

#Randomly select 10 images and add 10 manually selected ones
set.seed(22)
img_random <- sample(seq_len(length(images)), 10)

img_files <- list.files("/mnt/rcc_volume/TNBC/img/")
img_selected <- c(which(str_detect(img_files ,"ZTMA249_ID_320_CX8Y10")),which(str_detect(img_files ,"ZTMA249_ID_289_CX1Y7")),which(str_detect(img_files ,"ZTMA249_ID_36_AX4Y5")),which(str_detect(img_files ,"ZTMA249_ID_7_AX7Y1")),which(str_detect(img_files ,"ZTMA249_ID_220_BX4Y13")),which(str_detect(img_files ,"ZTMA249_ID_271_CX7Y4")),which(str_detect(img_files ,"ZTMA249_ID_82_AX2Y11")), which(str_detect(img_files ,"ZTMA249_ID_179_BX3Y8")), which(str_detect(img_files ,"ZTMA249_ID_183_BX7Y8")), which(str_detect(img_files ,"ZTMA174_B08.26868_79_AX7Y10")))

img_ids <- c(img_selected,img_random)

#Plot masks of cell phenotypes
plotCells(mask = masks[img_ids[1:9]], 
          object = sce,
          img_id = "sample_id", 
          cell_id = "ObjectNumber", 
          colour_by = "cluster_combined",
          colour = col_clusters,
          outline_by = "cluster_origin")
           
##Select images only from certain PID groups 
PID_group_5_ids <- colData(sce) %>% as.data.frame %>% filter(PID_groups == "5") %>% pull("sample_id") %>% unique()

#images[mcols(images)$sample_id %in% PID_group_5_ids]
masks_PID_group_5 <- masks[mcols(masks)$sample_id %in% PID_group_5_ids]

#Plot masks of cell phenotypes by PID group
plotCells(mask = masks_PID_group_5, 
          object = sce,
          img_id = "sample_id", 
          cell_id = "ObjectNumber", 
          colour_by = "cluster_combined",
          colour = col_clusters,
          outline_by = "cluster_origin",
          image_title = list(text = mcols(masks_PID_group_5)$PID),
          save_plot = list(filename = "/mnt/rcc_volume/TNBC/data_analysis/01_figures/masks_celltypes_PIDgroup5.png", scale = 2))


check <- colData(sce_tumor)[sce_tumor$sample_id == "ZTMA249.2_ZTMA249_ID_321_CX1Y11_174",] %>% as.data.frame
check <- colData(sce_tumor)[sce_tumor$PID == "B16.56280",] %>% as.data.frame
```


# Spatial analysis

## 1. Neighborhood aggregation

### 1.1 For all clusters (Tumor ecosystem communities)

In the next section, we will define cellular neighborhoods by clustering cells based on their neighboring cells.

```{r neighborhood-1, message=FALSE, warning=FALSE}
library(imcRtools)
library(bluster)

##Load sce and colors
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_249_08.rds")
col_clusters <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/color_phenocombined.rds")

# Build 10-nearest neighbor graph (max distance between neighbors 30 um)
sce <- buildSpatialGraph(sce, img_id = "sample_id", type = "knn", k = 10, 
                             coords = c("Pos_X",  "Pos_Y"), max_dist = 30,
                         BPPARAM = MulticoreParam(progressbar = TRUE))

colPairNames(sce) #now includes knn_interaction_graph

#create new category (metacluster for tumor, cluster for TNE)
sce$metacluster_TME <- ifelse(is.na(sce$metacluster), as.character(sce$cluster_combined), as.character(sce$metacluster))

# Aggregate across neighbors
sce <- aggregateNeighbors(sce, colPairName = "knn_interaction_graph", 
                              aggregate_by = "metadata", count_by = "metacluster_TME")

head(sce$aggregatedNeighbors)

# Perform cluster sweep for kmeans (silhouette width, wcss)
set.seed(22)
clust_list <- lapply(2:20, function(k){
  cur_km <- kmeans(sce$aggregatedNeighbors, centers = k)
  return(list(wss = sum(cur_km$withinss),
           clusters = cur_km$cluster))
})

sil <- vapply(lapply(clust_list, `[[`, 2), 
              function(x) mean(approxSilhouette(sce$aggregatedNeighbors, x)$width), 
              0)

ggplot(data.frame(k = 2:20, sil = sil))+
  geom_point(aes(k, sil, col = sil))+
  geom_line(aes(k, sil,col=sil))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  xlab("k")+
  ylab("Mean silhouette width")+
  scale_color_continuous(type = "viridis")

ggplot(data.frame(k = 2:20,wss = unlist(lapply(clust_list, `[[`, 1))))+
  geom_point(aes(k, wss, col = wss))+
  geom_line(aes(k, wss, col = wss))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("k")+
  ylab("Total WCSS")+
  scale_color_continuous(type = "viridis")

# Select 11 clusters
cur_clusters <- kmeans(sce$aggregatedNeighbors, centers = 11, nstart = 100)$cluster

sce$cellular_neighborhood <- as.factor(cur_clusters)

##Save sce 
#saveRDS(sce, "/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_249_08.rds")
```

We can now visualize a few example images and highlight the type of cells within each neighborhoood.

```{r neighborhood-2, fig.width=15, fig.height=12}
set.seed(22)
cur_sam <- sample(unique(sce$sample_id), 6)

plotSpatial(sce[,sce$sample_id %in% cur_sam], 
            img_id = "sample_id",
            coords = c("Pos_X", "Pos_Y"),
            node_color_by = "cellular_neighborhood",
            draw_edges = TRUE,
            colPairName = "knn_interaction_graph", 
            nodes_first = FALSE,
            directed = FALSE)+
  scale_color_brewer(palette = "Set3")+
  theme_classic()

colPairNames(sce)

plotSpatial(sce[,sce$sample_id %in% cur_sam], 
            img_id = "sample_id",
            coords = c("Pos_X", "Pos_Y"),
            node_color_by = "cluster_combined",
            node_shape_by = "cluster_origin",
            draw_edges = TRUE,
            directed = FALSE,
            colPairName = "knn_interaction_graph", 
            nodes_first = FALSE) +
  scale_color_manual(values = col_clusters$cluster_combined)+
  theme_classic()
```

```{r}
# Visualize cell type proportions of cellular neighborhoods
cn_prop <- table(cellular_neighborhood = sce$cellular_neighborhood,metacluster_TME = sce$metacluster_TME) %>% as.data.frame %>% group_by(cellular_neighborhood) %>% mutate(fra = Freq/sum(Freq))

## 1. Heatmap body
cn_prop_wide <- cn_prop %>% pivot_wider(id_cols = cellular_neighborhood, names_from = metacluster_TME, values_from = fra) %>% column_to_rownames(var = "cellular_neighborhood")

#Option: min_max normalization per neighborhood
cn_prop_wide <- as.matrix(cn_prop_wide)
cn_prop_wide_min_max <- (cn_prop_wide - rowMins(cn_prop_wide))/(rowMaxs(cn_prop_wide)-rowMins(cn_prop_wide))

#Heatmap body color
col_main = viridis(100)

## 2. Row annotation - number of cells/PID
cluster_PID <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood,PID) %>% group_by(cellular_neighborhood) %>% table() %>% as.data.frame
n_PID <- cluster_PID %>% filter(Freq>0) %>% group_by(cellular_neighborhood) %>% count(name = "n_PID") %>% column_to_rownames("cellular_neighborhood")
ncells <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood) %>% group_by(cellular_neighborhood) %>% count() 

row_anno <- cbind(n_PID,ncells)

#check and correct order
row_anno <- row_anno[match(rownames(cn_prop_wide),row_anno$cellular_neighborhood),]

## 3. Column annotation 
col_anno <- colData(sce) %>% as.data.frame() %>% select(metacluster_TME,metacluster) %>% unique()
col_anno$metacluster_TME <- as.character(col_anno$metacluster_TME)
col_anno$metacluster <- as.character(col_anno$metacluster)

#check and correct order
col_anno <- col_anno[match(colnames(cn_prop_wide),col_anno$metacluster_TME),]


col_ha <- HeatmapAnnotation(metacluster_TME = col_anno$metacluster_TME,
                            metacluster = col_anno$metacluster,
                  #col = col_clusters, 
                  border = TRUE, 
                  na_col = "black",
                  annotation_name_side = "left")

## 4. Plot heatmap
h <- Heatmap(cn_prop_wide_min_max,
             name = "min_max cluster proportion",
        col = col_main, 
        bottom_annotation = col_ha)+
  rowAnnotation(neighborhood = anno_simple(unfactor(row_anno$cellular_neighborhood),pch = unfactor(row_anno$cellular_neighborhood), border = TRUE))+
  rowAnnotation(n_PID = anno_barplot(n_PID, width = unit(10, "mm"),gp = gpar(fill = "#440154FF"), col = 1),annotation_name_rot = 90)+
  rowAnnotation(n_cells = anno_barplot(ncells$n, width = unit(10, "mm"),gp = gpar(fill = "#440154FF"), col = 1),annotation_name_rot = 90)

draw(h)
```

### 1.2 For tumor clusters (Tumor neighborhoods)

In the next section, we will define tumor neighborhoods by clustering tumor cells based on their neighboring tumor cells.

1. Based on clusters

```{r neighborhood-2, message=FALSE, warning=FALSE}
library(imcRtools)
library(bluster)

##Load sce and colors
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_249_08.rds")
col_clusters <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/color_phenocombined.rds")

#subset sce for tumor cells 
# this will also subset the knn interaction graph from all cells
sce <- sce[,sce$analysis_cat == "tumor"]

# # Build 10-nearest neighbor graph (max distance between neighbors 30 um)
sce <- buildSpatialGraph(sce, img_id = "sample_id", type = "knn", k = 20,
                        #threshold = 30, 
                        name = "knn_interaction_graph_tumor",
                        coords = c("Pos_X",  "Pos_Y"))


# Aggregate across neighbors
sce <- aggregateNeighbors(sce, colPairName = "knn_interaction_graph", 
                              aggregate_by = "metadata", count_by = "metacluster")

# Perform cluster sweep for kmeans (silhouette width, wcss)
set.seed(22)
clust_list <- lapply(2:20, function(k){
  cur_km <- kmeans(sce$aggregatedNeighbors, centers = k)
  return(list(wss = sum(cur_km$withinss),
           clusters = cur_km$cluster))
})

sil <- vapply(lapply(clust_list, `[[`, 2), 
              function(x) mean(approxSilhouette(sce$aggregatedNeighbors, x)$width), 
              0)

ggplot(data.frame(k = 2:20, sil = sil))+
  geom_point(aes(k, sil, col = sil))+
  geom_line(aes(k, sil,col=sil))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  xlab("k")+
  ylab("Mean silhouette width")+
  scale_color_continuous(type = "viridis")

ggplot(data.frame(k = 2:20,wss = unlist(lapply(clust_list, `[[`, 1))))+
  geom_point(aes(k, wss, col = wss))+
  geom_line(aes(k, wss, col = wss))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("k")+
  ylab("Total WCSS")+
  scale_color_continuous(type = "viridis")

# Select 9 neighborhoods
cur_clusters <- kmeans(sce$aggregatedNeighbors, centers = 9, nstart = 100)$cluster

sce$cellular_neighborhood <- as.factor(cur_clusters)

```


```{r}
# Visualize cell type proportions of cellular neighborhoods
cn_prop <- table(cellular_neighborhood = sce$cellular_neighborhood,metacluster = sce$metacluster) %>% as.data.frame %>% group_by(cellular_neighborhood) %>% mutate(fra = Freq/sum(Freq))

## 1. Heatmap body
cn_prop_wide <- cn_prop %>% pivot_wider(id_cols = cellular_neighborhood, names_from = metacluster, values_from = fra) %>% column_to_rownames(var = "cellular_neighborhood")

#Option: min_max normalization per neighborhood
cn_prop_wide <- as.matrix(cn_prop_wide)
cn_prop_wide_min_max <- (cn_prop_wide - rowMins(cn_prop_wide))/(rowMaxs(cn_prop_wide)-rowMins(cn_prop_wide))

#Heatmap body color
col_main = viridis(100)

## 2. Row annotation - number of cells/PID
cluster_PID <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood,PID) %>% group_by(cellular_neighborhood) %>% table() %>% as.data.frame
n_PID <- cluster_PID %>% filter(Freq>0) %>% group_by(cellular_neighborhood) %>% count(name = "n_PID") %>% column_to_rownames("cellular_neighborhood")
ncells <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood) %>% group_by(cellular_neighborhood) %>% count() 

row_anno <- cbind(n_PID,ncells)

#check and correct order
row_anno <- row_anno[match(rownames(cn_prop_wide),row_anno$cellular_neighborhood),]

## 3. Column annotation 
col_anno <- colData(sce) %>% as.data.frame() %>% select(metacluster) %>% unique()
col_anno$metacluster <- as.character(col_anno$metacluster)

#check and correct order
col_anno <- col_anno[match(colnames(cn_prop_wide),col_anno$metacluster),]

col_anno <- col_anno %>% as.data.frame()

col_ha <- HeatmapAnnotation(metacluster = col_anno$.,
                  col = col_clusters, 
                  border = TRUE, 
                  na_col = "black",
                  annotation_name_side = "left")

## 4. Plot heatmap
h <- Heatmap(cn_prop_wide,
             name = "cluster proportion",
        col = col_main,
        bottom_annotation = col_ha)+
  rowAnnotation(neighborhood = anno_simple(unfactor(row_anno$cellular_neighborhood),pch = unfactor(row_anno$cellular_neighborhood), border = TRUE))+
  rowAnnotation(n_PID = anno_barplot(n_PID, width = unit(10, "mm"),gp = gpar(fill = "#440154FF"), col = 1),annotation_name_rot = 90)+
  rowAnnotation(n_cells = anno_barplot(ncells$n, width = unit(10, "mm"),gp = gpar(fill = "#440154FF"), col = 1),annotation_name_rot = 90)

draw(h)
```
We can now visualize a few example neighborhoods and highlight the type of cells within each neighborhoood.

```{r neighborhood-2}
i=7
cur_sam <- colData(sce) %>% as.data.frame %>% select(sample_id,cellular_neighborhood) %>% filter(cellular_neighborhood == i) %>% count(sample_id,sort = TRUE) %>% slice(1:10) %>% pull(sample_id)

pdf(paste0("/mnt/rcc_volume/TNBC/data_analysis/01_figures/08_combined/TNBC_249_TumorNeighborhood_SubsetKNN_",i,".pdf"),width = 12, height = 8)
plotSpatial(sce[,sce$sample_id %in% cur_sam], 
            img_id = "sample_id",
            coords = c("Pos_X", "Pos_Y"),
            node_color_by = "cellular_neighborhood",
            draw_edges = TRUE,
            colPairName = "knn_interaction_graph", 
            nodes_first = FALSE,
            directed = FALSE)+
  scale_color_brewer(palette = "Set3")+
  theme_classic()

plotSpatial(sce[,sce$sample_id %in% cur_sam], 
            img_id = "sample_id",
            coords = c("Pos_X", "Pos_Y"),
            node_color_by = "metacluster",
            draw_edges = TRUE,
            directed = FALSE,
            colPairName = "knn_interaction_graph", 
            nodes_first = FALSE) +
  scale_color_manual(values = col_clusters$metacluster)+
  theme_classic()

plotSpatial(sce[,sce$sample_id %in% cur_sam], 
            img_id = "sample_id",
            coords = c("Pos_X", "Pos_Y"),
            node_color_by = "cluster_combined",
            draw_edges = TRUE,
            directed = FALSE,
            colPairName = "knn_interaction_graph", 
            nodes_first = FALSE) +
  scale_color_manual(values = col_clusters$cluster_combined)+
  theme_classic()
dev.off()

```

```{r}
nh_meta_cells <- colData(sce) %>% as.data.frame %>% select(cellular_neighborhood,metacluster) %>% group_by(cellular_neighborhood) %>% count(metacluster)

ggplot(nh_meta_cells)+
  geom_tile(color = "black",aes(cellular_neighborhood, n, fill = metacluster), position = "stack")+
  scale_fill_manual(values=col_clusters$metacluster)+
  theme_classic(base_size = 12)+
  ylab("Number of cells per neighborhood")+
  xlab("Tumor neighborhoods")
```

```{r}
PID_neighborhoods <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_neighborhoods <- PID_neighborhoods %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

ggplot(PID_neighborhoods)+
   geom_tile(color = "black",aes(PID, fra, fill = cellular_neighborhood), position = "stack")+
  #scale_fill_manual(values=col_clusters$metaclusters) + 
  theme_classic(base_size = 12)+
  ylab("Fraction of tumor metacluster neighborhood")+
  xlab("PID")+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

ggplot(PID_neighborhoods)+
   geom_tile(color = "black",aes(PID, Freq, fill = cellular_neighborhood), position = "stack")+
  #scale_fill_manual(values=col_clusters$metaclusters) + 
  theme_classic(base_size = 12)+
  ylab("Number of cells per tumor neighborhood")+
  xlab("PID")+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())


p_PID_neighborhoods

SID_neighborhoods <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood,sample_id) %>% group_by(sample_id) %>% table() %>% as.data.frame
SID_neighborhoods <- SID_neighborhoods %>% group_by(sample_id) %>% mutate(fra = Freq/sum(Freq))

SID_neighborhoods_cor <- SID_neighborhoods
SID_neighborhoods_cor$PID <- sce$PID[match(SID_neighborhoods$sample_id,sce$sample_id)]

SID_neighborhoods_cor <- foreach(i = unique(colData(sce)$PID),.combine = "rbind")%do%{
SID <- SID_neighborhoods_cor %>% filter(PID %in% i) %>% select(-Freq,-PID) %>% pivot_wider(id_cols = cellular_neighborhood,names_from = sample_id,values_from = fra) %>% column_to_rownames("cellular_neighborhood")
cor <- cor(SID,method = "spearman")
cor[2]
}

SID_neighborhoods_cor <- as.data.frame(SID_neighborhoods_cor) 
SID_neighborhoods_cor$PID <- unique(colData(sce)$PID) 
SID_neighborhoods_cor$category <- "PID"

SID_metacluster_cor_plot <- ggplot(SID_neighborhoods_cor, aes(x = category, y = V1))+
  geom_boxplot(outlier.colour = NA)+
  geom_jitter(aes(color = PID), size = 3, position=position_jitter(w=0.1,h=0.1))+
  guides(color = "none")+
  #scale_color_manual(values = col_PID)+
  theme_classic(base_size = 12)+
  theme(axis.title.x = element_blank())+
  ylab("Correlation of tumor neighborhood fractions per PID (n=2)")+
  ggtitle(paste("Spearman rho = ",round(median(SID_neighborhoods_cor$V1, na.rm = TRUE), digits = 2)))

SID_metacluster_cor_plot
```


```{r}
PID_groups <- PID_neighborhoods

PID_groups <- PID_groups %>% pivot_wider(id_cols = "PID",names_from = "cellular_neighborhood",values_from = "fra") %>% column_to_rownames("PID")

#double-check that rowsums are 1 
#TO DO: need to calculate new fractions per PID if I remove cluster
rowSums(PID_groups)


### 1. Cluster-testing
library(clValid)
#Internal measures
testCL<- clValid(PID_groups,nClust = 2:20,clMethods = c("hierarchical","agnes","kmeans"),validation="internal",metric="euclidean", method = "ward")
summary(testCL)
plot(testCL, legend = FALSE)

#Stability measures 
testCL_1<- clValid(PID_groups,nClust = 2:20,clMethods = c("hierarchical","agnes","kmeans"),validation="stability",metric="euclidean", method = "ward")
summary(testCL_1)

plot(testCL_1, legend = FALSE)
#Selected method: kmeans, 10

# #kmeans clustering
set.seed(22)
out_k <- kmeans(PID_groups,10,nstart = 10000)
row_anno$PID_groups <- as.factor(out_k$cluster)

#Annotation dataframes
row_anno <- PID_groups %>% rownames_to_column(var = "PID")

col_anno <- PID_metacluster %>% ungroup %>% select(metacluster) %>% distinct()


#Coloring main heatmap and column anno
col_main = viridis(100)

col_cluster_groups <- col_clusters$cluster_100[names(col_clusters$cluster_100) %in% col_anno$cluster_100]

col_clusters$cluster_100

#Print heatmap
h_g_clus <- Heatmap(PID_groups, name = "Cluster fraction", 
        col = col_main,split = row_anno$PID_groups,
        show_column_names = T, show_row_names =  F, 
        row_title_side = c("right"),
        #cluster_rows = avg_col_dend_MCP,
        row_split = row_anno$PID_groups,
        clustering_method_columns = "ward.D2",
        #right_annotation = ha_right,
        row_title_rot = 0)

%v%
  columnAnnotation(cluster_100 = anno_simple(unfactor(col_anno$cluster_100), pch = unfactor(col_anno$cluster_100),border=TRUE, col = col_clusters$cluster_100),annotation_name_side = "left")%v%
  columnAnnotation(metacluster = anno_simple(col_anno$metacluster, pch = col_anno$metacluster,border=TRUE, col = col_clusters$metaclusters),annotation_name_side = "left")

  
h_g_clus <- draw(h_g_clus)
draw(h_g_clus)

```

### 1.3 For TME clusters (TME neighborhoods)
In the next section, we will define tumor neighborhoods by clustering tumor cells based on their neighboring tumor cells.

1. Based on clusters

```{r neighborhood-2, message=FALSE, warning=FALSE}
library(imcRtools)
library(bluster)

##Load sce and colors
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_249_08.rds")
col_clusters <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/color_phenocombined.rds")

#subset sce for tumor cells 
# this will also subset the knn interaction graph from all cells
sce <- sce[,sce$analysis_cat == "non_tumor"]


# # Build 10-nearest neighbor graph (max distance between neighbors 30 um)
# sce <- buildSpatialGraph(sce, img_id = "sample_id", type = "expansion",
#                                  threshold = 30, coords = c("Pos_X",  "Pos_Y"),
#                          BPPARAM = MulticoreParam(workers = detectCores()-2,progressbar = TRUE))


# Aggregate across neighbors
sce <- aggregateNeighbors(sce, colPairName = "knn_interaction_graph", 
                              aggregate_by = "metadata", count_by = "cluster_combined")

sce$aggregatedNeighbors

# Perform cluster sweep for kmeans (silhouette width, wcss)
set.seed(22)
clust_list <- lapply(2:20, function(k){
  cur_km <- kmeans(sce$aggregatedNeighbors, centers = k)
  return(list(wss = sum(cur_km$withinss),
           clusters = cur_km$cluster))
})

sil <- vapply(lapply(clust_list, `[[`, 2), 
              function(x) mean(approxSilhouette(sce$aggregatedNeighbors, x)$width), 
              0)

ggplot(data.frame(k = 2:20, sil = sil))+
  geom_point(aes(k, sil, col = sil))+
  geom_line(aes(k, sil,col=sil))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  xlab("k")+
  ylab("Mean silhouette width")+
  scale_color_continuous(type = "viridis")

ggplot(data.frame(k = 2:20,wss = unlist(lapply(clust_list, `[[`, 1))))+
  geom_point(aes(k, wss, col = wss))+
  geom_line(aes(k, wss, col = wss))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("k")+
  ylab("Total WCSS")+
  scale_color_continuous(type = "viridis")

# Select 11 neighborhoods
cur_clusters <- kmeans(sce$aggregatedNeighbors, centers = 11, nstart = 100)$cluster

sce$cellular_neighborhood <- as.factor(cur_clusters)
```


```{r}

sce$cluster_combined <- factor(sce$cluster_combined)

# Visualize cell type proportions of cellular neighborhoods
cn_prop <- table(cellular_neighborhood = sce$cellular_neighborhood,cluster_combined = sce$cluster_combined) %>% as.data.frame %>% group_by(cellular_neighborhood) %>% mutate(fra = Freq/sum(Freq))

## 1. Heatmap body
cn_prop_wide <- cn_prop %>% pivot_wider(id_cols = cellular_neighborhood, names_from = cluster_combined, values_from = fra) %>% column_to_rownames(var = "cellular_neighborhood")

#Option: min_max normalization per neighborhood
cn_prop_wide <- as.matrix(cn_prop_wide)
cn_prop_wide_min_max <- (cn_prop_wide - rowMins(cn_prop_wide))/(rowMaxs(cn_prop_wide)-rowMins(cn_prop_wide))

#Heatmap body color
col_main = viridis(100)

## 2. Row annotation - number of cells/PID
cluster_PID <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood,PID) %>% group_by(cellular_neighborhood) %>% table() %>% as.data.frame
n_PID <- cluster_PID %>% filter(Freq>0) %>% group_by(cellular_neighborhood) %>% count(name = "n_PID") %>% column_to_rownames("cellular_neighborhood")
ncells <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood) %>% group_by(cellular_neighborhood) %>% count() 

row_anno <- cbind(n_PID,ncells)

#check and correct order
row_anno <- row_anno[match(rownames(cn_prop_wide),row_anno$cellular_neighborhood),]

## 3. Column annotation 
col_anno <- colData(sce) %>% as.data.frame() %>% select(cluster_combined) %>% unique()
col_anno$cluster_combined <- as.character(col_anno$cluster_combined)

#check and correct order
col_anno <- col_anno[match(colnames(cn_prop_wide),col_anno$cluster_combined),]

col_anno <- col_anno %>% as.data.frame()

col_ha <- HeatmapAnnotation(cluster_combined = col_anno$.,
                  col = col_clusters, 
                  border = TRUE, 
                  na_col = "black",
                  annotation_name_side = "left")

## 4. Plot heatmap
h <- Heatmap(cn_prop_wide,
             name = "cluster proportion",
        col = col_main,
        bottom_annotation = col_ha)+
  rowAnnotation(neighborhood = anno_simple(unfactor(row_anno$cellular_neighborhood),pch = unfactor(row_anno$cellular_neighborhood), border = TRUE))+
  rowAnnotation(n_PID = anno_barplot(n_PID, width = unit(10, "mm"),gp = gpar(fill = "#440154FF"), col = 1),annotation_name_rot = 90)+
  rowAnnotation(n_cells = anno_barplot(ncells$n, width = unit(10, "mm"),gp = gpar(fill = "#440154FF"), col = 1),annotation_name_rot = 90)

draw(h)
```

We can now visualize a few example neighborhoods and highlight the type of cells within each neighborhoood.

```{r neighborhood-2}
i=7
cur_sam <- colData(sce) %>% as.data.frame %>% select(sample_id,cellular_neighborhood) %>% filter(cellular_neighborhood == i) %>% count(sample_id,sort = TRUE) %>% slice(1:10) %>% pull(sample_id)

pdf(paste0("/mnt/rcc_volume/TNBC/data_analysis/01_figures/08_combined/TNBC_249_TumorNeighborhood_SubsetKNN_",i,".pdf"),width = 12, height = 8)
plotSpatial(sce[,sce$sample_id %in% cur_sam], 
            img_id = "sample_id",
            coords = c("Pos_X", "Pos_Y"),
            node_color_by = "cellular_neighborhood",
            draw_edges = TRUE,
            colPairName = "knn_interaction_graph", 
            nodes_first = FALSE,
            directed = FALSE)+
  scale_color_brewer(palette = "Set3")+
  theme_classic()

plotSpatial(sce[,sce$sample_id %in% cur_sam], 
            img_id = "sample_id",
            coords = c("Pos_X", "Pos_Y"),
            node_color_by = "metacluster",
            draw_edges = TRUE,
            directed = FALSE,
            colPairName = "knn_interaction_graph", 
            nodes_first = FALSE) +
  scale_color_manual(values = col_clusters$metacluster)+
  theme_classic()

plotSpatial(sce[,sce$sample_id %in% cur_sam], 
            img_id = "sample_id",
            coords = c("Pos_X", "Pos_Y"),
            node_color_by = "cluster_combined",
            draw_edges = TRUE,
            directed = FALSE,
            colPairName = "knn_interaction_graph", 
            nodes_first = FALSE) +
  scale_color_manual(values = col_clusters$cluster_combined)+
  theme_classic()
dev.off()

```

```{r}
nh_meta_cells <- colData(sce) %>% as.data.frame %>% select(cellular_neighborhood,cluster_combined) %>% group_by(cellular_neighborhood) %>% count(cluster_combined)

ggplot(nh_meta_cells)+
  geom_tile(color = "black",aes(cellular_neighborhood, n, fill = cluster_combined), position = "stack")+
  scale_fill_manual(values=col_clusters$cluster_combined)+
  theme_classic(base_size = 12)+
  ylab("Number of cells per community")+
  xlab("TME neighborhoods")
```

```{r}
PID_neighborhoods <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_neighborhoods <- PID_neighborhoods %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

ggplot(PID_neighborhoods)+
   geom_tile(color = "black",aes(PID, fra, fill = cellular_neighborhood), position = "stack")+
  #scale_fill_manual(values=col_clusters$metaclusters) + 
  theme_classic(base_size = 12)+
  ylab("Fraction of tumor metacluster neighborhood")+
  xlab("PID")+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

ggplot(PID_neighborhoods)+
   geom_tile(color = "black",aes(PID, Freq, fill = cellular_neighborhood), position = "stack")+
  #scale_fill_manual(values=col_clusters$metaclusters) + 
  theme_classic(base_size = 12)+
  ylab("Number of cells per tumor neighborhood")+
  xlab("PID")+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())


p_PID_neighborhoods

SID_neighborhoods <- colData(sce) %>% as.data.frame() %>% select(cellular_neighborhood,sample_id) %>% group_by(sample_id) %>% table() %>% as.data.frame
SID_neighborhoods <- SID_neighborhoods %>% group_by(sample_id) %>% mutate(fra = Freq/sum(Freq))

SID_neighborhoods_cor <- SID_neighborhoods
SID_neighborhoods_cor$PID <- sce$PID[match(SID_neighborhoods$sample_id,sce$sample_id)]

SID_neighborhoods_cor <- foreach(i = unique(colData(sce)$PID),.combine = "rbind")%do%{
SID <- SID_neighborhoods_cor %>% filter(PID %in% i) %>% select(-Freq,-PID) %>% pivot_wider(id_cols = cellular_neighborhood,names_from = sample_id,values_from = fra) %>% column_to_rownames("cellular_neighborhood")
cor <- cor(SID,method = "spearman")
cor[2]
}

SID_neighborhoods_cor <- as.data.frame(SID_neighborhoods_cor) 
SID_neighborhoods_cor$PID <- unique(colData(sce)$PID) 
SID_neighborhoods_cor$category <- "PID"

SID_metacluster_cor_plot <- ggplot(SID_neighborhoods_cor, aes(x = category, y = V1))+
  geom_boxplot(outlier.colour = NA)+
  geom_jitter(aes(color = PID), size = 3, position=position_jitter(w=0.1,h=0.1))+
  guides(color = "none")+
  #scale_color_manual(values = col_PID)+
  theme_classic(base_size = 12)+
  theme(axis.title.x = element_blank())+
  ylab("Correlation of tumor neighborhood fractions per PID (n=2)")+
  ggtitle(paste("Spearman rho = ",round(median(SID_neighborhoods_cor$V1, na.rm = TRUE), digits = 2)))

SID_metacluster_cor_plot
```






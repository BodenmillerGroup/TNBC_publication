---
title: "06_singlecell_tumor"
author: "Lasse Meyer"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Software requirements

```{r lib, message=FALSE,warning=FALSE}
#Data containers
library(SpatialExperiment)
library(SingleCellExperiment)

#Data processing
library(scuttle)
library(scater)
library(scran)
library(imcRtools)

#Data visualization
library(cytomapper)
library(dittoSeq)
library(pheatmap)
library(cowplot)
library(ComplexHeatmap)
library(circlize)

#Utilities
library(tidyverse)
library(openxlsx)
library(stringr)
library(patchwork)
library(parallel)
library(BiocParallel)
library(BiocNeighbors)
library(BiocSingular)
library(tiff)
library(ggrepel)
library(EBImage)
library(viridis)
library(mclust)
library(Rphenograph)
library(igraph)
library(RColorBrewer)
library(foreach)
library(clValid)
library(bluster)
library(psych)
library(corrplot)
library(psych)

#Batch correction
library(batchelor)
```

# Single-cell analysis - Pipeline 3 - TNBC TME phenotypes

Here, we will perform the third single cell analysis steps, including phenotyping of TME cells.

## Read in data and filter for ZTMA249
First, we will read in the `SingleCellExperiment` object containing the cleaned, spillover- and (batch-corrected) single-cell data. 
**Important:** For now, We will filter the object for ZTMA249 samples, since we are sure that those are TNBC. 

```{r read-data-batch-correction, message=FALSE}
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_Clus_249.rds")
```

## Filter sce for tumor cells
Here, we will filter for TME cells based on the cluster category and GMM approach.

```{r filter sce, message=FALSE}
#based on cluster categories (n=327161)
sce <- sce[,colData(sce)$analysis_cat == "non_tumor"]
sce
```

## Define markers for clustering
```{r tumor_markers, message = FALSE, warning = FALSE}
cluster_channel = c("Vimentin","SMA","Fibronectin","CD68","CD3","CD20","CD11c","CD45","CD20","CD8a","CD4","CD31_vWF","CD15")

other_epi_channel = c("panCK","Ecad","CK5","CK8_18","KRT14","cMYC","HER2","ER","PR","p53","AR","EGFR","p_mTOR","CK7","GATA3")

cell_state_channel = c("pH3","H3K27me3","Bcl2", "c_Cas3_PARP","S6", "CD44","CAIX","Ki67")

#Add to sce
rowData(sce)$cluster_channel <- (rowData(sce)$clean_target %in% cluster_channel)
rowData(sce)$cell_state_channel <- (rowData(sce)$clean_target %in% cell_state_channel)
rowData(sce)$other_epi_channel <- (rowData(sce)$clean_target %in% other_epi_channel)
```

## Perform overclustering and hierarchical clustering
Next, we will run Rphenograph (Jaccard-based weights, Louvain clustering as community detection algorithm) clustering with different resolution parameters (k=30,50,75). 

```{r overcluster, message=FALSE}
#k=30
set.seed(22)
snn.sce <- buildSNNGraph(sce[rowData(sce)$cluster_channel==TRUE,], k=30, 
                         d = NA, 
                         type = "jaccard",
                         assay.type = "exprs",
                         BNPARAM=AnnoyParam(),
                         BPPARAM = MulticoreParam(workers = (detectCores()-2), progressbar = TRUE)
                         )

clusters_3 <- igraph::cluster_louvain(snn.sce)
sce$cluster_30 <- as.factor(clusters_3$membership)
unique(sce$cluster_30)

#Save SCEs after clustering
saveRDS(sce, "/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_249_TME_CC_ClusterChannelClus_k.rds")


#k=50
set.seed(22)
snn.sce <- buildSNNGraph(sce[rowData(sce)$cluster_channel==TRUE,], k=50, 
                         d = NA, 
                         type = "jaccard",
                         assay.type = "exprs",
                         BNPARAM=AnnoyParam(),
                         BPPARAM = MulticoreParam(workers = (detectCores()-2), progressbar = TRUE)
                         )

clusters <- igraph::cluster_louvain(snn.sce)
sce$cluster_50 <- as.factor(clusters$membership)
unique(sce$cluster_50)

#Save SCEs after clustering
saveRDS(sce, "/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_249_TME_CC_ClusterChannelClus_k.rds")

#k=75
set.seed(22)
snn.sce <- buildSNNGraph(sce[rowData(sce)$cluster_channel==TRUE,], k=75, 
                         d = NA, 
                         type = "jaccard",
                         assay.type = "exprs",
                         BNPARAM=AnnoyParam(),
                         BPPARAM = MulticoreParam(workers = (detectCores()-2), progressbar = TRUE)
                         )

clusters_1 <- igraph::cluster_louvain(snn.sce)
sce$cluster_75 <- as.factor(clusters_1$membership)
unique(sce$cluster_75)

#Save SCEs after clustering
saveRDS(sce, "/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_249_TME_CC_ClusterChannelClus_k.rds")
```

### Cluster stability testing and comparison

```{r clustree, message = FALSE, warning=FALSE}
#Read sce after clustering and GMM
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_249_TME_CC_ClusterChannelClus_k.rds")
sce

#Pairwise rand index 
#Agreement between two clustering approaches - ARI > 0.5 = "good" similarity
pairwiseRand(sce$cluster_30,sce$cluster_50, mode = "index")
pairwiseRand(sce$cluster_50,sce$cluster_75, mode = "index")

#Over different resolution parameters - Silhouette width [-1,1,max], Purity[0,1,max], Root-mean-squared difference [min]
clusters <- colnames(colData(sce))[str_detect(colnames(colData(sce)),"cluster_[:digit:]")]
df <- foreach(i = seq_along(clusters),.combine = rbind) %do% {
num_clus <- length(unique(colData(sce)[,clusters[i]]))
sil <- approxSilhouette(t(assay(sce, "exprs")), clusters=colData(sce)[,clusters[i]])
#purity <- neighborPurity(t(assay(sce, "exprs")), clusters=colData(sce)[,clusters[i]]) #takes very long to compute - do once and then save figure
rmsd <- clusterRMSD(t(assay(sce, "exprs")), clusters=colData(sce)[,clusters[i]])
data.frame(num_clus = num_clus,
           k = as.numeric(str_split(clusters[i],"_",simplify = TRUE)[,2]), 
           sil = mean(sil$width), 
#           purity = mean(purity$purity),
           rmsd = sum(rmsd))
}


p1 <- ggplot(df, aes(x=k, y=num_clus))+ 
  geom_line(lwd = 2,color = "#377EB8")+
  theme_classic()
p2 <- ggplot(df, aes(x=k, y=sil))+ 
  geom_line(lwd = 2,color = "#377EB8")+
  theme_classic()
p3 <- ggplot(df, aes(x=k, y=rmsd))+ 
  geom_line(lwd = 2,color = "#377EB8")+
  theme_classic()

p1+p3+p2 

#Chosen method => k=50

#Cluster colors 
col_clus <- colorRampPalette(brewer.pal(9,"Paired"))(length(unique(sce$cluster_50)))

#By clusters for one method (here k=50)
#1. Silhouette width [-1,1]
#Clusters with large positive silhouette widths are well-separated from other clusters
sil.approx <- approxSilhouette(t(assay(sce, "exprs")), clusters=sce$cluster_50)
sil.data <- as.data.frame(sil.approx)
sil.data$closest <- factor(ifelse(sil.data$width > 0, sce$cluster_50, sil.data$other))
sil.data$cluster <- sce$cluster_50

p4 <- ggplot(sil.data, aes(x=cluster, y=width, colour=closest)) +
    ggbeeswarm::geom_quasirandom(method="smiley")+
  theme_classic()+
  scale_color_manual(values = col_clus)
p4

# #By neighborpurity (takes very long to be computed - optional)
# pure.approx <- neighborPurity(t(assay(sce, "exprs")), clusters=sce$cluster_50)
# pure.data <- as.data.frame(pure.approx)
# pure.data$maximum <- factor(pure.data$maximum)
# pure.data$cluster <- sce$cluster_50
# 
# p5 <- ggplot(pure.data, aes(x=cluster, y=purity, colour=maximum)) +
#     ggbeeswarm::geom_quasirandom(method="smiley")+
#   theme_classic()+
#   scale_color_manual(values = col_clus)
# p5 
```

Observation:  
- Lowest RMSD and number of clusters for k=50 => selected for downstream phenotyping

## Add metadata to SCE object

```{r metadata addition, message=FALSE, warning=TRUE}
sample_meta <- read.csv("/mnt/rcc_volume/TNBC/data_analysis/03_data/ZTMA249_metadata_processed.csv")

#Add lehmann_subtype by sample
colData(sce)$lehmann_subtype <- sample_meta$lehmann_subtype[match(colData(sce)$ID,sample_meta$ID_Number)]

patient_meta <- read.csv("/mnt/rcc_volume/TNBC/data_analysis/03_data/ZTMA249_metadata_processed_byPID.csv")
#Add Grade by PID
colData(sce)$grade <- patient_meta$grade[match(colData(sce)$PID,patient_meta$PID)]

#SaveSCEwithmetadata
#saveRDS(sce,"/Volumes/rcc_volume/TNBC/data_analysis/sce_TNBC_249_TME_CC_ClusterChannelClus_k.rds")
```

## Heatmap with different scales 

```{r heatmap scales, message=FALSE,warning=FALSE}
#Read sce after clustering and GMM
sce <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_249_TME_CC_ClusterChannelClus_k.rds")

#Heatmap body colors
col_exprs <- colorRamp2(c(0,1,2,3,4), c("#440154FF","#3B518BFF","#20938CFF","#6ACD5AFF","#FDE725FF"))
col_min_max <- colorRamp2(c(0,0.2,0.4,0.6,0.8), c("#440154FF", "#33628DFF", "#28AE80FF", "#DBE318FF", "#FDE725FF"))

### 1. Mean exprs counts
#Aggregrate across cells with the mean (median is also possible)
cluster_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50,
                                 statistics = "mean",
                                 use.assay.type = "exprs",
                                 subset.row = rowData(sce)$cluster_channel)

cellstate_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50,
                                 statistics = "mean",
                                 use.assay.type = "exprs",
                                 subset.row = rowData(sce)$cell_state_channel)

other_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50,
                                 statistics = "mean",
                                 use.assay.type = "exprs",
                                 subset.row = rowData(sce)$other_epi_channel)

h_exprs <- Heatmap(t(assay(cluster_mean_sce, "exprs")),
        column_title = "1. mean exprs",
        col = col_exprs,
        name= "mean exprs",
        km = 1,
        show_row_names = T, 
        show_column_names =  T, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")+
Heatmap(t(assay(cellstate_mean_sce, "exprs")),
        col = col_exprs,
        name= "mean exprs",
        km = 1,
        show_row_names = T,
        show_column_names =  T,
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")+
  Heatmap(t(assay(other_mean_sce, "exprs")),
        col = col_exprs,
        name= "mean exprs",
        km = 1,
        show_row_names = T, 
        show_column_names =  T, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")

### 2. Mean min_max counts
#Aggregrate across cells with the mean (median is also possible)
cluster_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50,
                                 statistics = "mean",
                                 use.assay.type = "min_max",
                                 subset.row = rowData(sce)$cluster_channel)

cellstate_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50,
                                 statistics = "mean",
                                 use.assay.type = "min_max",
                                 subset.row = rowData(sce)$cell_state_channel)

other_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50,
                                 statistics = "mean",
                                 use.assay.type = "min_max",
                                 subset.row = rowData(sce)$other_epi_channel)

h_min_max <- Heatmap(t(assay(cluster_mean_sce, "min_max")),
        column_title = "2. mean min_max",
        col = col_min_max,
        name= "min_max",
        km = 1,
        show_row_names = T, 
        show_column_names =  T, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2",
        row_km = 10, row_km_repeats = 10000)+
Heatmap(t(assay(cellstate_mean_sce, "min_max")),
        col = col_min_max,
        name= "min_max",
        km = 1,
        show_row_names = T,
        show_column_names =  T,
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")+
Heatmap(t(assay(other_mean_sce, "min_max")),
        col = col_min_max,
        name= "min_max",
        km = 1,
        show_row_names = T, 
        show_column_names =  T, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")

### 3. Min_max scaled mean exprs counts
#Aggregrate across cells with the mean (median is also possible)
cluster_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50,
                                 statistics = "mean",
                                 use.assay.type = "exprs",
                                 subset.row = rowData(sce)$cluster_channel)

assay(cluster_mean_sce, "min_max") <- assay(cluster_mean_sce, "exprs") - rowMins(assay(cluster_mean_sce, "exprs"))
assay(cluster_mean_sce, "min_max") <- assay(cluster_mean_sce, "min_max") / (rowMaxs(assay(cluster_mean_sce, "exprs")) - rowMins(assay(cluster_mean_sce, "exprs")))

cellstate_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50,
                                 statistics = "mean",
                                 use.assay.type = "exprs",
                                 subset.row = rowData(sce)$cell_state_channel)
assay(cellstate_mean_sce, "min_max") <- assay(cellstate_mean_sce, "exprs") - rowMins(assay(cellstate_mean_sce, "exprs"))
assay(cellstate_mean_sce, "min_max") <- assay(cellstate_mean_sce, "min_max") / (rowMaxs(assay(cellstate_mean_sce, "exprs")) - rowMins(assay(cellstate_mean_sce, "exprs")))

other_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50,
                                 statistics = "mean",
                                 use.assay.type = "exprs",
                                 subset.row = rowData(sce)$other_epi_channel)
assay(other_mean_sce, "min_max") <- assay(other_mean_sce, "exprs") - rowMins(assay(other_mean_sce, "exprs"))
assay(other_mean_sce, "min_max") <- assay(other_mean_sce, "min_max") / (rowMaxs(assay(other_mean_sce, "exprs")) - rowMins(assay(other_mean_sce, "exprs")))

h_exprs_min_max <- Heatmap(t(assay(cluster_mean_sce, "min_max")),
        column_title = "3. Min_max mean exprs",
        col = col_min_max,
        name= "min_max mean exprs",
        km = 1,
        show_row_names = T, 
        show_column_names =  T, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")+
Heatmap(t(assay(cellstate_mean_sce, "min_max")),
        col = col_min_max,
        name= "min_max mean exprs",
        km = 1,
        show_row_names = T,
        show_column_names =  T,
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")+
  Heatmap(t(assay(other_mean_sce, "min_max")),
        col = col_min_max,
        name= "min_max mean exprs",
        km = 1,
        show_row_names = T, 
        show_column_names =  T, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")

### 4. Z-scored mean exprs counts
#Aggregrate across cells with the mean (median is also possible)
cluster_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50,
                                 statistics = "mean",
                                 use.assay.type = "exprs",
                                 subset.row = rowData(sce)$cluster_channel)

assay(cluster_mean_sce, "z") <- t(scale(t(assay(cluster_mean_sce, "exprs")), center = TRUE,scale=TRUE)) 

#double-check Z scores
#z_t <- as.data.frame(t(assay(cluster_mean_sce, "z")))
#summary(z_t)

cellstate_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50,
                                 statistics = "mean",
                                 use.assay.type = "exprs",
                                 subset.row = rowData(sce)$cell_state_channel)
assay(cellstate_mean_sce, "z") <- t(scale(t(assay(cellstate_mean_sce, "exprs")), center = TRUE,scale=TRUE)) 


other_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50,
                                 statistics = "mean",
                                 use.assay.type = "exprs",
                                 subset.row = rowData(sce)$other_epi_channel)
assay(other_mean_sce, "z") <- t(scale(t(assay(other_mean_sce, "exprs")), center = TRUE,scale=TRUE)) 

h_exprs_z <- Heatmap(t(assay(cluster_mean_sce, "z")),
        column_title = "4. Z-scores mean exprs",
        #col = col_main,
        name= "z mean exprs",
        km = 1,
        show_row_names = T, 
        show_column_names =  T, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")+
Heatmap(t(assay(cellstate_mean_sce, "z")),
        #col = col_main,
        name= "z mean exprs",
        km = 1,
        show_row_names = T,
        show_column_names =  T,
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")+
Heatmap(t(assay(other_mean_sce, "z")),
        #col = col_main,
        name= "z mean exprs",
        km = 1,
        show_row_names = T, 
        show_column_names =  T, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")

h_exprs+
h_min_max

h_exprs_min_max+
h_exprs_z
```

Observation: Mean "raw" or "min_max" exprs counts are most interpretable and logical - use min_max for downstream analysis

## Cluster merging of similar clusters with clear phenotype
Here: 8&15, 10&17, 3&5 (maybe 14&16)

```{r cluster merg}
sce$cluster_50_merg <- ifelse(sce$cluster_50 %in% c("11","15"), "11_15", sce$cluster_50)
sce$cluster_50_merg <- ifelse(sce$cluster_50_merg %in% c("1","4"), "1_4", sce$cluster_50_merg)
sce$cluster_50_merg <- ifelse(sce$cluster_50_merg %in% c("2","9"), "2_9", sce$cluster_50_merg)
sce$cluster_50_merg <- as.factor(sce$cluster_50_merg)

cluster_50_merg_df <- data.frame(cluster_50_merg = unique(sce$cluster_50_merg), cluster_50_merg_names = 1:13) #define new and sorted cluster names
sce$cluster_50_renamed <- cluster_50_merg_df$cluster_50_merg_names[match(sce$cluster_50_merg,cluster_50_merg_df$cluster_50_merg)] 
sce$cluster_50_renamed <- as.factor(sce$cluster_50_renamed)
```

## Rich heatmap of clusters with additional information (other channels, spatial, grade, subtype)

```{r heatmap sce_1, message=FALSE,warning=FALSE}
#Read sce after clustering and GMM
#sce <- readRDS("/Volumes/rcc_volume/TNBC/data_analysis/sce_TNBC_249_TME_CC_ClusterChannelClus_k.rds")

### 1. Marker Heatmaps (Cluster channels, other_immune channels)

#Aggregrate across cells with the mean (median is also possible)
cluster_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50_renamed,
                                 statistics = "mean",
                                 use.assay.type = "min_max",
                                 subset.row = rowData(sce)$cluster_channel)

cellstate_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50_renamed,
                                 statistics = "mean",
                                 use.assay.type = "min_max",
                                 subset.row = rowData(sce)$cell_state_channel)

other_mean_sce <- aggregateAcrossCells(sce, ids = sce$cluster_50_renamed,
                                 statistics = "mean",
                                 use.assay.type = "min_max",
                                 subset.row = rowData(sce)$other_epi_channel)

### 2. Spatial Heatmap
#Add number of neighbors to sce object (saved in ColPair)
n_neighbors <- colPair(sce) %>% as.data.frame() %>% group_by(from) %>% count() %>% arrange(desc(n))

sce$n_neighbors <- n_neighbors$n[match(seq_along(colnames(sce)),n_neighbors$from)]
sce$n_neighbors <- sce$n_neighbors %>% replace_na(0)

#Double-check 
plotSpatial(sce[,colData(sce)$sample_id == "ZTMA249.1_ZTMA249_ID_1_AX1Y1_93"],img_id = "sample_id",colPairName = "neighborhood",draw_edges = FALSE, node_color_by = "n_neighbors",node_size_fix = 2)+
  scale_color_continuous(type = "viridis")+
  theme_classic()
plotSpatial(sce[,colData(sce)$sample_id == "ZTMA249.1_ZTMA249_ID_1_AX1Y1_93"],img_id = "sample_id",colPairName = "neighborhood",draw_edges = TRUE, node_color_by = "GMM_CK")+
  scale_color_brewer(palette = "Set1")+
  theme_classic()

#Select spatial features and average over clusters 
spatial <- colData(sce) %>% as.data.frame %>% select(area,eccentricity,cluster_50_renamed,n_neighbors)
spatial <- spatial %>% select(-cluster_50_renamed) %>% aggregate(by = list(cluster_50_renamed = spatial$cluster_50_renamed), FUN = mean) %>% column_to_rownames("cluster_50_renamed")

#Create Spatial Heatmap Annotation
ha_spatial = HeatmapAnnotation(
    area = spatial$area,
    eccentricity = spatial$eccentricity,
    n_neighbors = spatial$n_neighbors, 
    col = list(area = colorRamp2(c(min(spatial$area),median(spatial$area),sort(spatial$area,decreasing = TRUE)[2]), c(brewer.pal(3,"Blues")[1],brewer.pal(3,"Blues")[2],brewer.pal(3,"Blues")[3])),
               eccentricity = colorRamp2(c(min(spatial$eccentricity ),median(spatial$eccentricity ),max(spatial$eccentricity)), c(brewer.pal(3,"Greens")[1],brewer.pal(3,"Greens")[2],brewer.pal(3,"Greens")[3])),
               n_neighbors = colorRamp2(c(min(spatial$n_neighbors ),median(spatial$n_neighbors ),max(spatial$n_neighbors)),c(brewer.pal(3,"Oranges")[1],brewer.pal(3,"Oranges")[2],brewer.pal(3,"Oranges")[3]))
    ),
    border = TRUE,
    which = "row")


###3.  Define annotation dataframe with n cells, clusters and names for clusters
anno <- colData(cluster_mean_sce) %>% as.data.frame %>% select(cluster_50_renamed, ncells)

#Annotate clusters (after visual inspection)
anno_clus <- as.character(sce$cluster_50_renamed)

anno_clus[anno_clus == "1"] <- "FibroVim_SMA+"
anno_clus[anno_clus == "2"] <- "FibroVim"
anno_clus[anno_clus == "3"] <- "Fibro_low"
anno_clus[anno_clus == "4"] <- "Undefined_T"
anno_clus[anno_clus == "5"] <- "Fibro_CD31_low"
anno_clus[anno_clus == "6"] <- "CD4_Tcells"
anno_clus[anno_clus == "7"] <- "Endo_SMA+"
anno_clus[anno_clus == "8"] <- "Neutro_Granu"
anno_clus[anno_clus == "9"] <- "Bcells"
anno_clus[anno_clus == "10"] <- "Macrophages"
anno_clus[anno_clus == "11"] <- "CD8_Tcells"
anno_clus[anno_clus == "12"] <- "Endo"
anno_clus[anno_clus == "13"] <- "FibroSMA"

anno_clus <- data.frame(anno_clus = anno_clus, origin = as.character(sce$cluster_50_renamed))

anno$names <- anno_clus$anno_clus[match(anno$cluster_50_renamed,anno_clus$origin)]
sce$cluster_names <- anno_clus$anno_clus[match(sce$cluster_50_renamed,anno_clus$origin)]


###4. Patient metadata - grade, number of SID/PID

# Proportion of grade per cluster
grade <- colData(sce) %>% as.data.frame() %>% select(cluster_50_renamed,grade) %>% group_by(cluster_50_renamed) %>% table() %>% as.data.frame
grade <- grade %>% group_by(cluster_50_renamed) %>% mutate(fra = Freq/sum(Freq)) 
grade <- grade %>% select(-Freq) %>% pivot_wider(id_cols = cluster_50_renamed,names_from = grade,values_from = fra) %>% column_to_rownames("cluster_50_renamed")

# Number of contributing patients/samples per cluster
cluster_SID <- colData(sce) %>% as.data.frame() %>% select(cluster_50_renamed,sample_id) %>% group_by(cluster_50_renamed) %>% table() %>% as.data.frame
n_SID <- cluster_SID %>% filter(Freq>0) %>% group_by(cluster_50_renamed) %>% count(name = "n_SID") %>% column_to_rownames("cluster_50_renamed")

cluster_PID <- colData(sce) %>% as.data.frame() %>% select(cluster_50_renamed,PID) %>% group_by(cluster_50_renamed) %>% table() %>% as.data.frame
n_PID <- cluster_PID %>% filter(Freq>0) %>% group_by(cluster_50_renamed) %>% count(name = "n_PID") %>% column_to_rownames("cluster_50_renamed")

# Cluster categories contributing to clusters
cluster_CC <- colData(sce) %>% as.data.frame() %>% select(cluster_50_renamed,cluster_category) %>% group_by(cluster_50_renamed) %>% table() %>% as.data.frame
cluster_CC <- cluster_CC %>% group_by(cluster_50_renamed) %>% mutate(fra = Freq/sum(Freq)) 
cluster_CC <- cluster_CC %>% select(-Freq) %>% pivot_wider(id_cols = cluster_50_renamed,names_from = cluster_category,values_from = fra) %>% column_to_rownames("cluster_50_renamed")

nPID_SID <- cbind(n_SID,n_PID)

###5. General heatmap color schemes 
#Heatmap body color 
col_min_max <- colorRamp2(c(0,0.2,0.4,0.6,0.8), c("#440154FF", "#33628DFF", "#28AE80FF", "#DBE318FF", "#FDE725FF")) #based on viridis(100)

#retrieve row_order for sequential color scheme 
row_order_clusters <- row_order(Heatmap(t(assay(cluster_mean_sce, "min_max")),
        column_title = "cluster_channels",
        col = col_min_max,
        name= "mean min_max exprs",
        km = 1,
        show_row_names = T, 
        show_column_names =  T, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2"))


#Color scheme for clusters
col <- list(cluster_50_renamed = colorRampPalette(brewer.pal(12, "Accent"))(length(unique(anno$cluster_50_renamed))))
col_clusters <- col[[1]]
names(col_clusters) = unique(anno$cluster_50_renamed)[row_order_clusters]
col_clusters <- list(col_clusters)
names(col_clusters) <- "cluster_50_renamed"

###6. Plot combined Heatmap
#6.1 Heatmap not scaled min_max scores
h <-Heatmap(t(assay(cluster_mean_sce, "min_max")),
        column_title = "cluster_channels",
        col = col_min_max,
        name= "mean min_max exprs",
        km = 1,
        show_row_names = T, 
        show_column_names =  T, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")+
  Heatmap(t(assay(cellstate_mean_sce, "min_max")),
        column_title = "cellstate_channels",
        col = col_min_max,
        name= "mean min_max exprs",
        km = 1,
        show_row_names = T,
        show_column_names =  T,
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")+
  Heatmap(t(assay(other_mean_sce, "min_max")),
        column_title = "other_channels",
        col = col_min_max,
        name= "mean min_max exprs",
        km = 1,
        show_row_names = T, 
        show_column_names =  T, 
        clustering_method_rows = "ward.D2",
        clustering_method_columns = "ward.D2")+
  ha_spatial+
  rowAnnotation(cluster_50_renamed = anno_simple(unfactor(anno$cluster_50_renamed), pch = unfactor(anno$cluster_50_renamed),border=TRUE,col=col_clusters$cluster_50_renamed))+
  rowAnnotation(foo = anno_text(anno$names))+
  rowAnnotation(cluster_cat = anno_barplot(cluster_CC, width = unit(10, "mm"),gp = gpar(fill = c("#A6CEE3","#B2DF8A")), col = 1),annotation_name_rot = 90)+
  rowAnnotation(n_cells = anno_barplot(anno$ncells, width = unit(10, "mm"),gp = gpar(fill = "#440154FF"), col = 1),annotation_name_rot = 90)+
  rowAnnotation(n_PID = anno_barplot(n_PID, width = unit(10, "mm"),gp = gpar(fill = "#440154FF"), col = 1),annotation_name_rot = 90)+
  rowAnnotation(grade = anno_barplot(grade, width = unit(10, "mm"),gp = gpar(fill = c("#FFF5F0","#FB6A4A","#67000D")), col = 1),annotation_name_rot = 90)

draw(h)

#6.3 Cluster annotation heatmap
h_cluster_anno <- rowAnnotation(cluster_50_renamed = anno_simple(unfactor((unique(anno$cluster_50_renamed)[row_order_clusters])), pch = as.character(unfactor((unique(anno$cluster_50_renamed)[row_order_clusters]))),border=TRUE,col=col_clusters$cluster_50_renamed))+
  rowAnnotation(foo = anno_text(anno$names[row_order_clusters]))

draw(h_cluster_anno)

#Save sce and color mapping
#saveRDS(sce,"/mnt/rcc_volume/TNBC/data_analysis/sce_TNBC_249_TME_CC_ClusterChannelClus_k.rds")
#saveRDS(col_clusters, "/mnt/rcc_volume/TNBC/data_analysis/color_TMEpheno.rds")
```

## Dimensionality reduction 

```{r dimred, message=FALSE,warning=FALSE}
## Subsample 10% of cells from each core 
#to save time and not get super crowded dimensionality reduction plots
set.seed(22)
sub <- colData(sce) %>% as.data.frame() %>% group_by("sample_id") %>% slice_sample(prop = 0.1) %>% arrange("sample_id") %>% mutate(sub_id = paste(sample_id,ObjectNumber,sep="_")) %>% pull(sub_id)
sce_sub = sce[,sub]

#Run UMAP/TSNE on cluster channels
sce_sub = runUMAP(sce_sub[rowData(sce_sub)$cluster_channel,], n_neighbors = 50, pca = 50, exprs_values = "exprs",external_neighbors=TRUE, BPPARAM = MulticoreParam((detectCores()-2)))
sce_sub = runTSNE(sce_sub[rowData(sce_sub)$cluster_channel,], exprs_values = "exprs", external_neighbors=TRUE, BPPARAM = MulticoreParam((detectCores()-2)))


## 1. Visualize UMAP and TSNE
#panCK and GMM_CK
UMAP_clus <- plotReducedDim(sce_sub, dimred = "UMAP", colour_by = "cluster_50_renamed")+
  scale_color_manual(values = col_clusters$cluster_50_renamed)

TSNE_clus <- plotReducedDim(sce_sub, dimred = "TSNE", colour_by = "cluster_50_renamed")+
  scale_color_manual(values = col_clusters$cluster_50_renamed)

(UMAP_clus+TSNE_clus)

#Visualize all marker expression
all_plots_UMAP <- lapply(c(rownames(sce_sub)[rowData(sce_sub)$cluster_channel]),
                    function(x){
                      p <- plotReducedDim(sce_sub, dimred = "UMAP", 
                                          colour_by = x, 
                                          by_exprs_values = "exprs",
                                          point_size = 0.5)
                      return(p)                    
                    })

library(cowplot)
exp_plots_UMAP <- plot_grid(plotlist = all_plots_UMAP)

all_plots_TSNE <- lapply(c(rownames(sce_sub)[rowData(sce_sub)$cluster_channel]),
                    function(x){
                      p <- plotReducedDim(sce_sub, dimred = "TSNE", 
                                          colour_by = x, 
                                          by_exprs_values = "exprs",
                                          point_size = 0.5)
                      return(p)                    
                    })

library(cowplot)
exp_plots_TSNE <- plot_grid(plotlist = all_plots_TSNE)

#Save subsampled sce
saveRDS(sce_sub,"/mnt/rcc_volume/TNBC/data_analysis/sce_sub_TNBC_249_TME_CC_ClusterChannelClus_k.rds")
```

### Heatmap for subset of cells

```{r heatmap sub}
#Heatmap visualization (all cells)
dittoHeatmap(sce_sub, 
             genes = rownames(sce_sub)[rowData(sce_sub)$cluster_channel],
             assay = "min_max", 
             scale = "none", 
             order.by = "cluster_50_renamed", 
             heatmap.colors = viridis(50), 
             annot.by = c("cluster_50_renamed"),
            annot.colors=col_clusters$cluster_50_renamed[order(as.numeric(names(col_clusters$cluster_50_renamed)))])
```

## Stacked barplots / Correlation of cluster fractions

```{r cluster-pro, message = FALSE, warning = FALSE}
#Fraction of PID/SID per cluster
cluster_SID <- colData(sce) %>% as.data.frame() %>% select(cluster_50_renamed,sample_id) %>% group_by(cluster_50_renamed) %>% table() %>% as.data.frame
cluster_SID <- cluster_SID %>% group_by(cluster_50_renamed) %>% mutate(fra = Freq/sum(Freq))
cluster_PID <- colData(sce) %>% as.data.frame() %>% select(cluster_50_renamed,PID) %>% group_by(cluster_50_renamed) %>% table() %>% as.data.frame
cluster_PID <- cluster_PID %>% group_by(cluster_50_renamed) %>% mutate(fra = Freq/sum(Freq))

colnames(colData(sce))

col_PID = colorRampPalette(brewer.pal(9, "Set1"))(length(unique(cluster_PID$PID))) 
col_SID = colorRampPalette(brewer.pal(9, "Set1"))(length(unique(cluster_SID$sample_id))) 

p_clusterPID <- ggplot(cluster_PID) +
  geom_tile(color = "black",aes(cluster_50_renamed, fra, fill = PID), position = "stack")+
  scale_fill_manual(values=col_PID) + 
  theme_classic(base_size = 15)+
  ylab("PID fraction per cluster")+
  theme(axis.title.x = element_blank())+
  guides(fill = "none")

p_clusterSID <- ggplot(cluster_SID) +
  geom_tile(color = "black",aes(cluster_50_renamed, fra, fill = sample_id), position = "stack")+
  scale_fill_manual(values=col_SID) + 
  theme_classic(base_size = 15)+
  ylab("SID fraction per cluster")+
  theme(axis.title.x = element_blank())+
  guides(fill = "none")

p_clusterPID

#Fraction of cluster per PID/SID
SID_cluster <- colData(sce) %>% as.data.frame() %>% select(cluster_50_renamed,sample_id) %>% group_by(sample_id) %>% table() %>% as.data.frame
SID_cluster <- SID_cluster %>% group_by(sample_id) %>% mutate(fra = Freq/sum(Freq))
PID_cluster <- colData(sce) %>% as.data.frame() %>% select(cluster_50_renamed,PID) %>% group_by(PID) %>% table() %>% as.data.frame
PID_cluster <- PID_cluster %>% group_by(PID) %>% mutate(fra = Freq/sum(Freq))

p_PID_cluster <- ggplot(PID_cluster) +
  geom_tile(color = "black",aes(PID, fra, fill = cluster_50_renamed), position = "stack")+
  scale_fill_manual(values=col_clusters$cluster_50_renamed) + 
  theme_classic(base_size = 12)+
  ylab("Fraction")+
  xlab("PID")+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

p_SID_cluster <- ggplot(SID_cluster) +
  geom_tile(color = "black",aes(sample_id, fra, fill = cluster_50_renamed), position = "stack")+
    scale_fill_manual(values=col_clusters$cluster_50_renamed) + 
  theme_classic(base_size = 15)+
  ylab("Fraction")+
  xlab("Sample_ID")+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

# Cluster fraction correlation for each PID (2 samples per PID)
SID_cluster_cor <- SID_cluster
SID_cluster_cor$PID <- sce$PID[match(SID_cluster$sample_id,sce$sample_id)]

SID_cluster_cor <- foreach(i = unique(colData(sce)$PID),.combine = "rbind")%do%{
SID <- SID_cluster_cor %>% filter(PID %in% i) %>% select(-Freq,-PID) %>% pivot_wider(id_cols = cluster_50_renamed,names_from = sample_id,values_from = fra) %>% column_to_rownames("cluster_50_renamed")
cor <- cor(SID,method = "spearman")
cor[2]
}

SID_cluster_cor <- as.data.frame(SID_cluster_cor) 
SID_cluster_cor$PID <- unique(colData(sce)$PID) 
SID_cluster_cor$category <- "PID"

SID_cluster_cor_plot <- ggplot(SID_cluster_cor, aes(x = category, y = V1))+
  geom_boxplot(outlier.colour = NA)+
  geom_jitter(aes(color = PID), size = 3, position=position_jitter(w=0.1,h=0.1))+
  guides(color = "none")+
  scale_color_manual(values = col_PID)+
  theme_classic(base_size = 12)+
  theme(axis.title.x = element_blank())+
  ylab("Correlation of cluster fractions per PID (n=2)")+
  ggtitle(paste("Spearman rho = ",round(median(SID_cluster_cor$V1, na.rm = TRUE), digits = 2)))
  

p_PID_cluster+SID_cluster_cor_plot
```

## Check correlation of markers

```{r marker correlations}
# Cluster channel marker correlation (all markers - does not show distribution which is usually recommended)
cor_sce <- as.data.frame(t(assay(sce,"exprs")[rowData(sce)$cluster_channel,]))

corrplot(cor(cor_sce,method = "spearman"), method="color", col=brewer.pal(n=8, name="RdBu"),  
         type="upper", order="hclust",hclust.method = "ward.D2", 
         addCoef.col = "black", addCoefasPercent = F,# Add coefficient of correlation
         tl.col="black", tl.srt=40, #Text label color and rotation
         # Combine with significance
         #p.mat = p.mat, sig.level = 0.01, insig = "blank", 
         # hide correlation coefficient on the principal diagonal
         diag=F
)

# For specific markers of interest (also shows the value distribution which is recommended)
pairs.panels(cor_sce[,c("CD3","CD45")],
             method = "spearman",
             hist.col = "royalblue1",
             digits = 2)
```

## Save images / masks for all TME phenotypes

```{r viz TME clus}
## Visualize TME phenotypes on images 

#Load images and masks
images <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/images_segtest.rds")
masks <- readRDS("/mnt/rcc_volume/TNBC/data_analysis/masks_segtest_4.rds")

#subset images and masks for TMA249
images <- images[str_detect(mcols(images)$sample_id,"ZTMA249")]
masks <- masks[str_detect(mcols(masks)$sample_id,"ZTMA249")]

### Visualize all TME phenotypes on images

#1. T/B/Macrophages phenotypes: 11,6,9,10

img_selected <- c(which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_320_CX8Y10")),which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_289_CX1Y7")),which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_36_AX4Y5")),which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_271_CX7Y4")),which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_82_AX2Y11")), which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_179_BX3Y8")), which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_183_BX7Y8")))

#subset sce for critical clusters
sce_sub <- sce[,sce$cluster_50 %in% c("11","15")]
sce_sub

#Prepare images
cur_images <- images[img_selected]
cur_images <- cytomapper::normalize(cur_images, separateImages = TRUE)
cur_images <- cytomapper::normalize(cur_images, inputRange = c(0, 0.2))

plotPixels(cur_images,
           mask = masks[img_selected],
           object = sce_sub,
           img_id = "sample_id",
           cell_id = "ObjectNumber",
           missing_colour = "white",
           colour_by = c("CD3", "CD4","CD8a","CD20","CD68"),
           colour = list("CD3" = c("black", "yellow"),
                         "CD8a" = c("black", "cyan"),
                         "CD20" = c("black", "magenta"),
                         "CD68" = c("black", "green"),
                         "CD4" = c("black","red")
                         ),
           outline_by = "cluster_50",
           thick = TRUE,
           image_title = NULL,
           legend = list(colour_by.title.cex = 0.7,
                         colour_by.labels.cex = 0.7),
           save_plot = list(filename = paste0("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TME_clusters_viz/TME_pixel_clusterbeforemerg_Bcells.png"), scale = 2)
           )

#2. Endothelial cell phenotypes - 7, 12

img_selected <- c(which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_320_CX8Y10")),which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_289_CX1Y7")),which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_36_AX4Y5")),which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_7_CX7Y4")),which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_70_AX2Y11")), which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_179_BX3Y8")), which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_183_BX7Y8")))

#subset sce for critical clusters
sce_sub <- sce[,sce$cluster_50_renamed %in% c("7","12")]
sce_sub

#Prepare images
cur_images <- images[img_selected]
cur_images <- cytomapper::normalize(cur_images, separateImages = TRUE)
cur_images <- cytomapper::normalize(cur_images, inputRange = c(0, 0.2))

plotPixels(cur_images,
           mask = masks[img_selected],
           object = sce_sub,
           img_id = "sample_id",
           cell_id = "ObjectNumber",
           missing_colour = "white",
           colour_by = c("CD31_vWF", "SMA"),
           colour = list("CD31_vWF" = c("black", "red"),
                         "SMA" = c("black", "green")
                         ),
           outline_by = "cluster_names",
           thick = TRUE,
           image_title = NULL,
           legend = list(colour_by.title.cex = 0.7,
                         colour_by.labels.cex = 0.7),
           save_plot = list(filename = paste0("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TME_clusters_viz/TME_pixel_cluster_EndoCells.png"), scale = 2)
           )

#3. Neutrophils/Granulocytes - 

img_selected <- c(which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_294_CX6Y7")),which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_135_BX7Y2")),which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_36_AX4Y5")),which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_303_CX7Y8")),which(str_detect(mcols(images)$sample_id ,"ZTMA249_ID_302_CX6Y8")))

#subset sce for critical clusters
sce_sub <- sce[,sce$cluster_50_renamed %in% c("8")]
sce_sub

#Prepare images
cur_images <- images[img_selected]
cur_images <- cytomapper::normalize(cur_images, separateImages = TRUE)
cur_images <- cytomapper::normalize(cur_images, inputRange = c(0, 0.2))

plotPixels(cur_images,
           mask = masks[img_selected],
           object = sce_sub,
           img_id = "sample_id",
           cell_id = "ObjectNumber",
           missing_colour = "white",
           colour_by = c("panCK", "Ecad","CD15"),
           colour = list("panCK" = c("black", "yellow"),
                         "Ecad" = c("black", "green"),
                         "CD15" = c("black","magenta")
                         ),
           outline_by = "cluster_names",
           thick = TRUE,
           image_title = NULL,
           legend = list(colour_by.title.cex = 0.7,
                         colour_by.labels.cex = 0.7),
           save_plot = list(filename = paste0("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TME_clusters_viz/TME_pixel_cluster_NeutroGranu.png"), scale = 2)
           )

```





## Save plots as pdf

```{r save_plots}
##IMPORTANT: change to chunk output in console for this last part 

##save plots as pdf (vector graphics)
pdf("/Volumes/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_TME_CC_ClusterTesting.pdf",width = 10,height = 5)
p1+p2+p3
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_TME_CC_Silhouette_Cluster50.pdf",width = 12,height = 10)
p4
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_TME_CC_HeatmapCluster.pdf",width = 13,height = 7)
h
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_TME_CC_HeatmapCluster_Scales.pdf",width = 13,height = 8)
h_exprs + h_min_max
dev.off()

pdf("/Volumes/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_TME_CC_ClusterAnno.pdf",width = 5,height = 8)
h_cluster_anno
dev.off()


pdf("/Volumes/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_TME_CC_HeatmapCluster_subcells.pdf",width = 10,height = 8)
dittoHeatmap(sce_sub, 
             genes = rownames(sce_sub)[rowData(sce_sub)$cluster_channel],
             assay = "min_max", 
             scale = "none", 
             order.by = "cluster_50", 
             heatmap.colors = viridis(50), 
             annot.by = c("cluster_50"),
             annot.colors=col_clusters$cluster_50[order(as.numeric(names(col_clusters$cluster_50)))])
dev.off()

pdf("/Volumes/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_TME_CC_ExpressionCor.pdf",width = 10,height = 8)
corrplot(cor(cor_sce,method = "spearman"), method="color", col=brewer.pal(n=8, name="RdBu"),  
         type="upper", order="hclust",hclust.method = "ward.D2", 
         addCoef.col = "black", addCoefasPercent = F,# Add coefficient of correlation
         tl.col="black", tl.srt=40, #Text label color and rotation
         # Combine with significance
         #p.mat = p.mat, sig.level = 0.01, insig = "blank", 
         # hide correlation coefficient on the principal diagonal
         diag=F
)
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_TME_CC_UMAPTSNECluster.pdf",width = 12,height = 6)
UMAP_clus+TSNE_clus
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_TME_CC_TSNEExpression.pdf",width = 12,height = 6)
exp_plots_TSNE
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_TME_CC_UMAPExpression.pdf",width = 12,height = 6)
exp_plots_UMAP
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_TME_CC_ClusterPIDSID.pdf",width = 12,height = 6)
p_clusterPID+p_clusterSID
dev.off()

pdf("/mnt/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_TME_CC_PIDCluster_ClusterCor.pdf",width = 14,height = 6)
p_PID_cluster+SID_cluster_cor_plot
dev.off()

pdf("/Volumes/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_TME_CC_HeatmapPIDgroups.pdf",width = 11,height = 7)
h_g
dev.off()

pdf("/Volumes/rcc_volume/TNBC/data_analysis/01_figures/TNBC_249_TME_CC_HeatmapPIDgroupsCLR.pdf",width = 11,height = 7)
h_g_1
dev.off()

##IMPORTANT: change back to chunk output inline
```


